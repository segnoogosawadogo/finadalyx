<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Findalyx - Analyse FinanciÃ¨re Intelligente</title>
    <meta name="description" content="Findalyx - Plateforme d'analyse financiÃ¨re SYSCOHADA pour les entreprises africaines">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“Š</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Supabase Configuration -->
    <script>
        const SUPABASE_URL = 'https://woxaceylnyudpvxoospj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndveGFjZXlsbnl1ZHB2eG9vc3BqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0OTMwMTksImV4cCI6MjA4NDA2OTAxOX0.c-iKclN-L6hrx_Tj3fkKdZwVmrz4Ob8ejgJYJXNwPe4';
        
        // Plans et tarifs
        const PLANS = {
            basic: {
                name: 'Basic',
                price: { monthly: 0, yearly: 0 },
                features: {
                    maxCompanies: 1,
                    maxYears: 1,
                    exportPDF: false,
                    exportExcel: false,
                    exportPPT: false,
                    support: 'community'
                },
                trialDays: 7
            },
            pro: {
                name: 'Pro',
                price: { monthly: 22000, yearly: 220000 }, // 10 mois (2 mois gratuits)
                features: {
                    maxCompanies: 10,
                    maxYears: 5,
                    exportPDF: true,
                    exportExcel: true,
                    exportPPT: false,
                    support: 'email'
                }
            },
            business: {
                name: 'Business',
                price: { monthly: 34000, yearly: 340000 }, // 10 mois (2 mois gratuits)
                features: {
                    maxCompanies: -1, // illimitÃ©
                    maxYears: -1,
                    exportPDF: true,
                    exportExcel: true,
                    exportPPT: true,
                    support: 'priority'
                }
            }
        };
    </script>
    
    <style>
        :root {
            /* Blues */
            --blue-50: #eff6ff;
            --blue-100: #dbeafe;
            --blue-200: #bfdbfe;
            --blue-400: #60a5fa;
            --blue-500: #3b82f6;
            --blue-600: #2563eb;
            --blue-700: #1d4ed8;
            --blue-800: #1e40af;
            --blue-900: #1e3a8a;
            
            /* Neutrals */
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
            
            /* Semantic */
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            
            /* Layout */
            --sidebar-width: 260px;
            --header-height: 64px;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --shadow-blue: 0 4px 14px 0 rgba(37, 99, 235, 0.25);
            --shadow-card: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
        }

        /* ==================== ANIMATIONS KEYFRAMES ==================== */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 5px rgba(59, 130, 246, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
            }
        }

        @keyframes countUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* Animation utility classes */
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .animate-fade-in-down {
            animation: fadeInDown 0.5s ease-out forwards;
        }

        .animate-fade-in-left {
            animation: fadeInLeft 0.5s ease-out forwards;
        }

        .animate-fade-in-right {
            animation: fadeInRight 0.5s ease-out forwards;
        }

        .animate-scale-in {
            animation: scaleIn 0.3s ease-out forwards;
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        .animate-glow {
            animation: glow 2s ease-in-out infinite;
        }

        .animate-bounce {
            animation: bounce 1s ease-in-out infinite;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Stagger delays for list animations */
        .stagger-1 { animation-delay: 0.05s; }
        .stagger-2 { animation-delay: 0.1s; }
        .stagger-3 { animation-delay: 0.15s; }
        .stagger-4 { animation-delay: 0.2s; }
        .stagger-5 { animation-delay: 0.25s; }
        .stagger-6 { animation-delay: 0.3s; }
        .stagger-7 { animation-delay: 0.35s; }
        .stagger-8 { animation-delay: 0.4s; }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--slate-50) 0%, var(--blue-50) 50%, var(--slate-100) 100%);
            color: var(--slate-800);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            display: block;
            min-height: 100vh;
        }

        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 20% -20%, rgba(59, 130, 246, 0.15), transparent),
                radial-gradient(ellipse 60% 40% at 80% 100%, rgba(37, 99, 235, 0.1), transparent);
            pointer-events: none;
            z-index: -1;
        }

        /* ==================== SIDEBAR ==================== */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: white;
            border-right: 1px solid var(--slate-200);
            display: flex;
            flex-direction: column;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--slate-100);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-700) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-blue);
            position: relative;
            overflow: hidden;
        }

        .logo-icon::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .logo-icon svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        .logo-text {
            font-family: 'Outfit', sans-serif;
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--slate-800) 0%, var(--blue-700) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        .sidebar-nav {
            flex: 1;
            padding: 16px 12px;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--slate-400);
            padding: 0 12px;
            margin-bottom: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 11px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 4px;
            color: var(--slate-600);
            font-size: 14px;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%) scaleY(0);
            width: 3px;
            height: 24px;
            background: var(--blue-600);
            border-radius: 0 4px 4px 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-item:hover {
            background: var(--slate-50);
            color: var(--slate-800);
            transform: translateX(4px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--blue-50) 0%, var(--blue-100) 100%);
            color: var(--blue-700);
        }

        .nav-item.active::before {
            transform: translateY(-50%) scaleY(1);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            opacity: 0.7;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .nav-item:hover .nav-icon {
            opacity: 1;
            transform: scale(1.1);
        }

        .nav-item.active .nav-icon {
            opacity: 1;
        }

        .nav-item-admin {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--slate-200);
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.1));
        }

        .nav-item-admin:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.2));
        }

        .nav-item-admin .nav-icon {
            color: #8b5cf6;
        }

        .nav-badge {
            margin-left: auto;
            background: linear-gradient(135deg, var(--blue-500) 0%, var(--blue-600) 100%);
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 20px;
            animation: pulse 2s ease-in-out infinite;
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--slate-100);
            background: var(--slate-50);
            position: relative;
        }

        .user-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 12px;
            border: 1px solid var(--slate-200);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .user-card:hover {
            border-color: var(--blue-200);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .user-card .chevron-icon {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .user-card.menu-open .chevron-icon {
            transform: rotate(180deg);
        }

        /* ==================== SCORING FINANCIER ==================== */
        .scoring-card {
            background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
            border-radius: 16px;
            padding: 24px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .scoring-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
            pointer-events: none;
        }

        .scoring-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .scoring-title {
            font-size: 14px;
            font-weight: 600;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .scoring-badge {
            background: rgba(255,255,255,0.1);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .scoring-gauge {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }

        .gauge-container {
            position: relative;
            width: 160px;
            height: 80px;
        }

        .gauge-bg {
            position: absolute;
            width: 160px;
            height: 80px;
            border-radius: 80px 80px 0 0;
            background: rgba(255,255,255,0.1);
            overflow: hidden;
        }

        .gauge-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 160px;
            height: 80px;
            border-radius: 80px 80px 0 0;
            background: conic-gradient(from 180deg at 50% 100%, 
                #ef4444 0deg, 
                #f97316 36deg, 
                #eab308 72deg, 
                #84cc16 108deg, 
                #22c55e 144deg,
                #22c55e 180deg);
            transform-origin: bottom center;
            clip-path: polygon(0 100%, 100% 100%, 100% 0, 0 0);
            transition: transform 1s ease-out;
        }

        .gauge-needle {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 4px;
            height: 70px;
            background: white;
            border-radius: 4px;
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(-90deg);
            transition: transform 1s ease-out;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        .gauge-center {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .gauge-labels {
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
            margin-top: 8px;
        }

        .gauge-label {
            font-size: 10px;
            color: rgba(255,255,255,0.5);
            font-weight: 600;
        }

        .scoring-value {
            text-align: center;
            margin-top: 16px;
        }

        .score-number {
            font-size: 48px;
            font-weight: 700;
            line-height: 1;
        }

        .score-grade {
            display: inline-block;
            font-size: 24px;
            font-weight: 700;
            padding: 4px 16px;
            border-radius: 8px;
            margin-left: 8px;
        }

        .score-grade.excellent { background: #22c55e; }
        .score-grade.good { background: #84cc16; }
        .score-grade.average { background: #eab308; }
        .score-grade.weak { background: #f97316; }
        .score-grade.critical { background: #ef4444; }

        .score-interpretation {
            font-size: 13px;
            color: rgba(255,255,255,0.7);
            margin-top: 8px;
        }

        .scoring-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .scoring-detail {
            text-align: center;
        }

        .scoring-detail-value {
            font-size: 18px;
            font-weight: 700;
        }

        .scoring-detail-label {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            margin-top: 2px;
        }

        /* ==================== COMMENTAIRES IA ==================== */
        .ai-insights-card {
            background: white;
            border-radius: 16px;
            border: 1px solid var(--slate-200);
            overflow: hidden;
        }

        .ai-insights-header {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }

        .ai-insights-header svg {
            width: 24px;
            height: 24px;
        }

        .ai-insights-header h3 {
            font-size: 15px;
            font-weight: 600;
            margin: 0;
        }

        .ai-insights-header .ai-badge {
            margin-left: auto;
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .ai-insights-body {
            padding: 20px;
        }

        .insight-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--slate-100);
        }

        .insight-item:last-child {
            border-bottom: none;
        }

        .insight-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .insight-icon.positive { background: #d1fae5; color: #059669; }
        .insight-icon.negative { background: #fee2e2; color: #dc2626; }
        .insight-icon.neutral { background: #e0e7ff; color: #4f46e5; }
        .insight-icon.warning { background: #fef3c7; color: #d97706; }

        .insight-icon svg {
            width: 18px;
            height: 18px;
        }

        .insight-content {
            flex: 1;
        }

        .insight-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--slate-800);
            margin-bottom: 4px;
        }

        .insight-text {
            font-size: 12px;
            color: var(--slate-600);
            line-height: 1.5;
        }

        /* ==================== PRÃ‰VISIONS ==================== */
        .forecast-card {
            background: white;
            border-radius: 16px;
            border: 1px solid var(--slate-200);
            overflow: hidden;
        }

        .forecast-header {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }

        .forecast-header svg {
            width: 24px;
            height: 24px;
        }

        .forecast-header h3 {
            font-size: 15px;
            font-weight: 600;
            margin: 0;
        }

        .forecast-body {
            padding: 20px;
        }

        .forecast-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--slate-100);
        }

        .forecast-item:last-child {
            border-bottom: none;
        }

        .forecast-label {
            font-size: 13px;
            color: var(--slate-600);
        }

        .forecast-values {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .forecast-current {
            font-size: 13px;
            color: var(--slate-500);
        }

        .forecast-arrow {
            color: var(--slate-400);
        }

        .forecast-predicted {
            font-size: 14px;
            font-weight: 600;
            color: var(--slate-800);
        }

        .forecast-change {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        .forecast-change.up { background: #d1fae5; color: #059669; }
        .forecast-change.down { background: #fee2e2; color: #dc2626; }

        /* ==================== OBJECTIFS FINANCIERS ==================== */
        .objectives-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .objective-category {
            background: var(--slate-50);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--slate-200);
        }

        .objective-category-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--slate-800);
            margin: 0 0 12px 0;
        }

        .objective-icon {
            font-size: 16px;
        }

        .objective-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .objective-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .objective-item label {
            font-size: 13px;
            color: var(--slate-600);
            flex: 1;
        }

        .objective-input-group {
            display: flex;
            align-items: center;
            gap: 4px;
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: 8px;
            padding: 4px 8px;
        }

        .objective-input-group:focus-within {
            border-color: var(--blue-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .objective-operator {
            font-size: 12px;
            color: var(--slate-400);
            font-weight: 600;
        }

        .objective-input-group input {
            width: 50px;
            border: none;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--slate-800);
            background: transparent;
            padding: 4px 0;
        }

        .objective-input-group input:focus {
            outline: none;
        }

        .objective-unit {
            font-size: 12px;
            color: var(--slate-400);
            font-weight: 500;
        }

        .objectives-footer {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--slate-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

        .objectives-note {
            font-size: 12px;
            color: var(--slate-500);
            margin: 0;
            flex: 1;
        }

        /* Ratio status colors */
        .ratio-status.achieved, .ratio-detail-status.achieved {
            background: #d1fae5;
            color: #059669;
        }

        .ratio-status.not-achieved, .ratio-detail-status.not-achieved {
            background: #fee2e2;
            color: #dc2626;
        }

        /* Alert badge for critical ratios */
        .alert-badge {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            cursor: pointer;
        }

        .alert-badge-button {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
            transition: all 0.3s ease;
        }

        .alert-badge-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 24px rgba(239, 68, 68, 0.5);
        }

        .alert-badge-dot {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: pulse-dot 1.5s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        .alert-badge.hidden {
            display: none;
        }

        /* Alert popup */
        .alert-popup {
            position: fixed;
            bottom: 80px;
            right: 24px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--slate-200);
            width: 340px;
            max-height: 400px;
            overflow: hidden;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        .alert-popup.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .alert-popup-header {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            padding: 16px;
            border-bottom: 1px solid #fecaca;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .alert-popup-header h4 {
            font-size: 14px;
            font-weight: 600;
            color: #991b1b;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-popup-close {
            background: none;
            border: none;
            color: #991b1b;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .alert-popup-close:hover {
            background: rgba(153, 27, 27, 0.1);
        }

        .alert-popup-body {
            padding: 16px;
            max-height: 280px;
            overflow-y: auto;
        }

        .alert-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: var(--slate-50);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .alert-item:last-child {
            margin-bottom: 0;
        }

        .alert-item-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 14px;
        }

        .alert-item-icon.red { background: #fee2e2; }
        .alert-item-icon.orange { background: #ffedd5; }

        .alert-item-content {
            flex: 1;
        }

        .alert-item-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--slate-800);
            margin-bottom: 2px;
        }

        .alert-item-detail {
            font-size: 11px;
            color: var(--slate-500);
        }

        .alert-item-value {
            font-size: 13px;
            font-weight: 700;
            color: #dc2626;
        }

        .alert-popup-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--slate-100);
            background: var(--slate-50);
        }

        .alert-popup-footer button {
            width: 100%;
            padding: 10px;
            background: var(--blue-600);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .alert-popup-footer button:hover {
            background: var(--blue-700);
        }

        /* ==================== EXPORT BUTTONS ==================== */
        .export-dropdown {
            position: relative;
            display: inline-block;
            z-index: 100;
        }

        .export-dropdown.open {
            z-index: 2000;
        }

        .export-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--slate-200);
            min-width: 220px;
            z-index: 2001;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }

        .export-dropdown.open .export-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .export-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .export-menu-item:first-child {
            border-radius: 12px 12px 0 0;
        }

        .export-menu-item:last-child {
            border-radius: 0 0 12px 12px;
        }

        .export-menu-item:hover {
            background: var(--slate-50);
        }

        .export-menu-item svg {
            width: 20px;
            height: 20px;
            color: var(--slate-500);
        }

        .export-menu-item span {
            font-size: 13px;
            font-weight: 500;
            color: var(--slate-700);
        }

        .export-menu-item .export-format {
            margin-left: auto;
            font-size: 11px;
            color: var(--slate-400);
            font-weight: 600;
        }
        .user-dropdown {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 16px;
            right: 16px;
            background: white;
            border-radius: 16px;
            border: 1px solid var(--slate-200);
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 100;
            overflow: hidden;
        }

        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .user-dropdown-header {
            padding: 16px;
            background: linear-gradient(135deg, var(--blue-50) 0%, var(--slate-50) 100%);
            border-bottom: 1px solid var(--slate-100);
        }

        .user-dropdown-header .user-email {
            font-size: 12px;
            color: var(--slate-500);
            margin-top: 2px;
        }

        .user-dropdown-header .user-plan {
            display: inline-block;
            margin-top: 8px;
            padding: 4px 10px;
            background: linear-gradient(135deg, var(--blue-500), var(--blue-600));
            color: white;
            font-size: 11px;
            font-weight: 600;
            border-radius: 20px;
            animation: pulse 2s ease-in-out infinite;
        }

        .user-dropdown-menu {
            padding: 8px;
        }

        .user-dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--slate-700);
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }

        .user-dropdown-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: var(--blue-50);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: -1;
        }

        .user-dropdown-item:hover::before {
            transform: translateX(0);
        }

        .user-dropdown-item:hover {
            transform: translateX(4px);
        }

        .user-dropdown-item svg {
            width: 18px;
            height: 18px;
            color: var(--slate-400);
            transition: all 0.3s ease;
        }

        .user-dropdown-item:hover svg {
            color: var(--blue-500);
            transform: scale(1.15);
        }

        .user-dropdown-divider {
            height: 1px;
            background: var(--slate-100);
            margin: 8px 0;
        }

        .user-dropdown-item.danger {
            color: var(--danger);
        }

        .user-dropdown-item.danger svg {
            color: var(--danger);
        }

        .user-dropdown-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--blue-400) 0%, var(--blue-600) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: white;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--slate-800);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            font-size: 12px;
            color: var(--slate-500);
        }

        /* ==================== MAIN CONTENT ==================== */
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            flex: 1;
            width: calc(100% - var(--sidebar-width));
        }

        /* Top Bar */
        .top-bar {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--slate-200);
            padding: 0 32px;
            height: var(--header-height);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .breadcrumb-item {
            color: var(--slate-400);
        }

        .breadcrumb-separator {
            color: var(--slate-300);
        }

        .breadcrumb-current {
            color: var(--slate-800);
            font-weight: 600;
        }

        .top-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            background: var(--slate-50);
            border: 1px solid var(--slate-200);
            border-radius: 10px;
            width: 280px;
            transition: all 0.2s ease;
        }

        .search-box:focus-within {
            background: white;
            border-color: var(--blue-400);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .search-box svg {
            width: 18px;
            height: 18px;
            color: var(--slate-400);
        }

        .search-box input {
            border: none;
            background: none;
            outline: none;
            font-size: 14px;
            color: var(--slate-800);
            width: 100%;
            font-family: inherit;
        }

        .search-box input::placeholder {
            color: var(--slate-400);
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid var(--slate-200);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .icon-btn:hover {
            border-color: var(--blue-300);
            background: var(--blue-50);
        }

        .icon-btn svg {
            width: 20px;
            height: 20px;
            color: var(--slate-600);
        }

        .icon-btn .badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 18px;
            height: 18px;
            background: var(--danger);
            border-radius: 50%;
            font-size: 10px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        /* Page Content */
        .page-content {
            padding: 32px;
            max-width: 1600px;
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
        }

        .page-title-section h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--slate-900);
            margin-bottom: 6px;
            letter-spacing: -0.5px;
            opacity: 0;
            animation: fadeInLeft 0.6s ease-out 0.1s forwards;
        }

        .page-title-section p {
            color: var(--slate-500);
            font-size: 15px;
            opacity: 0;
            animation: fadeInLeft 0.6s ease-out 0.2s forwards;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            opacity: 0;
            animation: fadeInRight 0.6s ease-out 0.3s forwards;
            position: relative;
            z-index: 100;
        }

        .btn {
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .btn:active::after {
            width: 300px;
            height: 300px;
        }

        .btn svg {
            width: 18px;
            height: 18px;
            transition: transform 0.3s ease;
        }

        .btn:hover svg {
            transform: scale(1.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-700) 100%);
            color: white;
            box-shadow: var(--shadow-blue);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
            background: linear-gradient(135deg, var(--blue-500) 0%, var(--blue-600) 100%);
        }

        .btn-primary:active {
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: white;
            color: var(--slate-700);
            border: 1px solid var(--slate-200);
        }

        .btn-secondary:hover {
            border-color: var(--blue-300);
            background: var(--blue-50);
            color: var(--blue-700);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary:active {
            transform: translateY(0);
        }

        /* ==================== UPLOAD SECTION ==================== */
        .upload-section {
            background: white;
            border: 2px dashed var(--slate-300);
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            margin-bottom: 32px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(59, 130, 246, 0.02) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--blue-400);
            background: linear-gradient(135deg, white 0%, var(--blue-50) 100%);
        }

        .upload-section:hover::before {
            opacity: 1;
        }

        .upload-section.dragover {
            border-color: var(--blue-500);
            background: var(--blue-50);
            transform: scale(1.01);
        }

        .upload-icon-wrapper {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            background: linear-gradient(135deg, var(--blue-100) 0%, var(--blue-200) 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .upload-icon-wrapper::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 24px;
            border: 2px dashed var(--blue-300);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .upload-icon-wrapper svg {
            width: 36px;
            height: 36px;
            color: var(--blue-600);
            animation: float 3s ease-in-out infinite;
        }

        .upload-section:hover .upload-icon-wrapper svg {
            animation: bounce 0.6s ease-in-out infinite;
        }

        .upload-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--slate-800);
        }

        .upload-subtitle {
            color: var(--slate-500);
            font-size: 15px;
            margin-bottom: 24px;
        }

        .upload-subtitle span {
            color: var(--blue-600);
            font-weight: 600;
            cursor: pointer;
        }

        .upload-formats {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .format-badge {
            padding: 6px 14px;
            background: var(--slate-100);
            border-radius: 8px;
            font-size: 13px;
            color: var(--slate-600);
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .format-badge:hover {
            background: var(--blue-100);
            color: var(--blue-700);
        }

        /* ==================== STATS GRID ==================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--slate-200);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            opacity: 0;
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--blue-400), var(--blue-600));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s ease;
        }

        .stat-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.15);
            border-color: var(--blue-200);
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-card:hover::after {
            left: 100%;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover .stat-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .stat-icon.blue {
            background: linear-gradient(135deg, var(--blue-100) 0%, var(--blue-200) 100%);
            color: var(--blue-600);
        }

        .stat-icon.green {
            background: linear-gradient(135deg, var(--success-light) 0%, #a7f3d0 100%);
            color: var(--success);
        }

        .stat-icon.orange {
            background: linear-gradient(135deg, var(--warning-light) 0%, #fde68a 100%);
            color: var(--warning);
        }

        .stat-icon.purple {
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            color: #7c3aed;
        }

        .stat-icon svg {
            width: 24px;
            height: 24px;
            transition: transform 0.3s ease;
        }

        .stat-card:hover .stat-icon svg {
            transform: scale(1.1);
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .stat-trend.up {
            background: var(--success-light);
            color: var(--success);
        }

        .stat-trend.down {
            background: var(--danger-light);
            color: var(--danger);
        }

        .stat-trend svg {
            width: 14px;
            height: 14px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--slate-900);
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--slate-500);
            font-weight: 500;
        }

        /* ==================== CARDS ==================== */
        .card {
            background: white;
            border-radius: 16px;
            border: 1px solid var(--slate-200);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--blue-200);
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--slate-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, var(--slate-50) 0%, white 100%);
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--slate-800);
        }

        .card-subtitle {
            font-size: 13px;
            color: var(--slate-500);
            margin-top: 2px;
        }

        .unit-badge {
            font-size: 12px;
            font-weight: 600;
            color: var(--slate-500);
            background: var(--slate-100);
            padding: 6px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .card:hover .unit-badge {
            background: var(--blue-100);
            color: var(--blue-600);
        }

        .card-body {
            padding: 24px;
        }

        /* Chart tabs */
        .chart-tabs {
            display: flex;
            gap: 6px;
            background: var(--slate-100);
            padding: 4px;
            border-radius: 10px;
        }

        .chart-tab {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--slate-600);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            background: transparent;
            position: relative;
        }

        .chart-tab:hover {
            color: var(--slate-800);
        }

        .chart-tab.active {
            background: white;
            color: var(--blue-600);
            box-shadow: var(--shadow-sm);
            transform: scale(1.02);
        }

        /* ==================== MAIN GRID ==================== */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .main-grid .card {
            opacity: 0;
            animation: fadeInUp 0.6s ease-out forwards;
        }

        .main-grid .card:nth-child(1) { animation-delay: 0.1s; }
        .main-grid .card:nth-child(2) { animation-delay: 0.2s; }

        .chart-container {
            height: 320px;
            position: relative;
        }

        /* Ratios - Grid 1 colonne */
        .ratios-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ratio-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: var(--slate-50);
            border-radius: 10px;
            border: 1px solid var(--slate-100);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            animation: fadeInLeft 0.4s ease-out forwards;
        }

        .ratio-card:nth-child(1) { animation-delay: 0.05s; }
        .ratio-card:nth-child(2) { animation-delay: 0.1s; }
        .ratio-card:nth-child(3) { animation-delay: 0.15s; }
        .ratio-card:nth-child(4) { animation-delay: 0.2s; }
        .ratio-card:nth-child(5) { animation-delay: 0.25s; }
        .ratio-card:nth-child(6) { animation-delay: 0.3s; }

        .ratio-card:hover {
            background: white;
            border-color: var(--blue-200);
            box-shadow: var(--shadow-md);
            transform: translateX(8px);
        }

        .ratio-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
        }

        .ratio-name {
            font-size: 11px;
            color: var(--slate-500);
            font-weight: 500;
            line-height: 1.2;
        }

        .ratio-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--slate-800);
            line-height: 1.3;
        }

        .ratio-status {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 10px;
        }

        .ratio-status svg {
            width: 14px;
            height: 14px;
        }

        .ratio-status.good {
            background: var(--success-light);
            color: var(--success);
        }

        .ratio-status.warning {
            background: var(--warning-light);
            color: var(--warning);
        }

        .ratio-status.bad {
            background: var(--danger-light);
            color: var(--danger);
        }

        /* Export buttons */
        .export-buttons {
            display: flex;
            gap: 8px;
        }

        /* Alert styles */
        .alert {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }

        .alert-danger {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }

        .alert-success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }

        /* ==================== BOTTOM GRID ==================== */
        .bottom-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        .bottom-grid .card {
            opacity: 0;
            animation: fadeInUp 0.6s ease-out forwards;
        }

        .bottom-grid .card:nth-child(1) { animation-delay: 0.2s; }
        .bottom-grid .card:nth-child(2) { animation-delay: 0.3s; }

        /* P&L Table */
        .pnl-table {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .pnl-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            animation: fadeInUp 0.4s ease-out forwards;
        }

        .pnl-row:nth-child(1) { animation-delay: 0.05s; }
        .pnl-row:nth-child(2) { animation-delay: 0.1s; }
        .pnl-row:nth-child(3) { animation-delay: 0.15s; }
        .pnl-row:nth-child(4) { animation-delay: 0.2s; }
        .pnl-row:nth-child(5) { animation-delay: 0.25s; }
        .pnl-row:nth-child(6) { animation-delay: 0.3s; }
        .pnl-row:nth-child(7) { animation-delay: 0.35s; }
        .pnl-row:nth-child(8) { animation-delay: 0.4s; }
        .pnl-row:nth-child(9) { animation-delay: 0.45s; }
        .pnl-row:nth-child(10) { animation-delay: 0.5s; }

        .pnl-row:hover {
            background: var(--slate-50);
            transform: translateX(8px);
        }

        .pnl-row.highlight {
            background: linear-gradient(135deg, var(--blue-50) 0%, rgba(219, 234, 254, 0.7) 100%);
            border: 1px solid var(--blue-100);
        }

        .pnl-row.highlight:hover {
            transform: translateX(8px) scale(1.01);
            box-shadow: var(--shadow-md);
        }

        .pnl-row.total {
            background: linear-gradient(135deg, var(--slate-800) 0%, var(--slate-900) 100%);
            margin-top: 12px;
            border-radius: 12px;
        }

        .pnl-row.total:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.3);
        }

        .pnl-row.total .pnl-label,
        .pnl-row.total .pnl-value {
            color: white;
            font-weight: 700;
        }

        .pnl-label {
            font-size: 14px;
            color: var(--slate-600);
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .pnl-row.highlight .pnl-label {
            color: var(--blue-600);
            font-weight: 600;
        }

        .pnl-value {
            font-size: 15px;
            font-weight: 600;
            color: var(--slate-800);
            text-align: right;
            min-width: 140px;
            font-variant-numeric: tabular-nums;
            transition: all 0.3s ease;
        }

        .pnl-row:hover .pnl-value {
            transform: scale(1.05);
        }

        .pnl-value.negative {
            color: var(--danger);
        }

        .pnl-row.highlight .pnl-value {
            color: var(--blue-600);
            font-weight: 700;
        }

        /* Balance Sheet */
        .balance-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 32px;
        }

        .balance-column h4 {
            font-size: 15px;
            font-weight: 700;
            color: var(--slate-800);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--blue-400);
            position: relative;
        }

        .balance-column h4::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--blue-600);
            animation: expandWidth 0.8s ease-out 0.3s forwards;
        }

        @keyframes expandWidth {
            from { width: 0; }
            to { width: 100%; }
        }

        .balance-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: var(--slate-50);
            border-radius: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            animation: fadeInUp 0.4s ease-out forwards;
        }

        .balance-column:first-child .balance-item:nth-child(1) { animation-delay: 0.1s; }
        .balance-column:first-child .balance-item:nth-child(2) { animation-delay: 0.15s; }
        .balance-column:first-child .balance-item:nth-child(3) { animation-delay: 0.2s; }
        .balance-column:first-child .balance-item:nth-child(4) { animation-delay: 0.25s; }
        .balance-column:first-child .balance-item:nth-child(5) { animation-delay: 0.3s; }

        .balance-column:last-child .balance-item:nth-child(1) { animation-delay: 0.15s; }
        .balance-column:last-child .balance-item:nth-child(2) { animation-delay: 0.2s; }
        .balance-column:last-child .balance-item:nth-child(3) { animation-delay: 0.25s; }
        .balance-column:last-child .balance-item:nth-child(4) { animation-delay: 0.3s; }
        .balance-column:last-child .balance-item:nth-child(5) { animation-delay: 0.35s; }

        .balance-item:hover {
            background: var(--blue-50);
            transform: translateX(8px);
            box-shadow: var(--shadow-sm);
        }

        .balance-item-label {
            font-size: 14px;
            color: var(--slate-600);
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .balance-item:hover .balance-item-label {
            color: var(--blue-600);
        }

        .balance-item-value {
            font-size: 15px;
            font-weight: 700;
            color: var(--slate-800);
            font-variant-numeric: tabular-nums;
            transition: all 0.3s ease;
        }

        .balance-item:hover .balance-item-value {
            transform: scale(1.05);
        }

        .balance-total {
            margin-top: 24px;
            padding: 18px 24px;
            background: linear-gradient(135deg, var(--blue-500) 0%, var(--blue-600) 100%);
            border-radius: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-blue);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            animation: fadeInUp 0.5s ease-out 0.4s forwards;
        }

        .balance-total:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 15px 35px -10px rgba(59, 130, 246, 0.5);
        }

        .balance-total-label {
            font-size: 15px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .balance-total-value {
            font-size: 20px;
            font-weight: 700;
            color: white;
            font-variant-numeric: tabular-nums;
        }

        /* ==================== DASHBOARD HIDDEN BY DEFAULT ==================== */
        #dashboardContent {
            display: none;
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 1400px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 1100px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .main-grid {
                grid-template-columns: 1fr;
            }
            .bottom-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loader animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Pulse animation for loading */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Data Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--slate-100);
        }

        .data-table th {
            font-size: 12px;
            font-weight: 600;
            color: var(--slate-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--slate-50);
        }

        /* Blue header for P&L and other tables */
        .data-table.blue-header th {
            background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-700) 100%);
            color: white;
        }
        }

        .data-table td {
            font-size: 14px;
            color: var(--slate-700);
        }

        .data-table tr:hover td {
            background: var(--slate-50);
        }

        .data-table tr.highlight td {
            background: linear-gradient(135deg, var(--blue-50), rgba(219, 234, 254, 0.5));
            font-weight: 600;
            color: var(--blue-700);
        }

        .data-table tr.total td {
            background: var(--slate-800);
            color: white;
            font-weight: 700;
        }

        .data-table tr.empty-row td {
            height: 32px;
            border-bottom: none;
        }

        /* Bilan Table - 6 colonnes */
        .bilan-table {
            width: 100%;
            border-collapse: collapse;
        }

        .bilan-table th {
            background: var(--blue-700);
            color: white;
            padding: 12px 10px;
            font-weight: 600;
            font-size: 13px;
        }

        .bilan-table th:nth-child(1),
        .bilan-table th:nth-child(4) {
            width: 25%;
            text-align: left;
        }

        .bilan-table th:nth-child(2),
        .bilan-table th:nth-child(3),
        .bilan-table th:nth-child(5),
        .bilan-table th:nth-child(6) {
            width: 12.5%;
            text-align: right;
        }

        .bilan-table td {
            padding: 10px;
            border-bottom: 1px solid var(--slate-100);
            font-size: 13px;
        }

        .bilan-table td:nth-child(2),
        .bilan-table td:nth-child(3),
        .bilan-table td:nth-child(5),
        .bilan-table td:nth-child(6) {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .bilan-table tr.highlight td {
            background: var(--blue-50);
            font-weight: 600;
            color: var(--blue-700);
        }

        .bilan-table tr.total td {
            background: var(--slate-800);
            color: white;
            font-weight: 700;
        }

        .bilan-table td.indent {
            padding-left: 24px;
        }

        .data-table td.indent {
            padding-left: 32px;
        }

        .data-table td.negative {
            color: var(--danger);
        }

        .data-table td.var-positive {
            color: var(--success);
            font-weight: 500;
        }

        .data-table td.var-negative {
            color: var(--danger);
            font-weight: 500;
        }

        /* P&L variation styles */
        .pnl-var {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .pnl-var.positive {
            background: var(--success-light);
            color: var(--success);
        }

        .pnl-var.negative {
            background: var(--danger-light);
            color: var(--danger);
        }

        /* Page sections */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        /* Year Banner */
        .year-banner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, var(--blue-600), var(--blue-700));
            padding: 16px 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            color: white;
            opacity: 0;
            animation: fadeInDown 0.6s ease-out 0.2s forwards;
            position: relative;
            overflow: visible;
            z-index: 1;
        }

        .year-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmerBanner 3s ease-in-out infinite;
        }

        @keyframes shimmerBanner {
            0%, 100% { transform: translateX(-30%) translateY(-30%); }
            50% { transform: translateX(30%) translateY(30%); }
        }

        .year-info {
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .year-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .year-value {
            font-size: 24px;
            font-weight: 700;
            animation: countUp 0.8s ease-out 0.5s backwards;
        }

        .years-loaded {
            display: flex;
            gap: 8px;
            position: relative;
            z-index: 1;
        }

        .year-badge {
            padding: 6px 14px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            animation: scaleIn 0.4s ease-out forwards;
        }

        .year-badge:nth-child(1) { animation-delay: 0.4s; }
        .year-badge:nth-child(2) { animation-delay: 0.5s; }
        .year-badge:nth-child(3) { animation-delay: 0.6s; }
        .year-badge:nth-child(4) { animation-delay: 0.7s; }

        .year-badge:hover {
            background: rgba(255,255,255,0.35);
            transform: scale(1.05);
        }

        .year-badge.active {
            background: white;
            color: var(--blue-700);
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .year-badge .remove-year {
            margin-left: 6px;
            opacity: 0.7;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .year-badge .remove-year:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* Dashboard Grid 3 columns */
        .dashboard-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        .dashboard-grid-3 .card {
            opacity: 0;
            animation: fadeInUp 0.6s ease-out forwards;
        }

        .dashboard-grid-3 .card:nth-child(1) { animation-delay: 0.3s; }
        .dashboard-grid-3 .card:nth-child(2) { animation-delay: 0.4s; }
        .dashboard-grid-3 .card:nth-child(3) { animation-delay: 0.5s; }

        @media (max-width: 1200px) {
            .dashboard-grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid-3 {
                grid-template-columns: 1fr;
            }
        }

        .chart-container-sm {
            height: 220px;
            position: relative;
        }

        /* Bottom grid full width */
        .bottom-grid-full {
            margin-bottom: 24px;
        }

        .bottom-grid-full .card {
            width: 100%;
        }

        .no-data-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 24px;
            color: var(--slate-400);
            text-align: center;
        }

        .no-data-message p {
            max-width: 400px;
            line-height: 1.6;
        }

        #evolutionChartContainer {
            display: none;
        }

        .evolution-legend {
            display: flex;
            gap: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--slate-600);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* ==================== MAPPING CONFIGURATION STYLES ==================== */
        
        /* Tabs pour navigation dans le mapping */
        .mapping-tabs {
            display: flex;
            gap: 4px;
            background: var(--slate-100);
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .mapping-tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 500;
            color: var(--slate-600);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .mapping-tab:hover {
            color: var(--slate-800);
            background: rgba(255,255,255,0.5);
        }

        .mapping-tab.active {
            background: white;
            color: var(--blue-600);
            box-shadow: var(--shadow-sm);
        }

        .mapping-tab svg {
            width: 18px;
            height: 18px;
        }

        .mapping-tab-content {
            display: none;
        }

        .mapping-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Section actions */
        .mapping-actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--slate-200);
        }

        .mapping-search {
            position: relative;
            width: 300px;
        }

        .mapping-search input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border: 1px solid var(--slate-200);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .mapping-search input:focus {
            border-color: var(--blue-400);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .mapping-search svg {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: var(--slate-400);
        }

        .mapping-actions-buttons {
            display: flex;
            gap: 8px;
        }

        /* Grid de mapping amÃ©liorÃ© */
        .mapping-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        @media (max-width: 1100px) {
            .mapping-grid {
                grid-template-columns: 1fr;
            }
        }

        .mapping-category {
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .mapping-category:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--blue-200);
        }

        .mapping-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--slate-50), white);
            border-bottom: 1px solid var(--slate-100);
        }

        .mapping-category-header h4 {
            font-size: 15px;
            font-weight: 600;
            color: var(--slate-800);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mapping-category-header h4 .icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mapping-category-header h4 .icon svg {
            width: 18px;
            height: 18px;
        }

        .mapping-category-header h4 .icon.blue { background: var(--blue-100); color: var(--blue-600); }
        .mapping-category-header h4 .icon.green { background: #d1fae5; color: #059669; }
        .mapping-category-header h4 .icon.orange { background: #fef3c7; color: #d97706; }
        .mapping-category-header h4 .icon.purple { background: #ede9fe; color: #7c3aed; }
        .mapping-category-header h4 .icon.red { background: #fee2e2; color: #dc2626; }
        .mapping-category-header h4 .icon.cyan { background: #cffafe; color: #0891b2; }

        .mapping-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 20px;
        }

        .mapping-badge.blue { background: var(--blue-100); color: var(--blue-700); }
        .mapping-badge.orange { background: #fef3c7; color: #b45309; }
        .mapping-badge.green { background: #d1fae5; color: #047857; }
        .mapping-badge.purple { background: #ede9fe; color: #6d28d9; }
        .mapping-badge.red { background: #fee2e2; color: #dc2626; }
        .mapping-badge.cyan { background: #cffafe; color: #0891b2; }

        .mapping-category-body {
            padding: 16px 20px;
        }

        .mapping-description {
            font-size: 13px;
            color: var(--slate-500);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        /* Prefixes tags amÃ©liorÃ©s */
        .mapping-prefixes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
            min-height: 36px;
        }

        .prefix-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, var(--slate-50), white);
            border: 1px solid var(--slate-200);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            color: var(--slate-700);
            transition: all 0.2s ease;
        }

        .prefix-tag:hover {
            border-color: var(--blue-300);
            background: var(--blue-50);
        }

        .prefix-tag button {
            background: none;
            border: none;
            color: var(--slate-400);
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            line-height: 1;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .prefix-tag button:hover {
            background: var(--danger-light);
            color: var(--danger);
        }

        .prefix-tag.exception {
            background: linear-gradient(135deg, #fef3c7, #fef9c3);
            border-color: #fcd34d;
        }

        .prefix-tag.exception::before {
            content: 'âš¡';
            font-size: 12px;
        }

        /* Add prefix form */
        .mapping-add {
            display: flex;
            gap: 8px;
        }

        .mapping-add input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--slate-200);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'SF Mono', 'Monaco', monospace;
            transition: all 0.2s ease;
        }

        .mapping-add input:focus {
            border-color: var(--blue-400);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .mapping-add input::placeholder {
            font-family: inherit;
            color: var(--slate-400);
        }

        /* Section exceptions */
        .exceptions-section {
            margin-top: 24px;
            padding: 20px;
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
            border: 1px solid #fcd34d;
            border-radius: 12px;
        }

        .exceptions-section h4 {
            font-size: 15px;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .exceptions-section h4 svg {
            width: 20px;
            height: 20px;
        }

        .exceptions-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .exception-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: white;
            border-radius: 10px;
            border: 1px solid #fcd34d;
            transition: all 0.2s ease;
        }

        .exception-item:hover {
            box-shadow: var(--shadow-sm);
        }

        .exception-item .compte {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-weight: 700;
            color: var(--slate-800);
            background: var(--slate-100);
            padding: 4px 10px;
            border-radius: 6px;
        }

        .exception-item .arrow {
            color: var(--slate-400);
        }

        .exception-item .target {
            color: var(--blue-600);
            font-weight: 600;
            flex: 1;
        }

        .exception-item .libelle {
            color: var(--slate-500);
            font-size: 13px;
            flex: 2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .exception-item .remove {
            background: none;
            border: none;
            color: var(--slate-400);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .exception-item .remove:hover {
            background: var(--danger-light);
            color: var(--danger);
        }

        .exception-add {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .exception-add .form-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .exception-add .form-field label {
            font-size: 12px;
            color: #92400e;
            font-weight: 500;
        }

        .exception-add input,
        .exception-add select {
            padding: 10px 14px;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .exception-add input:focus,
        .exception-add select:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }

        /* Section comptes non classÃ©s */
        .unclassified-section {
            margin-top: 24px;
            padding: 20px;
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            border: 1px solid #fca5a5;
            border-radius: 12px;
        }

        .unclassified-section.empty {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-color: #86efac;
        }

        .unclassified-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .unclassified-header h4 {
            font-size: 15px;
            font-weight: 600;
            color: #991b1b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .unclassified-section.empty .unclassified-header h4 {
            color: #166534;
        }

        .unclassified-header h4 svg {
            width: 20px;
            height: 20px;
        }

        .unclassified-count {
            background: #dc2626;
            color: white;
            font-size: 12px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .unclassified-section.empty .unclassified-count {
            background: #16a34a;
        }

        .unclassified-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .unclassified-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: white;
            border-radius: 8px;
            border: 1px solid #fca5a5;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .unclassified-item:hover {
            border-color: var(--blue-400);
            box-shadow: var(--shadow-sm);
        }

        .unclassified-item .numero {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-weight: 700;
            color: var(--slate-700);
            min-width: 60px;
        }

        .unclassified-item .libelle {
            flex: 1;
            color: var(--slate-600);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unclassified-item select {
            padding: 6px 10px;
            border: 1px solid var(--slate-200);
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        /* Import/Export section */
        .import-export-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 768px) {
            .import-export-section {
                grid-template-columns: 1fr;
            }
        }

        .ie-card {
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .ie-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--blue-200);
        }

        .ie-card .icon-wrapper {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .ie-card .icon-wrapper svg {
            width: 32px;
            height: 32px;
        }

        .ie-card .icon-wrapper.import {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #059669;
        }

        .ie-card .icon-wrapper.export {
            background: linear-gradient(135deg, var(--blue-100), #bfdbfe);
            color: var(--blue-600);
        }

        .ie-card h4 {
            font-size: 16px;
            font-weight: 600;
            color: var(--slate-800);
            margin-bottom: 8px;
        }

        .ie-card p {
            font-size: 13px;
            color: var(--slate-500);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .ie-card input[type="file"] {
            display: none;
        }

        /* Mapping table view */
        .mapping-table-container {
            overflow-x: auto;
            border: 1px solid var(--slate-200);
            border-radius: 12px;
        }

        .mapping-table {
            width: 100%;
            border-collapse: collapse;
        }

        .mapping-table th {
            padding: 14px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--slate-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--slate-50);
            border-bottom: 1px solid var(--slate-200);
        }

        .mapping-table td {
            padding: 12px 16px;
            font-size: 14px;
            border-bottom: 1px solid var(--slate-100);
        }

        .mapping-table tr:hover {
            background: var(--slate-50);
        }

        .mapping-table .compte-cell {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-weight: 600;
            color: var(--slate-700);
        }

        .mapping-table .category-badge {
            display: inline-flex;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .mapping-footer {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--slate-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mapping-stats {
            display: flex;
            gap: 24px;
        }

        .mapping-stat {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .mapping-stat .label {
            font-size: 12px;
            color: var(--slate-500);
        }

        .mapping-stat .value {
            font-size: 18px;
            font-weight: 700;
            color: var(--slate-800);
        }

        .mapping-stat .value.success { color: var(--success); }
        .mapping-stat .value.warning { color: var(--warning); }
        .mapping-stat .value.danger { color: var(--danger); }
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .prefix-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: white;
            border: 1px solid var(--slate-200);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            font-family: 'SF Mono', 'Monaco', monospace;
            color: var(--slate-700);
        }

        .prefix-tag button {
            background: none;
            border: none;
            color: var(--slate-400);
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            line-height: 1;
        }

        .prefix-tag button:hover {
            color: var(--red-500);
        }

        .mapping-add {
            display: flex;
            gap: 8px;
        }

        .mapping-add input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--slate-200);
            border-radius: 8px;
            font-size: 13px;
            font-family: 'SF Mono', 'Monaco', monospace;
        }

        .reclassement-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            background: var(--slate-50);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .reclassement-item .compte {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-weight: 600;
            color: var(--slate-700);
        }

        .reclassement-item .arrow {
            color: var(--slate-400);
        }

        .reclassement-item .target {
            color: var(--blue-600);
            font-weight: 500;
        }

        .reclassement-item .remove {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--slate-400);
            cursor: pointer;
        }

        .reclassement-item .remove:hover {
            color: var(--red-500);
        }

        /* Ratios Categories Styles */
        .ratios-category {
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            opacity: 0;
            animation: fadeInUp 0.6s ease-out forwards;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ratios-category:nth-child(1) { animation-delay: 0.1s; }
        .ratios-category:nth-child(2) { animation-delay: 0.2s; }
        .ratios-category:nth-child(3) { animation-delay: 0.3s; }
        .ratios-category:nth-child(4) { animation-delay: 0.4s; }
        .ratios-category:nth-child(5) { animation-delay: 0.5s; }

        .ratios-category:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px);
        }

        .ratios-category-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .ratios-category-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .ratios-category:hover .ratios-category-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .ratios-category-icon svg {
            width: 24px;
            height: 24px;
        }

        .ratios-category-icon.blue {
            background: var(--blue-100);
            color: var(--blue-600);
        }

        .ratios-category-icon.green {
            background: #d1fae5;
            color: #059669;
        }

        .ratios-category-icon.purple {
            background: #ede9fe;
            color: #7c3aed;
        }

        .ratios-category-icon.orange {
            background: #fef3c7;
            color: #d97706;
        }

        .ratios-category-icon.red {
            background: #fee2e2;
            color: #dc2626;
        }

        .ratios-category-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--slate-800);
            margin: 0;
        }

        .ratios-category-header p {
            font-size: 13px;
            color: var(--slate-500);
            margin: 4px 0 0 0;
        }

        .ratios-category-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        @media (max-width: 1200px) {
            .ratios-category-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .ratios-category-grid {
                grid-template-columns: 1fr;
            }
        }

        .ratio-detail-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            animation: scaleIn 0.4s ease-out forwards;
            border: 1px solid var(--slate-100);
            position: relative;
            overflow: hidden;
        }

        .ratio-detail-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--slate-200);
            transition: all 0.4s ease;
        }

        .ratio-detail-card.status-good::before { background: linear-gradient(180deg, #34d399, #10b981); }
        .ratio-detail-card.status-warning::before { background: linear-gradient(180deg, #fbbf24, #f59e0b); }
        .ratio-detail-card.status-bad::before { background: linear-gradient(180deg, #f87171, #ef4444); }

        .ratio-detail-card::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.08) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .ratio-detail-card:nth-child(1) { animation-delay: 0.15s; }
        .ratio-detail-card:nth-child(2) { animation-delay: 0.2s; }
        .ratio-detail-card:nth-child(3) { animation-delay: 0.25s; }
        .ratio-detail-card:nth-child(4) { animation-delay: 0.3s; }

        .ratio-detail-card:hover {
            background: white;
            box-shadow: 0 15px 35px -10px rgba(0, 0, 0, 0.12);
            transform: translateY(-6px) scale(1.02);
            border-color: var(--blue-200);
        }

        .ratio-detail-card:hover::before {
            width: 6px;
        }

        .ratio-detail-card:hover::after {
            opacity: 1;
        }

        .ratio-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            position: relative;
            z-index: 1;
        }

        .ratio-detail-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--slate-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: color 0.3s ease;
        }

        .ratio-detail-card:hover .ratio-detail-name {
            color: var(--blue-600);
        }

        .ratio-detail-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--slate-800);
            transition: all 0.3s ease;
            line-height: 1;
            position: relative;
            z-index: 1;
        }

        .ratio-detail-card:hover .ratio-detail-value {
            transform: scale(1.05);
        }

        .ratio-detail-value.positive { color: var(--success); }
        .ratio-detail-value.negative { color: var(--danger); }
        .ratio-detail-value.neutral { color: var(--slate-800); }

        .ratio-detail-status {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .ratio-detail-status.good {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: var(--success);
        }

        .ratio-detail-status.warning {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: var(--warning);
        }

        .ratio-detail-status.bad {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: var(--danger);
        }

        .ratio-detail-status svg {
            width: 16px;
            height: 16px;
        }

        .ratio-detail-card:hover .ratio-detail-status {
            transform: scale(1.15) rotate(10deg);
        }

        .ratio-detail-bar {
            height: 8px;
            background: var(--slate-100);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }

        .ratio-detail-fill {
            height: 100%;
            border-radius: 4px;
            width: 0;
            animation: fillBar 1s ease-out 0.5s forwards;
            position: relative;
        }

        .ratio-detail-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmerBar 2s ease-in-out infinite;
        }

        @keyframes shimmerBar {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes fillBar {
            from { width: 0; }
        }

        .ratio-detail-fill.blue { background: linear-gradient(90deg, var(--blue-400), var(--blue-600)); }
        .ratio-detail-fill.green { background: linear-gradient(90deg, #34d399, #10b981); }
        .ratio-detail-fill.purple { background: linear-gradient(90deg, #a78bfa, #8b5cf6); }
        .ratio-detail-fill.orange { background: linear-gradient(90deg, #fbbf24, #f59e0b); }
        .ratio-detail-fill.red { background: linear-gradient(90deg, #f87171, #ef4444); }

        .ratio-detail-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--slate-100);
            position: relative;
            z-index: 1;
        }

        .ratio-detail-desc {
            font-size: 12px;
            color: var(--slate-400);
            margin: 0;
            position: relative;
            z-index: 1;
        }

        .ratio-detail-benchmark {
            font-size: 11px;
            color: var(--slate-400);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .ratio-detail-benchmark svg {
            width: 12px;
            height: 12px;
        }

        .ratio-detail-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 20px;
        }

        .ratio-detail-trend.up {
            background: var(--success-light);
            color: var(--success);
        }

        .ratio-detail-trend.down {
            background: var(--danger-light);
            color: var(--danger);
        }

        .ratio-detail-trend svg {
            width: 14px;
            height: 14px;
        }

        /* Card badge */
        .card-badge {
            font-size: 12px;
            font-weight: 600;
            color: var(--slate-500);
            background: var(--slate-100);
            padding: 6px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .card:hover .card-badge {
            background: var(--blue-100);
            color: var(--blue-600);
        }

        /* Ratio cards for ratios page */
        .ratio-card-large {
            background: white;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--slate-200);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .ratio-card-large::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--blue-400), var(--blue-600));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s ease;
        }

        .ratio-card-large:hover::before {
            transform: scaleX(1);
        }

        .ratio-card-large:hover {
            transform: translateY(-6px);
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.15);
            border-color: var(--blue-200);
        }

        .ratio-card-large .ratio-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .ratio-card-large .ratio-name {
            font-size: 14px;
            color: var(--slate-500);
            font-weight: 500;
        }

        .ratio-card-large .ratio-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--slate-800);
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .ratio-card-large:hover .ratio-value {
            transform: scale(1.05);
        }

        .ratio-card-large .ratio-benchmark {
            font-size: 13px;
            color: var(--slate-500);
        }

        .ratio-status {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            animation: scaleIn 0.4s ease-out backwards;
        }

        .ratio-status:hover {
            transform: scale(1.15);
        }

        .ratio-status.good {
            background: var(--success-light);
            color: var(--success);
        }

        .ratio-status.good:hover {
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
        }

        .ratio-status.warning {
            background: var(--warning-light);
            color: var(--warning);
        }

        .ratio-status.warning:hover {
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.4);
        }

        .ratio-status.bad {
            background: var(--danger-light);
            color: var(--danger);
        }

        .ratio-status.bad:hover {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        }

        .ratio-status svg {
            width: 20px;
            height: 20px;
        }

        /* Cash flow sections */
        .cashflow-section {
            margin-bottom: 32px;
            opacity: 0;
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .cashflow-section:nth-child(1) { animation-delay: 0.1s; }
        .cashflow-section:nth-child(2) { animation-delay: 0.2s; }
        .cashflow-section:nth-child(3) { animation-delay: 0.3s; }

        .cashflow-section h4 {
            font-size: 14px;
            font-weight: 700;
            color: var(--slate-800);
            padding-bottom: 12px;
            margin-bottom: 16px;
            border-bottom: 2px solid var(--blue-400);
        }

        .cashflow-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 4px;
            transition: all 0.3s ease;
        }

        .cashflow-row:hover {
            background: var(--slate-50);
            transform: translateX(8px);
        }

        .cashflow-row.highlight {
            background: linear-gradient(135deg, var(--blue-50), rgba(219, 234, 254, 0.7));
        }

        .cashflow-row .label {
            font-size: 14px;
            color: var(--slate-600);
        }

        .cashflow-row.highlight .label {
            font-weight: 600;
            color: var(--blue-700);
        }

        .cashflow-row .value {
            font-size: 15px;
            font-weight: 600;
            color: var(--slate-800);
        }

        .cashflow-row.highlight .value {
            color: var(--blue-700);
        }

        .cashflow-total {
            margin-top: 12px;
            padding: 12px 16px;
            background: var(--blue-100);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cashflow-total .label {
            font-size: 13px;
            font-weight: 600;
            color: var(--blue-800);
        }

        .cashflow-total .value {
            font-size: 15px;
            font-weight: 700;
            color: var(--blue-800);
        }

        /* =====================================================
           MODAL STYLES
           ===================================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 60px -12px rgba(0, 0, 0, 0.35);
            width: 90%;
            max-width: 560px;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.8) translateY(40px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-overlay.show .modal {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--slate-100);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, var(--slate-50) 0%, white 100%);
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 700;
            color: var(--slate-800);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-header h2 svg {
            width: 24px;
            height: 24px;
            color: var(--blue-500);
            animation: fadeInLeft 0.5s ease-out 0.2s both;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: none;
            background: var(--slate-100);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-close:hover {
            background: var(--danger-light);
            transform: rotate(90deg);
        }

        .modal-close:hover svg {
            color: var(--danger);
        }

        .modal-close svg {
            width: 20px;
            height: 20px;
            color: var(--slate-500);
            transition: color 0.3s ease;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(90vh - 140px);
        }

        .modal-body > * {
            animation: fadeInUp 0.4s ease-out both;
        }

        .modal-body > *:nth-child(1) { animation-delay: 0.1s; }
        .modal-body > *:nth-child(2) { animation-delay: 0.15s; }
        .modal-body > *:nth-child(3) { animation-delay: 0.2s; }
        .modal-body > *:nth-child(4) { animation-delay: 0.25s; }
        .modal-body > *:nth-child(5) { animation-delay: 0.3s; }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--slate-100);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: var(--slate-50);
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--slate-700);
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--slate-200);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--blue-400);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group input:disabled {
            background: var(--slate-50);
            color: var(--slate-500);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* Avatar Upload */
        .avatar-upload {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--blue-400), var(--blue-600));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            color: white;
        }

        .avatar-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .avatar-actions .btn {
            font-size: 13px;
            padding: 8px 16px;
        }

        /* Plan Cards */
        .plan-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .plan-card {
            border: 2px solid var(--slate-200);
            border-radius: 16px;
            padding: 24px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .plan-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .plan-card:hover::after {
            left: 100%;
        }

        .plan-card:hover {
            border-color: var(--blue-300);
            transform: translateY(-8px);
            box-shadow: 0 20px 40px -12px rgba(59, 130, 246, 0.25);
        }

        .plan-card.active {
            border-color: var(--blue-500);
            background: linear-gradient(135deg, var(--blue-50) 0%, rgba(219, 234, 254, 0.5) 100%);
            transform: translateY(-4px);
            box-shadow: 0 12px 30px -8px rgba(59, 130, 246, 0.3);
        }

        .plan-card.recommended::before {
            content: 'RecommandÃ©';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--blue-500), var(--blue-600));
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 20px;
            animation: pulse 2s ease-in-out infinite;
        }

        .plan-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--slate-800);
            margin-bottom: 8px;
        }

        .plan-price {
            font-size: 28px;
            font-weight: 800;
            color: var(--blue-600);
            transition: transform 0.3s ease;
        }

        .plan-card:hover .plan-price {
            transform: scale(1.1);
        }

        .plan-price span {
            font-size: 14px;
            font-weight: 500;
            color: var(--slate-500);
        }

        .plan-features {
            margin-top: 16px;
            text-align: left;
            font-size: 13px;
            color: var(--slate-600);
        }

        .plan-features li {
            padding: 6px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s ease;
        }

        .plan-card:hover .plan-features li {
            transform: translateX(4px);
        }

        .plan-features li svg {
            width: 16px;
            height: 16px;
            color: var(--success);
        }

        /* FAQ Items */
        .faq-item {
            border: 1px solid var(--slate-200);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .faq-question {
            padding: 16px;
            font-weight: 600;
            color: var(--slate-700);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
        }

        .faq-question:hover {
            background: var(--slate-50);
        }

        .faq-question svg {
            width: 20px;
            height: 20px;
            color: var(--slate-400);
            transition: transform 0.2s ease;
        }

        .faq-item.open .faq-question svg {
            transform: rotate(180deg);
        }

        .faq-answer {
            padding: 0 16px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .faq-item.open .faq-answer {
            padding: 0 16px 16px;
            max-height: 200px;
        }

        .faq-answer p {
            color: var(--slate-600);
            font-size: 14px;
            line-height: 1.6;
        }

        /* Contact Options */
        .contact-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .contact-card {
            border: 1px solid var(--slate-200);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .contact-card:hover {
            border-color: var(--blue-300);
            background: var(--blue-50);
        }

        .contact-card svg {
            width: 32px;
            height: 32px;
            color: var(--blue-500);
            margin-bottom: 12px;
        }

        .contact-card h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--slate-800);
            margin-bottom: 4px;
        }

        .contact-card p {
            font-size: 12px;
            color: var(--slate-500);
        }

        /* =====================================================
           TOAST NOTIFICATIONS
           ===================================================== */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.2);
            min-width: 320px;
            max-width: 420px;
            transform: translateX(120%);
            opacity: 0;
            animation: toastSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .toast.hiding {
            animation: toastSlideOut 0.4s ease forwards;
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(120%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes toastSlideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(120%);
                opacity: 0;
            }
        }

        .toast-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast-icon svg {
            width: 20px;
            height: 20px;
        }

        .toast.success .toast-icon {
            background: var(--success-light);
            color: var(--success);
        }

        .toast.error .toast-icon {
            background: var(--danger-light);
            color: var(--danger);
        }

        .toast.info .toast-icon {
            background: var(--blue-100);
            color: var(--blue-600);
        }

        .toast.warning .toast-icon {
            background: var(--warning-light);
            color: var(--warning);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--slate-800);
            margin-bottom: 2px;
        }

        .toast-message {
            font-size: 13px;
            color: var(--slate-500);
        }

        .toast-close {
            width: 28px;
            height: 28px;
            border: none;
            background: var(--slate-100);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .toast-close:hover {
            background: var(--slate-200);
        }

        .toast-close svg {
            width: 14px;
            height: 14px;
            color: var(--slate-500);
        }

        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            border-radius: 0 0 12px 12px;
            animation: toastProgress 4s linear forwards;
        }

        .toast.success .toast-progress { background: var(--success); }
        .toast.error .toast-progress { background: var(--danger); }
        .toast.info .toast-progress { background: var(--blue-500); }
        .toast.warning .toast-progress { background: var(--warning); }

        @keyframes toastProgress {
            from { width: 100%; }
            to { width: 0%; }
        }

        /* ==================== AUTH PAGES ==================== */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--blue-50) 0%, var(--slate-100) 100%);
            padding: 20px;
        }

        .auth-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 440px;
            overflow: hidden;
        }

        .auth-header {
            background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-800) 100%);
            padding: 32px;
            text-align: center;
            color: white;
        }

        .auth-logo {
            font-family: 'Outfit', sans-serif;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .auth-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .auth-body {
            padding: 32px;
        }

        .auth-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: var(--slate-100);
            padding: 4px;
            border-radius: 12px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--slate-600);
            cursor: pointer;
            transition: all 0.2s;
        }

        .auth-tab.active {
            background: white;
            color: var(--blue-600);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .auth-form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .auth-form-group label {
            font-size: 13px;
            font-weight: 600;
            color: var(--slate-700);
        }

        .auth-form-group input {
            padding: 14px 16px;
            border: 1.5px solid var(--slate-200);
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .auth-form-group input:focus {
            outline: none;
            border-color: var(--blue-500);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .auth-submit {
            padding: 16px;
            background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-700) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
        }

        .auth-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
        }

        .auth-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 20px 0;
            color: var(--slate-400);
            font-size: 13px;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--slate-200);
        }

        .auth-social {
            display: flex;
            gap: 12px;
        }

        .auth-social-btn {
            flex: 1;
            padding: 12px;
            border: 1.5px solid var(--slate-200);
            border-radius: 12px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--slate-700);
            transition: all 0.2s;
        }

        .auth-social-btn:hover {
            background: var(--slate-50);
            border-color: var(--slate-300);
        }

        .auth-footer {
            text-align: center;
            padding-top: 16px;
            border-top: 1px solid var(--slate-100);
            margin-top: 16px;
        }

        .auth-footer a {
            color: var(--blue-600);
            text-decoration: none;
            font-weight: 600;
        }

        .auth-error {
            background: var(--danger-light);
            color: #991b1b;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            display: none;
        }

        .auth-error.show {
            display: block;
        }

        /* ==================== PLAN BADGE ==================== */
        .plan-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .plan-badge.basic {
            background: var(--slate-100);
            color: var(--slate-600);
        }

        .plan-badge.pro {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .plan-badge.business {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .plan-badge.expired {
            background: var(--danger-light);
            color: var(--danger);
        }

        /* ==================== UPGRADE MODAL ==================== */
        .upgrade-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            padding: 20px;
        }

        .upgrade-modal.open {
            opacity: 1;
            visibility: visible;
        }

        .upgrade-modal-content {
            background: white;
            border-radius: 24px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .upgrade-modal.open .upgrade-modal-content {
            transform: scale(1);
        }

        .upgrade-header {
            padding: 32px;
            text-align: center;
            border-bottom: 1px solid var(--slate-100);
        }

        .upgrade-header h2 {
            font-size: 28px;
            font-weight: 700;
            color: var(--slate-800);
            margin: 0 0 8px 0;
        }

        .upgrade-header p {
            color: var(--slate-500);
            font-size: 15px;
            margin: 0;
        }

        .upgrade-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--slate-100);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--slate-500);
            transition: all 0.2s;
        }

        .upgrade-close:hover {
            background: var(--slate-200);
            color: var(--slate-700);
        }

        .upgrade-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
        }

        .upgrade-toggle span {
            font-size: 14px;
            color: var(--slate-600);
        }

        .upgrade-toggle span.active {
            font-weight: 600;
            color: var(--slate-800);
        }

        .toggle-switch {
            width: 50px;
            height: 28px;
            background: var(--slate-200);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--blue-600);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .toggle-switch.active::after {
            transform: translateX(22px);
        }

        .savings-badge {
            background: var(--success-light);
            color: var(--success);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .upgrade-plans {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 32px;
        }

        @media (max-width: 768px) {
            .upgrade-plans {
                grid-template-columns: 1fr;
            }
        }

        .plan-card {
            border: 2px solid var(--slate-200);
            border-radius: 20px;
            padding: 28px;
            position: relative;
            transition: all 0.3s;
        }

        .plan-card:hover {
            border-color: var(--blue-300);
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.1);
        }

        .plan-card.popular {
            border-color: var(--blue-500);
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.15);
        }

        .plan-card.current {
            border-color: var(--success);
            background: var(--success-light);
        }

        .popular-tag {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-700) 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .plan-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--slate-800);
            margin-bottom: 8px;
        }

        .plan-price {
            margin-bottom: 20px;
        }

        .plan-price .amount {
            font-size: 36px;
            font-weight: 700;
            color: var(--slate-800);
        }

        .plan-price .currency {
            font-size: 16px;
            color: var(--slate-500);
        }

        .plan-price .period {
            font-size: 14px;
            color: var(--slate-400);
        }

        .plan-features {
            list-style: none;
            padding: 0;
            margin: 0 0 24px 0;
        }

        .plan-features li {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            font-size: 14px;
            color: var(--slate-600);
            border-bottom: 1px solid var(--slate-100);
        }

        .plan-features li:last-child {
            border-bottom: none;
        }

        .plan-features li svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .plan-features li svg.check {
            color: var(--success);
        }

        .plan-features li svg.cross {
            color: var(--slate-300);
        }

        .plan-features li.disabled {
            color: var(--slate-400);
        }

        .plan-cta {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .plan-cta.primary {
            background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-700) 100%);
            color: white;
        }

        .plan-cta.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
        }

        .plan-cta.secondary {
            background: var(--slate-100);
            color: var(--slate-700);
        }

        .plan-cta.secondary:hover {
            background: var(--slate-200);
        }

        .plan-cta:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* ==================== TRIAL BANNER ==================== */
        .trial-banner {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .trial-banner.hidden {
            display: none;
        }

        .trial-banner-text {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .trial-banner-text strong {
            font-weight: 600;
        }

        .trial-banner-btn {
            background: white;
            color: var(--warning);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .trial-banner-btn:hover {
            transform: scale(1.05);
        }

        /* ==================== FEATURE LOCKED ==================== */
        .feature-locked {
            position: relative;
        }

        .feature-locked::after {
            content: 'ðŸ”’ Pro';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .feature-locked:hover::after {
            opacity: 1;
        }

        .feature-locked > * {
            opacity: 0.5;
            pointer-events: none;
        }

        /* ==================== LOADING OVERLAY ==================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--slate-200);
            border-top-color: var(--blue-600);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 16px;
            font-size: 16px;
            color: var(--slate-600);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Chargement...</div>
    </div>

    <!-- Auth Container (shown when not logged in) -->
    <div class="auth-container" id="authContainer" style="display: none;">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-logo">ðŸ“Š Findalyx</div>
                <div class="auth-subtitle">Analyse financiÃ¨re intelligente pour l'Afrique</div>
            </div>
            <div class="auth-body">
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuthTab('login')">Connexion</button>
                    <button class="auth-tab" onclick="switchAuthTab('signup')">Inscription</button>
                </div>

                <div class="auth-error" id="authError"></div>

                <!-- Login Form -->
                <form class="auth-form" id="loginForm" onsubmit="handleLogin(event)">
                    <div class="auth-form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" placeholder="votre@email.com" required>
                    </div>
                    <div class="auth-form-group">
                        <label>Mot de passe</label>
                        <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                    </div>
                    <button type="submit" class="auth-submit" id="loginBtn">
                        Se connecter
                    </button>
                    <div style="text-align:center;margin-top:8px;">
                        <a href="#" onclick="handleForgotPassword()" style="color:var(--blue-600);font-size:13px;text-decoration:none;">Mot de passe oubliÃ© ?</a>
                    </div>
                </form>

                <!-- Signup Form -->
                <form class="auth-form" id="signupForm" style="display:none;" onsubmit="handleSignup(event)">
                    <div class="auth-form-group">
                        <label>Nom complet</label>
                        <input type="text" id="signupName" placeholder="PrÃ©nom Nom" required>
                    </div>
                    <div class="auth-form-group">
                        <label>Email</label>
                        <input type="email" id="signupEmail" placeholder="votre@email.com" required>
                    </div>
                    <div class="auth-form-group">
                        <label>Mot de passe</label>
                        <input type="password" id="signupPassword" placeholder="Min. 8 caractÃ¨res" minlength="8" required>
                    </div>
                    <div class="auth-form-group">
                        <label>Nom de l'entreprise</label>
                        <input type="text" id="signupCompany" placeholder="Ma SociÃ©tÃ© SA">
                    </div>
                    <button type="submit" class="auth-submit" id="signupBtn">
                        CrÃ©er mon compte
                    </button>
                    <p style="font-size:12px;color:var(--slate-500);text-align:center;margin-top:12px;">
                        En crÃ©ant un compte, vous acceptez nos <a href="#" style="color:var(--blue-600);">conditions d'utilisation</a>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <!-- Trial Banner -->
    <div class="trial-banner hidden" id="trialBanner">
        <div class="trial-banner-text">
            <span>â°</span>
            <span><strong id="trialDaysLeft">7</strong> jours restants sur votre essai gratuit</span>
        </div>
        <button class="trial-banner-btn" onclick="openUpgradeModal()">Passer Ã  Pro â†’</button>
    </div>

    <!-- Upgrade Modal -->
    <div class="upgrade-modal" id="upgradeModal">
        <div class="upgrade-modal-content" style="position:relative;">
            <button class="upgrade-close" onclick="closeUpgradeModal()">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            <div class="upgrade-header">
                <h2>Choisissez votre plan</h2>
                <p>DÃ©bloquez toutes les fonctionnalitÃ©s de Findalyx</p>
                <div class="upgrade-toggle">
                    <span id="monthlyLabel" class="active">Mensuel</span>
                    <div class="toggle-switch" id="billingToggle" onclick="toggleBilling()"></div>
                    <span id="yearlyLabel">Annuel</span>
                    <span class="savings-badge">2 mois offerts</span>
                </div>
            </div>
            <div class="upgrade-plans" id="upgradePlans">
                <!-- Plans will be generated by JS -->
            </div>
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- App Container (hidden when not logged in) -->
    <div class="app-container" id="appContainer" style="display: none;">
    
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
                <span class="logo-text">Findalyx</span>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-label">Principal</div>
                <div class="nav-item active" data-page="dashboard">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                    </svg>
                    <span>Tableau de bord</span>
                </div>
                <div class="nav-item" data-page="pnl">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span>Compte de rÃ©sultat</span>
                </div>
                <div class="nav-item" data-page="bilan">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/>
                    </svg>
                    <span>Bilan</span>
                </div>
                <div class="nav-item" data-page="cashflow">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Cash Flow</span>
                    <span class="nav-badge">BientÃ´t</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-label">Analyse</div>
                <div class="nav-item" data-page="ratios">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                    <span>Ratios financiers</span>
                </div>
                <div class="nav-item" data-page="evolution">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                    </svg>
                    <span>Ã‰volution</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-label">ParamÃ¨tres</div>
                <div class="nav-item" data-page="import">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                    </svg>
                    <span>Importer donnÃ©es</span>
                </div>
                <div class="nav-item" data-page="settings">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span>Configuration</span>
                </div>
                <!-- Admin link - visible only for admins -->
                <a href="/admin" class="nav-item nav-item-admin" id="adminNavLink" style="display: none; text-decoration: none; color: inherit;">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    <span>Administration</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <!-- User Dropdown Menu -->
            <div class="user-dropdown" id="userDropdown">
                <div class="user-dropdown-header">
                    <div class="user-name">Utilisateur</div>
                    <div class="user-email user-email-display">email@exemple.com</div>
                    <span class="plan-badge basic user-plan-badge">Essai</span>
                </div>
                <div class="user-dropdown-menu">
                    <div class="user-dropdown-item" onclick="showUserProfile()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <span>Mon profil</span>
                    </div>
                    <div class="user-dropdown-item" onclick="toggleUserMenu(); navigateTo('settings')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <span>ParamÃ¨tres</span>
                    </div>
                    <div class="user-dropdown-item" onclick="openUpgradeModal()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                        </svg>
                        <span>Abonnement</span>
                    </div>
                    <div class="user-dropdown-divider"></div>
                    <div class="user-dropdown-item" onclick="showHelp()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Aide & Support</span>
                    </div>
                    <div class="user-dropdown-item" onclick="window.open('https://docs.findalyx.com', '_blank')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                        <span>Documentation</span>
                    </div>
                    <div class="user-dropdown-divider"></div>
                    <div class="user-dropdown-item danger" onclick="handleLogout()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        <span>DÃ©connexion</span>
                    </div>
                </div>
            </div>

            <div class="user-card" id="userCard" onclick="toggleUserMenu()">
                <div class="user-avatar user-avatar-text">U</div>
                <div class="user-info">
                    <div class="user-name">Utilisateur</div>
                    <div class="user-role user-plan-badge plan-badge basic">Essai</div>
                </div>
                <svg class="chevron-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--slate-400);">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Bar -->
        <header class="top-bar">
            <div class="breadcrumb">
                <span class="breadcrumb-item">Findalyx</span>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-current">Tableau de bord</span>
            </div>
            <div class="top-actions">
                <div class="search-box">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <input type="text" placeholder="Rechercher...">
                </div>
                <button class="icon-btn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                    </svg>
                    <span class="badge">3</span>
                </button>
                <button class="icon-btn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Page Content -->
        <div class="page-content">
            <!-- ========== PAGE: Dashboard ========== -->
            <div id="pageDashboard" class="page-section" style="display: block;">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="page-title-section">
                        <h1>Tableau de bord financier</h1>
                        <p>Analyse financiÃ¨re complÃ¨te de votre entreprise</p>
                    </div>
                    <div class="header-actions">
                        <div class="export-dropdown" id="exportDropdown">
                            <button class="btn btn-secondary" onclick="toggleExportMenu()">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                                Exporter
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;margin-left:4px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                            <div class="export-menu">
                                <div class="export-menu-item" onclick="exportToPDF()">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                    </svg>
                                    <span>Rapport PDF</span>
                                    <span class="export-format">.pdf</span>
                                </div>
                                <div class="export-menu-item" onclick="exportToPowerPoint()">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 13v-1m4 1v-3m4 3V8M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                                    </svg>
                                    <span>PrÃ©sentation PowerPoint</span>
                                    <span class="export-format">.pptx</span>
                                </div>
                                <div class="export-menu-item" onclick="exportToExcel()">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    <span>DonnÃ©es Excel</span>
                                    <span class="export-format">.xlsx</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Importer
                        </button>
                    </div>
                </div>

                <!-- Hidden File Input (Global) -->
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" hidden onchange="handleFileUpload(event)">

                <!-- Upload Section -->
                <div class="upload-section" id="uploadSection">
                    <div class="upload-icon-wrapper">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                    </div>
                    <h3 class="upload-title">DÃ©posez votre fichier ici</h3>
                    <p class="upload-subtitle">ou <span onclick="document.getElementById('fileInput').click()">parcourez</span> pour sÃ©lectionner un fichier</p>
                    <div class="upload-formats">
                        <span class="format-badge">Balance comptable</span>
                        <span class="format-badge">Grand livre</span>
                        <span class="format-badge">.xlsx</span>
                        <span class="format-badge">.csv</span>
                    </div>
                </div>

                <!-- Dashboard Content (Hidden by default) -->
                <div id="dashboardContent">
                <!-- Year Badge -->
                <div class="year-banner" id="yearBanner">
                    <div class="year-info">
                        <span class="year-label">Exercice en cours d'analyse</span>
                        <span class="year-value" id="currentYear">2022</span>
                    </div>
                    <div class="years-loaded" id="yearsLoaded">
                        <!-- Years badges will be inserted here -->
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); document.getElementById('fileInput').click();">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Ajouter une annÃ©e
                    </button>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon blue">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                            </div>
                            <div class="stat-trend up" id="trendCA">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                                </svg>
                                <span>--</span>
                            </div>
                        </div>
                        <div class="stat-value" id="statRevenue">0</div>
                        <div class="stat-label">Chiffre d'affaires</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon green">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div class="stat-trend up" id="trendEBITDA">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                                </svg>
                                <span>--</span>
                            </div>
                        </div>
                        <div class="stat-value" id="statEBITDA">0</div>
                        <div class="stat-label">EBITDA</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon purple">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div class="stat-trend up" id="trendNet">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                                </svg>
                                <span>--</span>
                            </div>
                        </div>
                        <div class="stat-value" id="statNetIncome">0</div>
                        <div class="stat-label">RÃ©sultat Net</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon orange">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="stat-value" id="statMargin">0%</div>
                        <div class="stat-label">Marge EBITDA</div>
                    </div>
                </div>

                <!-- Scoring + AI Insights + Forecasts Row -->
                <div class="scoring-insights-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                    
                    <!-- Scoring Financier -->
                    <div class="scoring-card" id="scoringCard">
                        <div class="scoring-header">
                            <span class="scoring-title">Score de SantÃ© FinanciÃ¨re</span>
                            <span class="scoring-badge">SYSCOHADA</span>
                        </div>
                        <div class="scoring-gauge">
                            <div class="gauge-container">
                                <div class="gauge-bg"></div>
                                <div class="gauge-fill"></div>
                                <div class="gauge-needle" id="gaugeNeedle"></div>
                                <div class="gauge-center"></div>
                            </div>
                        </div>
                        <div class="gauge-labels">
                            <span class="gauge-label">Critique</span>
                            <span class="gauge-label">Faible</span>
                            <span class="gauge-label">Moyen</span>
                            <span class="gauge-label">Bon</span>
                            <span class="gauge-label">Excellent</span>
                        </div>
                        <div class="scoring-value">
                            <span class="score-number" id="scoreNumber">--</span>
                            <span class="score-grade good" id="scoreGrade">--</span>
                        </div>
                        <p class="score-interpretation" id="scoreInterpretation">Importez des donnÃ©es pour obtenir votre score</p>
                        <div class="scoring-details">
                            <div class="scoring-detail">
                                <div class="scoring-detail-value" id="scoreRentabilite">--</div>
                                <div class="scoring-detail-label">RentabilitÃ©</div>
                            </div>
                            <div class="scoring-detail">
                                <div class="scoring-detail-value" id="scoreLiquidite">--</div>
                                <div class="scoring-detail-label">LiquiditÃ©</div>
                            </div>
                            <div class="scoring-detail">
                                <div class="scoring-detail-value" id="scoreSolvabilite">--</div>
                                <div class="scoring-detail-label">SolvabilitÃ©</div>
                            </div>
                        </div>
                    </div>

                    <!-- Commentaires IA -->
                    <div class="ai-insights-card" id="aiInsightsCard">
                        <div class="ai-insights-header">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                            <h3>Analyse IA</h3>
                            <span class="ai-badge">Auto-gÃ©nÃ©rÃ©</span>
                        </div>
                        <div class="ai-insights-body" id="aiInsightsBody">
                            <div class="insight-item">
                                <div class="insight-icon neutral">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div class="insight-content">
                                    <div class="insight-title">En attente de donnÃ©es</div>
                                    <div class="insight-text">Importez une balance comptable pour obtenir une analyse automatique de votre situation financiÃ¨re.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PrÃ©visions N+1 -->
                    <div class="forecast-card" id="forecastCard">
                        <div class="forecast-header">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            <h3>PrÃ©visions N+1</h3>
                        </div>
                        <div class="forecast-body" id="forecastBody">
                            <div class="forecast-item">
                                <span class="forecast-label">Chiffre d'affaires</span>
                                <div class="forecast-values">
                                    <span class="forecast-current" id="fcstCAcurrent">--</span>
                                    <span class="forecast-arrow">â†’</span>
                                    <span class="forecast-predicted" id="fcstCApredicted">--</span>
                                    <span class="forecast-change up" id="fcstCAchange">--</span>
                                </div>
                            </div>
                            <div class="forecast-item">
                                <span class="forecast-label">EBITDA</span>
                                <div class="forecast-values">
                                    <span class="forecast-current" id="fcstEBITDAcurrent">--</span>
                                    <span class="forecast-arrow">â†’</span>
                                    <span class="forecast-predicted" id="fcstEBITDApredicted">--</span>
                                    <span class="forecast-change up" id="fcstEBITDAchange">--</span>
                                </div>
                            </div>
                            <div class="forecast-item">
                                <span class="forecast-label">RÃ©sultat Net</span>
                                <div class="forecast-values">
                                    <span class="forecast-current" id="fcstNETcurrent">--</span>
                                    <span class="forecast-arrow">â†’</span>
                                    <span class="forecast-predicted" id="fcstNETpredicted">--</span>
                                    <span class="forecast-change up" id="fcstNETchange">--</span>
                                </div>
                            </div>
                            <div class="forecast-item">
                                <span class="forecast-label">Marge EBITDA</span>
                                <div class="forecast-values">
                                    <span class="forecast-current" id="fcstMARGcurrent">--</span>
                                    <span class="forecast-arrow">â†’</span>
                                    <span class="forecast-predicted" id="fcstMARGpredicted">--</span>
                                    <span class="forecast-change up" id="fcstMARGchange">--</span>
                                </div>
                            </div>
                            <p style="font-size: 11px; color: var(--slate-400); margin-top: 12px; text-align: center;">
                                * Projection basÃ©e sur les tendances historiques
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Main Grid - Row 1: Bridge + Ratios -->
                <section class="main-grid">
                    <!-- Bar Chart - Bridge Formation du RÃ©sultat -->
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">Formation du RÃ©sultat Net</h3>
                                <p class="card-subtitle">Bridge CA â†’ RÃ©sultat Net (en Mrd FCFA)</p>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="bridgeChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Ratios Card -->
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">Ratios clÃ©s</h3>
                                <p class="card-subtitle">Indicateurs de performance</p>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="ratios-grid">
                                <div class="ratio-card">
                                    <div class="ratio-info">
                                        <span class="ratio-name">ROE</span>
                                        <span class="ratio-value" id="ratioROE">0%</span>
                                    </div>
                                    <div class="ratio-status good" id="statusROE">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="ratio-card">
                                    <div class="ratio-info">
                                        <span class="ratio-name">ROA</span>
                                        <span class="ratio-value" id="ratioROI">0%</span>
                                    </div>
                                    <div class="ratio-status good" id="statusROI">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="ratio-card">
                                    <div class="ratio-info">
                                        <span class="ratio-name">Marge brute</span>
                                        <span class="ratio-value" id="ratioMargeBrute">0%</span>
                                    </div>
                                    <div class="ratio-status good" id="statusMargeBrute">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="ratio-card">
                                    <div class="ratio-info">
                                        <span class="ratio-name">LiquiditÃ© gÃ©n.</span>
                                        <span class="ratio-value" id="ratioCurrent">0</span>
                                    </div>
                                    <div class="ratio-status good" id="statusCurrent">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="ratio-card">
                                    <div class="ratio-info">
                                        <span class="ratio-name">LiquiditÃ© rÃ©d.</span>
                                        <span class="ratio-value" id="ratioQuick">0</span>
                                    </div>
                                    <div class="ratio-status good" id="statusQuick">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="ratio-card">
                                    <div class="ratio-info">
                                        <span class="ratio-name">BFR (jours)</span>
                                        <span class="ratio-value" id="ratioBFR">0j</span>
                                    </div>
                                    <div class="ratio-status warning" id="statusBFR">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Main Grid - Row 2: Donuts -->
                <section class="dashboard-grid-3">
                    <!-- Donut Chart - RÃ©partition des charges -->
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">Structure des charges</h3>
                                <p class="card-subtitle">RÃ©partition en %</p>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container-sm">
                                <canvas id="chargesDonutChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Donut Chart - Structure du bilan -->
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">Structure Actif</h3>
                                <p class="card-subtitle">RÃ©partition des emplois</p>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container-sm">
                                <canvas id="actifDonutChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Donut Chart - Structure Passif -->
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">Structure Passif</h3>
                                <p class="card-subtitle">Origine des ressources</p>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container-sm">
                                <canvas id="passifDonutChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Bottom Grid - Evolution Chart -->
                <section class="bottom-grid-full">
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">Ã‰volution pluriannuelle</h3>
                                <p class="card-subtitle" id="evolutionSubtitle">Chargez plusieurs annÃ©es pour voir l'Ã©volution</p>
                            </div>
                            <div class="evolution-legend" id="evolutionLegend">
                                <!-- Legend items -->
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="evolutionChartContainer">
                                <canvas id="evolutionBarChart"></canvas>
                            </div>
                            <div class="no-data-message" id="noEvolutionData">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:48px;height:48px;color:var(--slate-300);margin-bottom:16px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                </svg>
                                <p>Importez les balances de plusieurs annÃ©es pour voir l'Ã©volution comparative</p>
                                <button class="btn btn-primary btn-sm" onclick="document.getElementById('fileInput').click()" style="margin-top:12px;">
                                    Importer une balance
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            </div> <!-- Fin pageDashboard -->

            <!-- ========== PAGE: Compte de RÃ©sultat ========== -->
            <div id="pagePnL" class="page-section" style="display: none;">
                <div class="page-header">
                    <div class="page-title-section">
                        <h1>Compte de rÃ©sultat</h1>
                        <p>Analyse dÃ©taillÃ©e SYSCOHADA</p>
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary btn-sm" onclick="exportPageToPPT('pnl')">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 13v-1m4 1v-3m4 3V8M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                            </svg>
                            PowerPoint
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="exportToExcel('pnl')">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            Excel
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="exportToPDF('pnl')">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                            PDF
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Compte de rÃ©sultat comparatif</h3>
                            <p class="card-subtitle" id="pnlSubtitle">Exercice en cours</p>
                        </div>
                        <span class="card-badge">en M FCFA</span>
                    </div>
                    <div class="card-body">
                        <table class="data-table blue-header" id="pnlDetailTable">
                            <thead id="pnlTableHead">
                                <tr>
                                    <th>LibellÃ©</th>
                                    <th style="text-align: right;">Montant</th>
                                </tr>
                            </thead>
                            <tbody id="pnlDetailBody">
                                <tr><td colspan="2" style="text-align:center;color:var(--slate-400);padding:40px;">Importez une balance comptable pour voir les donnÃ©es</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ========== PAGE: Bilan ========== -->
            <div id="pageBilan" class="page-section" style="display: none;">
                <div class="page-header">
                    <div class="page-title-section">
                        <h1>Bilan</h1>
                        <p>Structure patrimoniale SYSCOHADA</p>
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary btn-sm" onclick="exportPageToPPT('bilan')">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 13v-1m4 1v-3m4 3V8M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                            </svg>
                            PowerPoint
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="exportToExcel('bilan')">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            Excel
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="exportToPDF('bilan')">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                            PDF
                        </button>
                    </div>
                </div>

                <!-- Alerte Ã©quilibre bilan -->
                <div id="bilanAlert" class="alert alert-warning" style="display: none;">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;flex-shrink:0;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <div>
                        <strong>Attention : Bilan non Ã©quilibrÃ©</strong>
                        <p id="bilanAlertDetail" style="margin:4px 0 0 0;font-size:13px;"></p>
                    </div>
                </div>

                <p class="comparison-subtitle" id="bilanComparisonSubtitle" style="text-align:center;color:var(--slate-500);margin-bottom:16px;display:none;"></p>

                <div class="bottom-grid">
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">Actif</h3>
                                <p class="card-subtitle">Emplois des ressources (en M FCFA)</p>
                            </div>
                        </div>
                        <div class="card-body">
                            <table class="data-table" id="actifTable">
                                <thead id="actifTableHead">
                                    <tr>
                                        <th>LibellÃ©</th>
                                        <th style="text-align:right;">Montant</th>
                                    </tr>
                                </thead>
                                <tbody id="actifDetailBody">
                                    <tr><td colspan="3" style="text-align:center;color:var(--slate-400);padding:40px;">Importez une balance comptable</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">Passif</h3>
                                <p class="card-subtitle">Origine des ressources (en M FCFA)</p>
                            </div>
                        </div>
                        <div class="card-body">
                            <table class="data-table" id="passifTable">
                                <thead id="passifTableHead">
                                    <tr>
                                        <th>LibellÃ©</th>
                                        <th style="text-align:right;">Montant</th>
                                    </tr>
                                </thead>
                                <tbody id="passifDetailBody">
                                    <tr><td colspan="3" style="text-align:center;color:var(--slate-400);padding:40px;">Importez une balance comptable</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== PAGE: Cash Flow ========== -->
            <div id="pageCashflow" class="page-section" style="display: none;">
                <div class="page-header">
                    <div class="page-title-section">
                        <h1>Tableau des flux de trÃ©sorerie</h1>
                        <p>Cash Flow Statement - MÃ©thode indirecte</p>
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary btn-sm" onclick="exportPageToPPT('cashflow')">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 13v-1m4 1v-3m4 3V8M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                            </svg>
                            PowerPoint
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="exportToExcel('cashflow')">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            Excel
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="exportToPDF('cashflow')">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                            PDF
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Flux de trÃ©sorerie</h3>
                            <p class="card-subtitle">Analyse de la variation de trÃ©sorerie</p>
                        </div>
                        <span class="card-badge">en M FCFA</span>
                    </div>
                    <div class="card-body" id="cashflowBody">
                        <div style="text-align:center;color:var(--slate-400);padding:40px;">Importez une balance comptable pour voir les donnÃ©es</div>
                    </div>
                </div>
            </div>

            <!-- ========== PAGE: Ratios ========== -->
            <div id="pageRatios" class="page-section" style="display: none;">
                <div class="page-header">
                    <div class="page-title-section">
                        <h1>Ratios financiers</h1>
                        <p>Indicateurs de performance classÃ©s par catÃ©gorie</p>
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary btn-sm" onclick="exportPageToPPT('ratios')">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 13v-1m4 1v-3m4 3V8M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                            </svg>
                            PowerPoint
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="exportToExcel('ratios')">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            Excel
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="exportToPDF('ratios')">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                            PDF
                        </button>
                    </div>
                </div>

                <div id="ratiosContent" style="display: none;">
                    <!-- ProfitabilitÃ© -->
                    <div class="ratios-category">
                        <div class="ratios-category-header">
                            <div class="ratios-category-icon blue">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                            </div>
                            <div>
                                <h3>ProfitabilitÃ©</h3>
                                <p>CapacitÃ© Ã  gÃ©nÃ©rer des bÃ©nÃ©fices</p>
                            </div>
                        </div>
                        <div class="ratios-category-grid">
                            <div class="ratio-detail-card status-good">
                                <div class="ratio-detail-header">
                                    <div>
                                        <span class="ratio-detail-name">Marge Brute</span>
                                        <span class="ratio-detail-value" id="ratioMargeBruteDetail">0%</span>
                                    </div>
                                    <div class="ratio-detail-status good" id="statusMargeBrute">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                </div>
                                <div class="ratio-detail-bar"><div class="ratio-detail-fill blue" id="barMargeBrute" style="width: 0%"></div></div>
                                <div class="ratio-detail-footer">
                                    <p class="ratio-detail-desc">Marge Brute / CA</p>
                                    <span class="ratio-detail-benchmark">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                        Objectif: >20%
                                    </span>
                                </div>
                            </div>
                            <div class="ratio-detail-card status-good">
                                <div class="ratio-detail-header">
                                    <div>
                                        <span class="ratio-detail-name">Marge EBITDA</span>
                                        <span class="ratio-detail-value" id="ratioMargeEbitdaDetail">0%</span>
                                    </div>
                                    <div class="ratio-detail-status good" id="statusMargeEbitda">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                </div>
                                <div class="ratio-detail-bar"><div class="ratio-detail-fill blue" id="barMargeEbitda" style="width: 0%"></div></div>
                                <div class="ratio-detail-footer">
                                    <p class="ratio-detail-desc">EBITDA / CA</p>
                                    <span class="ratio-detail-benchmark">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                        Objectif: >15%
                                    </span>
                                </div>
                            </div>
                            <div class="ratio-detail-card status-good">
                                <div class="ratio-detail-header">
                                    <div>
                                        <span class="ratio-detail-name">Marge OpÃ©rationnelle</span>
                                        <span class="ratio-detail-value" id="ratioMargeOpDetail">0%</span>
                                    </div>
                                    <div class="ratio-detail-status good" id="statusMargeOp">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                </div>
                                <div class="ratio-detail-bar"><div class="ratio-detail-fill blue" id="barMargeOp" style="width: 0%"></div></div>
                                <div class="ratio-detail-footer">
                                    <p class="ratio-detail-desc">EBIT / CA</p>
                                    <span class="ratio-detail-benchmark">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                        Objectif: >10%
                                    </span>
                                </div>
                            </div>
                            <div class="ratio-detail-card status-good">
                                <div class="ratio-detail-header">
                                    <div>
                                        <span class="ratio-detail-name">Marge Nette</span>
                                        <span class="ratio-detail-value" id="ratioMargeNetteDetail">0%</span>
                                    </div>
                                    <div class="ratio-detail-status good" id="statusMargeNette">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                </div>
                                <div class="ratio-detail-bar"><div class="ratio-detail-fill blue" id="barMargeNette" style="width: 0%"></div></div>
                                <div class="ratio-detail-footer">
                                    <p class="ratio-detail-desc">RÃ©sultat Net / CA</p>
                                    <span class="ratio-detail-benchmark">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                        Objectif: >5%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RentabilitÃ© -->
                    <div class="ratios-category">
                        <div class="ratios-category-header">
                            <div class="ratios-category-icon green">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            </div>
                            <div>
                                <h3>RentabilitÃ©</h3>
                                <p>Rendement des capitaux investis</p>
                            </div>
                        </div>
                        <div class="ratios-category-grid">
                            <div class="ratio-detail-card status-good">
                                <div class="ratio-detail-header">
                                    <div>
                                        <span class="ratio-detail-name">ROE</span>
                                        <span class="ratio-detail-value" id="ratioROEDetail">0%</span>
                                    </div>
                                    <div class="ratio-detail-status good" id="statusROE">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                </div>
                                <div class="ratio-detail-bar"><div class="ratio-detail-fill green" id="barROE" style="width: 0%"></div></div>
                                <div class="ratio-detail-footer">
                                    <p class="ratio-detail-desc">RÃ©sultat Net / Capitaux Propres</p>
                                    <span class="ratio-detail-benchmark">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                        Objectif: >15%
                                    </span>
                                </div>
                            </div>
                            <div class="ratio-detail-card status-good">
                                <div class="ratio-detail-header">
                                    <div>
                                        <span class="ratio-detail-name">ROA</span>
                                        <span class="ratio-detail-value" id="ratioROADetail">0%</span>
                                    </div>
                                    <div class="ratio-detail-status good" id="statusROA">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                </div>
                                <div class="ratio-detail-bar"><div class="ratio-detail-fill green" id="barROA" style="width: 0%"></div></div>
                                <div class="ratio-detail-footer">
                                    <p class="ratio-detail-desc">RÃ©sultat Net / Total Actif</p>
                                    <span class="ratio-detail-benchmark">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                        Objectif: >5%
                                    </span>
                                </div>
                            </div>
                            <div class="ratio-detail-card status-good">
                                <div class="ratio-detail-header">
                                    <div>
                                        <span class="ratio-detail-name">ROCE</span>
                                        <span class="ratio-detail-value" id="ratioROCEDetail">0%</span>
                                    </div>
                                    <div class="ratio-detail-status good" id="statusROCE">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                </div>
                                <div class="ratio-detail-bar"><div class="ratio-detail-fill green" id="barROCE" style="width: 0%"></div></div>
                                <div class="ratio-detail-footer">
                                    <p class="ratio-detail-desc">EBIT / Capitaux EmployÃ©s</p>
                                    <span class="ratio-detail-benchmark">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                        Objectif: >10%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- LiquiditÃ© -->
                    <div class="ratios-category">
                        <div class="ratios-category-header">
                            <div class="ratios-category-icon purple">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                            </div>
                            <div>
                                <h3>LiquiditÃ©</h3>
                                <p>CapacitÃ© Ã  faire face aux engagements court terme</p>
                            </div>
                        </div>
                        <div class="ratios-category-grid">
                            <div class="ratio-detail-card status-good">
                                <div class="ratio-detail-header">
                                    <div>
                                        <span class="ratio-detail-name">Current Ratio</span>
                                        <span class="ratio-detail-value" id="ratioCurrentDetail">0</span>
                                    </div>
                                    <div class="ratio-detail-status good" id="statusCurrent">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                </div>
                                <div class="ratio-detail-bar"><div class="ratio-detail-fill purple" id="barCurrent" style="width: 0%"></div></div>
                                <div class="ratio-detail-footer">
                                    <p class="ratio-detail-desc">Actif Circulant / Passif Circulant</p>
                                    <span class="ratio-detail-benchmark">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                        Objectif: >1.5
                                    </span>
                                </div>
                            </div>
                            <div class="ratio-detail-card status-good">
                                <div class="ratio-detail-header">
                                    <div>
                                        <span class="ratio-detail-name">Quick Ratio</span>
                                        <span class="ratio-detail-value" id="ratioQuickDetail">0</span>
                                    </div>
                                    <div class="ratio-detail-status good" id="statusQuick">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                </div>
                                <div class="ratio-detail-bar"><div class="ratio-detail-fill purple" id="barQuick" style="width: 0%"></div></div>
                                <div class="ratio-detail-footer">
                                    <p class="ratio-detail-desc">(Actif Circ. - Stocks) / Passif Circ.</p>
                                    <span class="ratio-detail-benchmark">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                        Objectif: >1
                                    </span>
                                </div>
                            </div>
                            <div class="ratio-detail-card status-good">
                                <div class="ratio-detail-header">
                                    <div>
                                        <span class="ratio-detail-name">Cash Ratio</span>
                                        <span class="ratio-detail-value" id="ratioCashDetail">0</span>
                                    </div>
                                    <div class="ratio-detail-status good" id="statusCash">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                </div>
                                <div class="ratio-detail-bar"><div class="ratio-detail-fill purple" id="barCash" style="width: 0%"></div></div>
                                <div class="ratio-detail-footer">
                                    <p class="ratio-detail-desc">TrÃ©sorerie / Passif Circulant</p>
                                    <span class="ratio-detail-benchmark">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                        Objectif: >0.2
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SolvabilitÃ© -->
                    <div class="ratios-category">
                        <div class="ratios-category-header">
                            <div class="ratios-category-icon orange">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                            </div>
                            <div>
                                <h3>SolvabilitÃ©</h3>
                                <p>Structure financiÃ¨re et endettement</p>
                            </div>
                        </div>
                        <div class="ratios-category-grid">
                            <div class="ratio-detail-card status-warning">
                                <div class="ratio-detail-header">
                                    <div>
                                        <span class="ratio-detail-name">Endettement</span>
                                        <span class="ratio-detail-value" id="ratioEndettementDetail">0%</span>
                                    </div>
                                    <div class="ratio-detail-status warning" id="statusEndettement">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                    </div>
                                </div>
                                <div class="ratio-detail-bar"><div class="ratio-detail-fill orange" id="barEndettement" style="width: 0%"></div></div>
                                <div class="ratio-detail-footer">
                                    <p class="ratio-detail-desc">Dettes Totales / Total Passif</p>
                                    <span class="ratio-detail-benchmark">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/></svg>
                                        Objectif: &lt;60%
                                    </span>
                                </div>
                            </div>
                            <div class="ratio-detail-card status-good">
                                <div class="ratio-detail-header">
                                    <div>
                                        <span class="ratio-detail-name">Gearing</span>
                                        <span class="ratio-detail-value" id="ratioGearingDetail">0%</span>
                                    </div>
                                    <div class="ratio-detail-status good" id="statusGearing">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                </div>
                                <div class="ratio-detail-bar"><div class="ratio-detail-fill orange" id="barGearing" style="width: 0%"></div></div>
                                <div class="ratio-detail-footer">
                                    <p class="ratio-detail-desc">Dettes Fin. / Capitaux Propres</p>
                                    <span class="ratio-detail-benchmark">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/></svg>
                                        Objectif: &lt;100%
                                    </span>
                                </div>
                            </div>
                            <div class="ratio-detail-card status-good">
                                <div class="ratio-detail-header">
                                    <div>
                                        <span class="ratio-detail-name">Net Debt / EBITDA</span>
                                        <span class="ratio-detail-value" id="ratioNetDebtDetail">0x</span>
                                    </div>
                                    <div class="ratio-detail-status good" id="statusNetDebt">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                </div>
                                <div class="ratio-detail-bar"><div class="ratio-detail-fill orange" id="barNetDebt" style="width: 0%"></div></div>
                                <div class="ratio-detail-footer">
                                    <p class="ratio-detail-desc">Dette Nette / EBITDA</p>
                                    <span class="ratio-detail-benchmark">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/></svg>
                                        Objectif: &lt;3x
                                    </span>
                                </div>
                            </div>
                            <div class="ratio-detail-card status-good">
                                <div class="ratio-detail-header">
                                    <div>
                                        <span class="ratio-detail-name">Autonomie FinanciÃ¨re</span>
                                        <span class="ratio-detail-value" id="ratioAutonomieDetail">0%</span>
                                    </div>
                                    <div class="ratio-detail-status good" id="statusAutonomie">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                </div>
                                <div class="ratio-detail-bar"><div class="ratio-detail-fill orange" id="barAutonomie" style="width: 0%"></div></div>
                                <div class="ratio-detail-footer">
                                    <p class="ratio-detail-desc">Capitaux Propres / Total Passif</p>
                                    <span class="ratio-detail-benchmark">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                        Objectif: >40%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- EfficacitÃ© / Rotation -->
                    <div class="ratios-category">
                        <div class="ratios-category-header">
                            <div class="ratios-category-icon red">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            </div>
                            <div>
                                <h3>EfficacitÃ© / Rotation</h3>
                                <p>Gestion du cycle d'exploitation</p>
                            </div>
                        </div>
                        <div class="ratios-category-grid">
                            <div class="ratio-detail-card status-good">
                                <div class="ratio-detail-header">
                                    <div>
                                        <span class="ratio-detail-name">BFR en jours</span>
                                        <span class="ratio-detail-value" id="ratioBFRDetail">0 j</span>
                                    </div>
                                    <div class="ratio-detail-status good" id="statusBFR">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                </div>
                                <div class="ratio-detail-bar"><div class="ratio-detail-fill red" id="barBFR" style="width: 0%"></div></div>
                                <div class="ratio-detail-footer">
                                    <p class="ratio-detail-desc">BFR / (CA/365)</p>
                                    <span class="ratio-detail-benchmark">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/></svg>
                                        Objectif: &lt;45j
                                    </span>
                                </div>
                            </div>
                            <div class="ratio-detail-card status-good">
                                <div class="ratio-detail-header">
                                    <div>
                                        <span class="ratio-detail-name">Rotation Stocks</span>
                                        <span class="ratio-detail-value" id="ratioRotationStocksDetail">0 j</span>
                                    </div>
                                    <div class="ratio-detail-status good" id="statusRotationStocks">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                </div>
                                <div class="ratio-detail-bar"><div class="ratio-detail-fill red" id="barRotationStocks" style="width: 0%"></div></div>
                                <div class="ratio-detail-footer">
                                    <p class="ratio-detail-desc">Stocks / (Achats/365)</p>
                                    <span class="ratio-detail-benchmark">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/></svg>
                                        Objectif: &lt;60j
                                    </span>
                                </div>
                            </div>
                            <div class="ratio-detail-card status-warning">
                                <div class="ratio-detail-header">
                                    <div>
                                        <span class="ratio-detail-name">DÃ©lai Clients</span>
                                        <span class="ratio-detail-value" id="ratioDelaiClientsDetail">0 j</span>
                                    </div>
                                    <div class="ratio-detail-status warning" id="statusDelaiClients">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                    </div>
                                </div>
                                <div class="ratio-detail-bar"><div class="ratio-detail-fill red" id="barDelaiClients" style="width: 0%"></div></div>
                                <div class="ratio-detail-footer">
                                    <p class="ratio-detail-desc">CrÃ©ances Clients / (CA/365)</p>
                                    <span class="ratio-detail-benchmark">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/></svg>
                                        Objectif: &lt;45j
                                    </span>
                                </div>
                            </div>
                            <div class="ratio-detail-card status-good">
                                <div class="ratio-detail-header">
                                    <div>
                                        <span class="ratio-detail-name">DÃ©lai Fournisseurs</span>
                                        <span class="ratio-detail-value" id="ratioDelaiFournDetail">0 j</span>
                                    </div>
                                    <div class="ratio-detail-status good" id="statusDelaiFourn">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                </div>
                                <div class="ratio-detail-bar"><div class="ratio-detail-fill red" id="barDelaiFourn" style="width: 0%"></div></div>
                                <div class="ratio-detail-footer">
                                    <p class="ratio-detail-desc">Dettes Fourn. / (Achats/365)</p>
                                    <span class="ratio-detail-benchmark">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                        Objectif: 30-60j
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="ratiosEmpty" style="text-align:center;color:var(--slate-400);padding:60px;">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:48px;height:48px;margin-bottom:16px;color:var(--slate-300);">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    <p>Importez une balance comptable pour voir les ratios</p>
                </div>
            </div>

            <!-- ========== PAGE: Evolution ========== -->
            <div id="pageEvolution" class="page-section" style="display: none;">
                <div class="page-header">
                    <div class="page-title-section">
                        <h1>Ã‰volution pluriannuelle</h1>
                        <p>Analyse comparative sur plusieurs exercices</p>
                    </div>
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:18px;height:18px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Ajouter une annÃ©e
                    </button>
                </div>

                <!-- Years loaded indicator -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-body">
                        <div id="evolutionYearsStatus" style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                            <span style="font-weight: 600; color: var(--slate-700);">AnnÃ©es chargÃ©es :</span>
                            <div id="evolutionYearsBadges" style="display: flex; gap: 8px;">
                                <span style="color: var(--slate-400);">Aucune annÃ©e chargÃ©e</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Evolution Charts -->
                <div class="bottom-grid">
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">Ã‰volution du CA et RÃ©sultats</h3>
                                <p class="card-subtitle">Comparaison annuelle</p>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="evolutionChartContainer2">
                                <canvas id="evolutionPageChart"></canvas>
                            </div>
                            <div id="noEvolutionPageData" style="text-align: center; padding: 40px; color: var(--slate-400);">
                                <p>Chargez au moins 2 annÃ©es pour voir l'Ã©volution</p>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">Ã‰volution des Ratios</h3>
                                <p class="card-subtitle">Performance dans le temps</p>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="ratiosChartContainer">
                                <canvas id="ratiosEvolutionChart"></canvas>
                            </div>
                            <div id="noRatiosData" style="text-align: center; padding: 40px; color: var(--slate-400);">
                                <p>Chargez au moins 2 annÃ©es pour voir l'Ã©volution</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Variation Table -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Tableau des variations</h3>
                            <p class="card-subtitle">Ã‰volution en valeur et en %</p>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="data-table" id="variationTable">
                            <thead>
                                <tr>
                                    <th>Indicateur</th>
                                    <th id="varYear1" style="text-align: right;">N-1</th>
                                    <th id="varYear2" style="text-align: right;">N</th>
                                    <th style="text-align: right;">Variation</th>
                                    <th style="text-align: right;">%</th>
                                </tr>
                            </thead>
                            <tbody id="variationTableBody">
                                <tr><td colspan="5" style="text-align: center; color: var(--slate-400); padding: 40px;">Chargez au moins 2 annÃ©es</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ========== PAGE: Import ========== -->
            <div id="pageImport" class="page-section" style="display: none;">
                <div class="page-header">
                    <div class="page-title-section">
                        <h1>Importer des donnÃ©es</h1>
                        <p>Balance comptable SYSCOHADA</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="upload-section" id="uploadSectionImport" style="margin: 0;">
                            <div class="upload-icon-wrapper">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                            </div>
                            <h3 class="upload-title">DÃ©posez votre fichier ici</h3>
                            <p class="upload-subtitle">ou <span onclick="document.getElementById('fileInput').click()" style="color: var(--blue-600); cursor: pointer; font-weight: 600;">parcourez</span> pour sÃ©lectionner</p>
                            <div class="upload-formats">
                                <span class="format-badge">Balance SYSCOHADA</span>
                                <span class="format-badge">.xlsx</span>
                                <span class="format-badge">.xls</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== PAGE: Settings ========== -->
            <div id="pageSettings" class="page-section" style="display: none;">
                <div class="page-header">
                    <div class="page-title-section">
                        <h1>Configuration</h1>
                        <p>ParamÃ¨tres de l'application et mapping des comptes</p>
                    </div>
                </div>

                <!-- Entreprise & RÃ©fÃ©rentiel -->
                <div class="bottom-grid" style="margin-bottom: 24px;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Entreprise</h3>
                        </div>
                        <div class="card-body">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; font-weight: 500; color: var(--slate-700); margin-bottom: 8px;">Nom de l'entreprise</label>
                                <input type="text" id="companyName" value="Ma SociÃ©tÃ© SA" style="width: 100%; padding: 12px; border: 1px solid var(--slate-200); border-radius: 10px; font-size: 14px; font-family: inherit;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 14px; font-weight: 500; color: var(--slate-700); margin-bottom: 8px;">Exercice fiscal</label>
                                <input type="text" id="fiscalYear" value="2024" style="width: 100%; padding: 12px; border: 1px solid var(--slate-200); border-radius: 10px; font-size: 14px; font-family: inherit;">
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">RÃ©fÃ©rentiel comptable</h3>
                        </div>
                        <div class="card-body">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; font-weight: 500; color: var(--slate-700); margin-bottom: 8px;">Plan comptable</label>
                                <select id="accountingStandard" style="width: 100%; padding: 12px; border: 1px solid var(--slate-200); border-radius: 10px; font-size: 14px; font-family: inherit;">
                                    <option value="syscohada" selected>SYSCOHADA rÃ©visÃ©</option>
                                    <option value="ifrs">IFRS</option>
                                    <option value="pcg">PCG France</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 14px; font-weight: 500; color: var(--slate-700); margin-bottom: 8px;">Devise</label>
                                <select id="currency" style="width: 100%; padding: 12px; border: 1px solid var(--slate-200); border-radius: 10px; font-size: 14px; font-family: inherit;">
                                    <option value="XOF" selected>FCFA - Franc CFA</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="USD">USD - Dollar US</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Objectifs financiers personnalisables -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">ðŸŽ¯ Objectifs financiers</h3>
                            <p class="card-subtitle">DÃ©finissez vos cibles pour personnaliser l'analyse des ratios</p>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="resetObjectives()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            RÃ©initialiser
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="objectives-grid">
                            <!-- ProfitabilitÃ© -->
                            <div class="objective-category">
                                <h4 class="objective-category-title">
                                    <span class="objective-icon blue">ðŸ“ˆ</span>
                                    ProfitabilitÃ©
                                </h4>
                                <div class="objective-items">
                                    <div class="objective-item">
                                        <label>Marge Brute</label>
                                        <div class="objective-input-group">
                                            <span class="objective-operator">â‰¥</span>
                                            <input type="number" id="objMargeBrute" value="20" min="0" max="100" step="1" onchange="saveObjectives()">
                                            <span class="objective-unit">%</span>
                                        </div>
                                    </div>
                                    <div class="objective-item">
                                        <label>Marge EBITDA</label>
                                        <div class="objective-input-group">
                                            <span class="objective-operator">â‰¥</span>
                                            <input type="number" id="objMargeEBITDA" value="15" min="0" max="100" step="1" onchange="saveObjectives()">
                                            <span class="objective-unit">%</span>
                                        </div>
                                    </div>
                                    <div class="objective-item">
                                        <label>Marge Nette</label>
                                        <div class="objective-input-group">
                                            <span class="objective-operator">â‰¥</span>
                                            <input type="number" id="objMargeNette" value="5" min="0" max="100" step="1" onchange="saveObjectives()">
                                            <span class="objective-unit">%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- RentabilitÃ© -->
                            <div class="objective-category">
                                <h4 class="objective-category-title">
                                    <span class="objective-icon green">ðŸ’°</span>
                                    RentabilitÃ©
                                </h4>
                                <div class="objective-items">
                                    <div class="objective-item">
                                        <label>ROE</label>
                                        <div class="objective-input-group">
                                            <span class="objective-operator">â‰¥</span>
                                            <input type="number" id="objROE" value="15" min="0" max="100" step="1" onchange="saveObjectives()">
                                            <span class="objective-unit">%</span>
                                        </div>
                                    </div>
                                    <div class="objective-item">
                                        <label>ROA</label>
                                        <div class="objective-input-group">
                                            <span class="objective-operator">â‰¥</span>
                                            <input type="number" id="objROA" value="5" min="0" max="100" step="1" onchange="saveObjectives()">
                                            <span class="objective-unit">%</span>
                                        </div>
                                    </div>
                                    <div class="objective-item">
                                        <label>ROCE</label>
                                        <div class="objective-input-group">
                                            <span class="objective-operator">â‰¥</span>
                                            <input type="number" id="objROCE" value="10" min="0" max="100" step="1" onchange="saveObjectives()">
                                            <span class="objective-unit">%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- LiquiditÃ© -->
                            <div class="objective-category">
                                <h4 class="objective-category-title">
                                    <span class="objective-icon purple">ðŸ’§</span>
                                    LiquiditÃ©
                                </h4>
                                <div class="objective-items">
                                    <div class="objective-item">
                                        <label>Ratio de liquiditÃ© gÃ©nÃ©rale</label>
                                        <div class="objective-input-group">
                                            <span class="objective-operator">â‰¥</span>
                                            <input type="number" id="objCurrentRatio" value="1.5" min="0" max="10" step="0.1" onchange="saveObjectives()">
                                            <span class="objective-unit">x</span>
                                        </div>
                                    </div>
                                    <div class="objective-item">
                                        <label>Ratio de liquiditÃ© rÃ©duite</label>
                                        <div class="objective-input-group">
                                            <span class="objective-operator">â‰¥</span>
                                            <input type="number" id="objQuickRatio" value="1.0" min="0" max="10" step="0.1" onchange="saveObjectives()">
                                            <span class="objective-unit">x</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- SolvabilitÃ© -->
                            <div class="objective-category">
                                <h4 class="objective-category-title">
                                    <span class="objective-icon orange">ðŸ¦</span>
                                    SolvabilitÃ©
                                </h4>
                                <div class="objective-items">
                                    <div class="objective-item">
                                        <label>Ratio d'endettement</label>
                                        <div class="objective-input-group">
                                            <span class="objective-operator">â‰¤</span>
                                            <input type="number" id="objEndettement" value="60" min="0" max="200" step="5" onchange="saveObjectives()">
                                            <span class="objective-unit">%</span>
                                        </div>
                                    </div>
                                    <div class="objective-item">
                                        <label>Gearing (Dette/CP)</label>
                                        <div class="objective-input-group">
                                            <span class="objective-operator">â‰¤</span>
                                            <input type="number" id="objGearing" value="3" min="0" max="10" step="0.5" onchange="saveObjectives()">
                                            <span class="objective-unit">x</span>
                                        </div>
                                    </div>
                                    <div class="objective-item">
                                        <label>Autonomie financiÃ¨re</label>
                                        <div class="objective-input-group">
                                            <span class="objective-operator">â‰¥</span>
                                            <input type="number" id="objAutonomie" value="40" min="0" max="100" step="5" onchange="saveObjectives()">
                                            <span class="objective-unit">%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- EfficacitÃ© -->
                            <div class="objective-category">
                                <h4 class="objective-category-title">
                                    <span class="objective-icon red">â±ï¸</span>
                                    EfficacitÃ© / Rotation
                                </h4>
                                <div class="objective-items">
                                    <div class="objective-item">
                                        <label>BFR en jours</label>
                                        <div class="objective-input-group">
                                            <span class="objective-operator">â‰¤</span>
                                            <input type="number" id="objBFR" value="45" min="0" max="365" step="5" onchange="saveObjectives()">
                                            <span class="objective-unit">j</span>
                                        </div>
                                    </div>
                                    <div class="objective-item">
                                        <label>DÃ©lai clients</label>
                                        <div class="objective-input-group">
                                            <span class="objective-operator">â‰¤</span>
                                            <input type="number" id="objDelaiClients" value="45" min="0" max="180" step="5" onchange="saveObjectives()">
                                            <span class="objective-unit">j</span>
                                        </div>
                                    </div>
                                    <div class="objective-item">
                                        <label>DÃ©lai fournisseurs</label>
                                        <div class="objective-input-group">
                                            <span class="objective-operator">â‰¥</span>
                                            <input type="number" id="objDelaiFourn" value="30" min="0" max="180" step="5" onchange="saveObjectives()">
                                            <span class="objective-unit">j</span>
                                        </div>
                                    </div>
                                    <div class="objective-item">
                                        <label>Rotation stocks</label>
                                        <div class="objective-input-group">
                                            <span class="objective-operator">â‰¤</span>
                                            <input type="number" id="objRotationStocks" value="60" min="0" max="365" step="5" onchange="saveObjectives()">
                                            <span class="objective-unit">j</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="objectives-footer">
                            <p class="objectives-note">ðŸ’¡ Ces objectifs sont utilisÃ©s pour Ã©valuer vos ratios (vert si atteint, rouge sinon) et calculer votre score de santÃ© financiÃ¨re.</p>
                            <button class="btn btn-primary" onclick="applyObjectivesAndRefresh()">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:18px;height:18px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                Appliquer les objectifs
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Mapping des comptes - Section principale -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Mapping des comptes SYSCOHADA</h3>
                            <p class="card-subtitle">Configurez le classement des comptes dans les catÃ©gories analytiques</p>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Tabs de navigation -->
                        <div class="mapping-tabs">
                            <button class="mapping-tab active" onclick="switchMappingTab('prefixes')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                                PrÃ©fixes de comptes
                            </button>
                            <button class="mapping-tab" onclick="switchMappingTab('exceptions')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                Exceptions
                            </button>
                            <button class="mapping-tab" onclick="switchMappingTab('unclassified')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                Ã€ classifier <span class="unclassified-badge" id="unclassifiedBadge" style="background:#ef4444;color:white;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:6px;">0</span>
                            </button>
                            <button class="mapping-tab" onclick="switchMappingTab('importexport')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>
                                Import/Export
                            </button>
                        </div>

                        <!-- Tab 1: PrÃ©fixes de comptes -->
                        <div id="tabPrefixes" class="mapping-tab-content active">
                            <div class="mapping-actions-bar">
                                <div class="mapping-search">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                    <input type="text" placeholder="Rechercher un prÃ©fixe..." id="searchPrefixInput" oninput="filterMappingCategories()">
                                </div>
                                <div class="mapping-actions-buttons">
                                    <button class="btn btn-secondary btn-sm" onclick="resetMapping()">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                        RÃ©initialiser par dÃ©faut
                                    </button>
                                </div>
                            </div>

                            <div class="mapping-grid" id="mappingPrefixesGrid">
                                <!-- GÃ©nÃ©rÃ© dynamiquement par renderPrefixesMapping() -->
                            </div>
                        </div>


                        <!-- Tab 2: Exceptions (reclassements individuels) -->
                        <div id="tabExceptions" class="mapping-tab-content">
                            <div class="exceptions-section">
                                <h4>
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                    Reclassements individuels
                                </h4>
                                <p class="mapping-description">Reclassez des comptes spÃ©cifiques dans une catÃ©gorie diffÃ©rente de leur prÃ©fixe par dÃ©faut. Ces exceptions sont prioritaires sur le mapping par prÃ©fixe.</p>
                                
                                <div class="exceptions-list" id="exceptionsList">
                                    <!-- Les exceptions seront gÃ©nÃ©rÃ©es dynamiquement -->
                                    <div id="noExceptions" style="text-align:center;color:#92400e;padding:20px;font-size:14px;">
                                        Aucune exception configurÃ©e. Les comptes sont classÃ©s selon leurs prÃ©fixes.
                                    </div>
                                </div>

                                <div class="exception-add">
                                    <div class="form-field">
                                        <label>NÂ° de compte</label>
                                        <input type="text" id="exceptionCompte" placeholder="Ex: 6241" maxlength="10" style="width:120px;">
                                    </div>
                                    <div class="form-field">
                                        <label>LibellÃ© (optionnel)</label>
                                        <input type="text" id="exceptionLibelle" placeholder="Ex: Transport sur ventes" style="width:200px;">
                                    </div>
                                    <div class="form-field">
                                        <label>Reclasser vers</label>
                                        <select id="exceptionTarget">
                                            <optgroup label="Bilan - Actif">
                                                <option value="actifImmobilise">Actif ImmobilisÃ©</option>
                                                <option value="actifCirculant">Actif Circulant</option>
                                                <option value="tresorerieActif">TrÃ©sorerie Actif</option>
                                            </optgroup>
                                            <optgroup label="Bilan - Passif">
                                                <option value="capitauxPropres">Capitaux Propres</option>
                                                <option value="dettesFinancieres">Dettes FinanciÃ¨res</option>
                                                <option value="passifCirculant">Passif Circulant</option>
                                            </optgroup>
                                            <optgroup label="Compte de RÃ©sultat - Produits">
                                                <option value="chiffreAffaires">Chiffre d'Affaires</option>
                                                <option value="autresProduits">Autres Produits</option>
                                            </optgroup>
                                            <optgroup label="Compte de RÃ©sultat - Charges">
                                                <option value="achats">Achats & CoÃ»ts Directs</option>
                                                <option value="chargesExternes">Charges Externes</option>
                                                <option value="chargesPersonnel">Charges de Personnel</option>
                                                <option value="dotations">Dotations aux Amortissements</option>
                                                <option value="chargesFinancieres">Charges FinanciÃ¨res</option>
                                                <option value="impots">ImpÃ´ts & Taxes</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="addException()" style="align-self:flex-end;">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                        Ajouter
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Tab 3: Comptes non classÃ©s -->
                        <div id="tabUnclassified" class="mapping-tab-content">
                            <div class="unclassified-section" id="unclassifiedSection">
                                <div class="unclassified-header">
                                    <h4>
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                        Comptes Ã  classifier
                                    </h4>
                                    <span class="unclassified-count" id="unclassifiedCount">0</span>
                                </div>
                                <p class="mapping-description" style="color:#991b1b;">Ces comptes de votre balance ne correspondent Ã  aucun prÃ©fixe configurÃ©. Classez-les manuellement ou ajoutez leurs prÃ©fixes dans l'onglet "PrÃ©fixes de comptes".</p>
                                
                                <div class="unclassified-list" id="unclassifiedList">
                                    <!-- Comptes non classÃ©s gÃ©nÃ©rÃ©s dynamiquement -->
                                    <div id="noUnclassified" style="text-align:center;color:#166534;padding:40px;grid-column: 1/-1;">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:48px;height:48px;margin-bottom:12px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                        <p style="font-weight:600;">Tous les comptes sont classÃ©s !</p>
                                        <p style="font-size:13px;margin-top:4px;">Importez une balance pour voir les comptes Ã  classifier</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab 4: Import/Export -->
                        <div id="tabImportexport" class="mapping-tab-content">
                            <div class="import-export-section">
                                <div class="ie-card">
                                    <div class="icon-wrapper import">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                                    </div>
                                    <h4>Importer un mapping</h4>
                                    <p>Chargez une configuration de mapping depuis un fichier JSON. Cela remplacera votre configuration actuelle.</p>
                                    <input type="file" id="importMappingInput" accept=".json" onchange="importMapping(event)">
                                    <button class="btn btn-secondary" onclick="document.getElementById('importMappingInput').click()">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:18px;height:18px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                                        Choisir un fichier JSON
                                    </button>
                                </div>
                                <div class="ie-card">
                                    <div class="icon-wrapper export">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                    </div>
                                    <h4>Exporter le mapping</h4>
                                    <p>TÃ©lÃ©chargez votre configuration de mapping actuelle au format JSON pour la sauvegarder ou la partager.</p>
                                    <button class="btn btn-primary" onclick="exportMapping()">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:18px;height:18px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                        TÃ©lÃ©charger mapping.json
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Footer avec stats et boutons -->
                        <div class="mapping-footer">
                            <div class="mapping-stats">
                                <div class="mapping-stat">
                                    <span class="label">PrÃ©fixes configurÃ©s</span>
                                    <span class="value" id="statPrefixes">0</span>
                                </div>
                                <div class="mapping-stat">
                                    <span class="label">Exceptions</span>
                                    <span class="value" id="statExceptions">0</span>
                                </div>
                                <div class="mapping-stat">
                                    <span class="label">Non classÃ©s</span>
                                    <span class="value" id="statUnclassified">0</span>
                                </div>
                            </div>
                            <div style="display:flex;gap:12px;">
                                <button class="btn btn-secondary" onclick="cancelMappingChanges()">Annuler les modifications</button>
                                <button class="btn btn-primary" onclick="saveMappingAndReload()">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:18px;height:18px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    Appliquer et recalculer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>
    
    </div><!-- End app-container -->

    <!-- =====================================================
         MODALES UTILISATEUR
         ===================================================== -->
    
    <!-- Modal Profil -->
    <div class="modal-overlay" id="modalProfile">
        <div class="modal">
            <div class="modal-header">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    Mon Profil
                </h2>
                <button class="modal-close" onclick="closeModal('modalProfile')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="avatar-upload">
                    <div class="avatar-preview" id="avatarPreview">SF</div>
                    <div class="avatar-actions">
                        <button class="btn btn-secondary" onclick="document.getElementById('avatarInput').click()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            Changer la photo
                        </button>
                        <input type="file" id="avatarInput" accept="image/*" hidden>
                        <span style="font-size:12px;color:var(--slate-500);">JPG, PNG. Max 2MB</span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>PrÃ©nom</label>
                        <input type="text" id="profileFirstName" value="Salif">
                    </div>
                    <div class="form-group">
                        <label>Nom</label>
                        <input type="text" id="profileLastName" value="Fall">
                    </div>
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="profileEmail" value="salif@findalyx.com">
                </div>

                <div class="form-group">
                    <label>TÃ©lÃ©phone</label>
                    <input type="tel" id="profilePhone" value="+221 77 123 45 67" placeholder="+221 XX XXX XX XX">
                </div>

                <div class="form-group">
                    <label>Entreprise</label>
                    <input type="text" id="profileCompany" value="Findalyx SARL">
                </div>

                <div class="form-group">
                    <label>Fonction</label>
                    <input type="text" id="profileRole" value="Analyste financier">
                </div>

                <div style="border-top:1px solid var(--slate-100);margin-top:24px;padding-top:24px;">
                    <h3 style="font-size:14px;font-weight:600;color:var(--slate-700);margin-bottom:16px;">Changer le mot de passe</h3>
                    <div class="form-group">
                        <label>Mot de passe actuel</label>
                        <input type="password" id="profileCurrentPwd" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nouveau mot de passe</label>
                            <input type="password" id="profileNewPwd" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        </div>
                        <div class="form-group">
                            <label>Confirmer</label>
                            <input type="password" id="profileConfirmPwd" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modalProfile')">Annuler</button>
                <button class="btn btn-primary" onclick="saveProfile()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Modal Abonnement -->
    <div class="modal-overlay" id="modalSubscription">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                    </svg>
                    Mon Abonnement
                </h2>
                <button class="modal-close" onclick="closeModal('modalSubscription')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div style="background:linear-gradient(135deg, var(--blue-50), var(--slate-50));padding:20px;border-radius:12px;margin-bottom:24px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-size:12px;color:var(--slate-500);margin-bottom:4px;">Plan actuel</div>
                            <div style="font-size:20px;font-weight:700;color:var(--blue-600);">Pro Plan</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:12px;color:var(--slate-500);margin-bottom:4px;">Prochain renouvellement</div>
                            <div style="font-size:14px;font-weight:600;color:var(--slate-700);">15 FÃ©vrier 2026</div>
                        </div>
                    </div>
                </div>

                <h3 style="font-size:14px;font-weight:600;color:var(--slate-700);margin-bottom:16px;">Changer de plan</h3>
                
                <div class="plan-cards">
                    <div class="plan-card" onclick="selectPlan('free')">
                        <div class="plan-name">Gratuit</div>
                        <div class="plan-price">0<span>/mois</span></div>
                        <ul class="plan-features">
                            <li><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> 3 analyses/mois</li>
                            <li><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Export PDF</li>
                            <li><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Support email</li>
                        </ul>
                    </div>
                    
                    <div class="plan-card active recommended" onclick="selectPlan('pro')">
                        <div class="plan-name">Pro</div>
                        <div class="plan-price">25K<span>/mois</span></div>
                        <ul class="plan-features">
                            <li><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Analyses illimitÃ©es</li>
                            <li><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Export PDF & Excel</li>
                            <li><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Multi-annÃ©es</li>
                            <li><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Support prioritaire</li>
                        </ul>
                    </div>
                    
                    <div class="plan-card" onclick="selectPlan('enterprise')">
                        <div class="plan-name">Entreprise</div>
                        <div class="plan-price">Sur devis</div>
                        <ul class="plan-features">
                            <li><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Tout Pro +</li>
                            <li><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> API access</li>
                            <li><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Multi-utilisateurs</li>
                            <li><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Support dÃ©diÃ©</li>
                        </ul>
                    </div>
                </div>

                <div style="background:var(--slate-50);padding:16px;border-radius:10px;">
                    <div style="font-size:13px;color:var(--slate-600);">
                        <strong>ðŸ’³ Moyens de paiement acceptÃ©s:</strong> Orange Money, Wave, Carte bancaire, Virement
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modalSubscription')">Fermer</button>
                <button class="btn btn-primary" onclick="upgradePlan()">Mettre Ã  niveau</button>
            </div>
        </div>
    </div>

    <!-- Modal Aide & Support -->
    <div class="modal-overlay" id="modalHelp">
        <div class="modal">
            <div class="modal-header">
                <h2>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Aide & Support
                </h2>
                <button class="modal-close" onclick="closeModal('modalHelp')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <h3 style="font-size:14px;font-weight:600;color:var(--slate-700);margin-bottom:16px;">Questions frÃ©quentes</h3>
                
                <div class="faq-item" onclick="toggleFaq(this)">
                    <div class="faq-question">
                        Comment importer ma balance comptable ?
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>
                    <div class="faq-answer">
                        <p>Exportez votre balance depuis votre logiciel comptable au format Excel (.xlsx) ou CSV. Le fichier doit contenir au minimum les colonnes: NumÃ©ro de compte, LibellÃ©, DÃ©bit et CrÃ©dit. Glissez-dÃ©posez le fichier dans la zone d'import.</p>
                    </div>
                </div>

                <div class="faq-item" onclick="toggleFaq(this)">
                    <div class="faq-question">
                        Quels formats de fichiers sont acceptÃ©s ?
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>
                    <div class="faq-answer">
                        <p>Findalyx accepte les fichiers Excel (.xlsx, .xls) et CSV. La balance doit suivre le plan comptable SYSCOHADA (OHADA). Les comptes de classe 1 Ã  8 sont automatiquement reconnus.</p>
                    </div>
                </div>

                <div class="faq-item" onclick="toggleFaq(this)">
                    <div class="faq-question">
                        Comment analyser plusieurs exercices ?
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>
                    <div class="faq-answer">
                        <p>Importez simplement plusieurs fichiers de balance. Findalyx dÃ©tecte automatiquement l'annÃ©e de chaque fichier et permet de basculer entre les exercices. La page Ã‰volution affiche les comparatifs multi-annÃ©es.</p>
                    </div>
                </div>

                <div class="faq-item" onclick="toggleFaq(this)">
                    <div class="faq-question">
                        Mes donnÃ©es sont-elles sÃ©curisÃ©es ?
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>
                    <div class="faq-answer">
                        <p>Vos donnÃ©es sont traitÃ©es localement dans votre navigateur et ne sont pas envoyÃ©es vers nos serveurs. Seules les informations de votre compte sont stockÃ©es de maniÃ¨re sÃ©curisÃ©e.</p>
                    </div>
                </div>

                <h3 style="font-size:14px;font-weight:600;color:var(--slate-700);margin:24px 0 16px;">Contactez-nous</h3>
                
                <div class="contact-options">
                    <div class="contact-card" onclick="window.open('mailto:support@findalyx.com')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        <h4>Email</h4>
                        <p>support@findalyx.com</p>
                    </div>
                    <div class="contact-card" onclick="window.open('https://wa.me/221771234567')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                        <h4>WhatsApp</h4>
                        <p>+221 77 123 45 67</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modalHelp')">Fermer</button>
            </div>
        </div>
    </div>

    <script>
        // ========== MULTI-YEAR DATA STORAGE ==========
        const yearsData = {}; // { year: financialData }
        let currentYear = null;

        // Format number with spaces (French format)
        function formatNumber(num) {
            return new Intl.NumberFormat('fr-FR').format(Math.round(num));
        }

        // Format in millions with M suffix and thousand separators
        function formatMillion(num) {
            const millions = Math.round(num / 1000000);
            return new Intl.NumberFormat('fr-FR').format(millions) + ' M';
        }

        // Format compact number with thousand separators
        function formatCompact(num) {
            if (Math.abs(num) >= 1000000000) {
                const val = num / 1000000000;
                return new Intl.NumberFormat('fr-FR', {maximumFractionDigits: 1}).format(val) + ' Mrd';
            } else if (Math.abs(num) >= 1000000) {
                const val = Math.round(num / 1000000);
                return new Intl.NumberFormat('fr-FR').format(val) + ' M';
            } else if (Math.abs(num) >= 1000) {
                const val = Math.round(num / 1000);
                return new Intl.NumberFormat('fr-FR').format(val) + ' K';
            }
            return formatNumber(num);
        }

        // Format number for tables (millions with thousand separators)
        function formatTableValue(num) {
            const millions = Math.round((num || 0) / 1000000);
            return new Intl.NumberFormat('fr-FR').format(millions);
        }

        // Init Charts
        // Handle file upload with SYSCOHADA Parser
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Try to detect year from filename
            const filenameMatch = file.name.match(/(\d{4})/);
            let detectedYear = filenameMatch ? filenameMatch[1] : new Date().getFullYear().toString();
            
            // Ask user to confirm or enter year
            const year = prompt(
                `Quelle est l'annÃ©e de cette balance comptable?\n\nFichier: ${file.name}\nAnnÃ©e dÃ©tectÃ©e: ${detectedYear}`,
                detectedYear
            );
            
            if (!year || !/^\d{4}$/.test(year)) {
                alert('Veuillez entrer une annÃ©e valide (ex: 2022)');
                return;
            }

            document.getElementById('uploadSection').innerHTML = `
                <div class="upload-icon-wrapper">
                    <svg class="animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 36px; height: 36px; color: var(--blue-600);">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                </div>
                <h3 class="upload-title animate-pulse">Analyse en cours...</h3>
                <p class="upload-subtitle">${file.name} (${year})</p>
            `;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = parseOHADABalance(e.target.result);
                    data.year = year;
                    
                    // Store in multi-year data
                    yearsData[year] = data;
                    currentYear = year;
                    window.financialData = data;
                    
                    loadFinancialData(data);
                    updateYearsBadges();
                    updateEvolutionChart();
                } catch (error) {
                    console.error('Erreur:', error);
                    alert('Erreur lors de l\'analyse du fichier: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Update years badges in the banner
        function updateYearsBadges() {
            const container = document.getElementById('yearsLoaded');
            const years = Object.keys(yearsData).sort();
            
            container.innerHTML = years.map(year => `
                <span class="year-badge ${year === currentYear ? 'active' : ''}" onclick="switchToYear('${year}')">
                    ${year}
                    <span class="remove-year" onclick="event.stopPropagation(); removeYear('${year}')" title="Supprimer">Ã—</span>
                </span>
            `).join('');
            
            document.getElementById('currentYear').textContent = currentYear;
        }

        // Switch to another year
        function switchToYear(year) {
            if (!yearsData[year]) return;
            currentYear = year;
            window.financialData = yearsData[year];
            loadFinancialData(yearsData[year]);
            updateYearsBadges();
            updateEvolutionChart();
            updatePnLComparative();
            updateEvolutionPage();
        }

        // Remove a year
        function removeYear(year) {
            if (Object.keys(yearsData).length <= 1) {
                alert('Vous devez garder au moins une annÃ©e chargÃ©e');
                return;
            }
            delete yearsData[year];
            if (currentYear === year) {
                currentYear = Object.keys(yearsData).sort().pop();
                window.financialData = yearsData[currentYear];
                loadFinancialData(yearsData[currentYear]);
            }
            updateYearsBadges();
            updateEvolutionChart();
            updatePnLComparative();
            updateEvolutionPage();
        }

        // SYSCOHADA Balance Parser - MÃ‰THODE CORRECTE
        // RÃ¨gle: Solde = DÃ©bit - CrÃ©dit
        // P&L (6,7,8): Inverser le signe du solde
        // Bilan: 2,3 = Actif | 1 = Passif | 4,5 = selon signe (positif=Actif, nÃ©gatif=Passif)
        
        function sumByPrefix(accounts, prefixes) {
            let total = 0;
            const prefixList = Array.isArray(prefixes) ? prefixes : [prefixes];
            accounts.forEach(acc => {
                for (const p of prefixList) {
                    if (acc.compte.startsWith(p)) {
                        total += acc.solde;
                        break;
                    }
                }
            });
            return total;
        }

        function parseOHADABalance(arrayBuffer) {
            const workbook = XLSX.read(arrayBuffer, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(sheet, {header: 1});
            const headers = data[0] || [];
            
            // Auto-detect columns
            let colCompte = 0, colLibelle = 1, colSD = -1, colSC = -1;
            headers.forEach((h, i) => {
                const header = String(h || '').toLowerCase();
                if (header.includes('compte') || header.includes('nÂ°') || header === 'compte') colCompte = i;
                else if (header.includes('libellÃ©') || header.includes('libelle') || header.includes('intitulÃ©')) colLibelle = i;
                else if ((header.includes('solde') && header.includes('dÃ©bit')) || header === 'solde dÃ©biteur' || header === 'dÃ©bit') colSD = i;
                else if ((header.includes('solde') && header.includes('crÃ©dit')) || header === 'solde crÃ©diteur' || header === 'crÃ©dit') colSC = i;
            });
            // Fallback positions
            if (colSD === -1) colSD = headers.length >= 7 ? 6 : headers.length - 2;
            if (colSC === -1) colSC = headers.length >= 8 ? 7 : headers.length - 1;

            // Parse accounts avec calcul du solde
            const accountsPnL = []; // Pour P&L (classes 6, 7, 8) - avec inversion
            const accountsBilan = []; // Pour Bilan (classes 1-5) - sans inversion
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (row && row[colCompte]) {
                    const compte = String(row[colCompte]).trim();
                    if (compte && /^\d+/.test(compte)) {
                        const soldeDebit = parseFloat(row[colSD]) || 0;
                        const soldeCredit = parseFloat(row[colSC]) || 0;
                        const classe = compte.charAt(0);
                        
                        // Solde brut = DÃ©bit - CrÃ©dit
                        const soldeBrut = soldeDebit - soldeCredit;
                        
                        if (['6', '7', '8'].includes(classe)) {
                            // P&L: inverser le signe
                            // CrÃ©dit > DÃ©bit â†’ soldeBrut nÃ©gatif â†’ aprÃ¨s inversion = positif (produit)
                            // DÃ©bit > CrÃ©dit â†’ soldeBrut positif â†’ aprÃ¨s inversion = nÃ©gatif (charge)
                            accountsPnL.push({
                                compte,
                                libelle: String(row[colLibelle] || ''),
                                solde: -soldeBrut, // Inversion du signe
                                classe
                            });
                        } else {
                            // Bilan: garder le solde tel quel
                            accountsBilan.push({
                                compte,
                                libelle: String(row[colLibelle] || ''),
                                solde: soldeBrut,
                                classe
                            });
                        }
                    }
                }
            }
            
            console.log('Comptes P&L:', accountsPnL.length, 'Comptes Bilan:', accountsBilan.length);

            // === P&L SYSCOHADA ===
            // Avec l'inversion: produits sont positifs, charges sont nÃ©gatives
            
            // CHIFFRE D'AFFAIRES (70 uniquement)
            const ca = sumByPrefix(accountsPnL, '70');
            
            // ACHATS ET VARIATIONS DE STOCKS (compte 60)
            // AprÃ¨s inversion: nÃ©gatif = achats, positif = variation de stocks
            let achats = 0;
            let varStocks = 0;
            accountsPnL.filter(a => a.compte.startsWith('60')).forEach(acc => {
                if (acc.solde < 0) {
                    achats += Math.abs(acc.solde); // Charges (nÃ©gatif aprÃ¨s inversion)
                } else {
                    varStocks += acc.solde; // Variation de stocks (positif aprÃ¨s inversion)
                }
            });
            
            // MARGE BRUTE = CA - Achats + Variation de stocks
            const margeBrute = ca - achats + varStocks;
            
            // CHARGES D'EXPLOITATION (toujours nÃ©gatifs aprÃ¨s inversion, on prend |valeur|)
            const transports = Math.abs(sumByPrefix(accountsPnL, '61'));
            const servicesExt = Math.abs(sumByPrefix(accountsPnL, '62'));
            const autresServices = Math.abs(sumByPrefix(accountsPnL, '63'));
            const impotsTaxes = Math.abs(sumByPrefix(accountsPnL, '64'));
            const autresCharges = Math.abs(sumByPrefix(accountsPnL, '65'));
            const personnel = Math.abs(sumByPrefix(accountsPnL, '66'));
            const opex = transports + servicesExt + autresServices + impotsTaxes + autresCharges + personnel;
            
            // EBITDA
            const ebitda = margeBrute - opex;
            
            // Autres produits d'exploitation (75)
            const autresProduits = sumByPrefix(accountsPnL, '75');
            
            // DOTATIONS (68 + 69 combinÃ©s)
            const dotations = Math.abs(sumByPrefix(accountsPnL, ['68', '69']));
            
            // REPRISES (79)
            const reprises = sumByPrefix(accountsPnL, '79'); // Positif (produit)
            
            // EBIT (RÃ©sultat d'exploitation)
            const ebit = ebitda + autresProduits - dotations + reprises;
            
            // RÃ‰SULTAT FINANCIER
            const prodFin = sumByPrefix(accountsPnL, '77'); // Positif (produit)
            const chgFin = Math.abs(sumByPrefix(accountsPnL, '67')); // NÃ©gatif â†’ valeur absolue
            const resultatFin = prodFin - chgFin;
            
            // RÃ‰SULTAT HAO (Hors ActivitÃ©s Ordinaires)
            const prodHAO = sumByPrefix(accountsPnL, ['82', '84', '86', '88']);
            const chgHAO = Math.abs(sumByPrefix(accountsPnL, ['81', '83', '85', '87']));
            const resultatHAO = prodHAO - chgHAO;
            
            // IMPÃ”T BIC
            const impotBIC = Math.abs(sumByPrefix(accountsPnL, '89'));
            
            // RÃ‰SULTAT NET
            const resultatNet = ebit + resultatFin + resultatHAO - impotBIC;

            console.log('=== P&L SYSCOHADA ===');
            console.log('CA (70):', ca / 1000000, 'M');
            console.log('Achats (60 nÃ©gatifs):', achats / 1000000, 'M');
            console.log('Var Stocks (60 positifs):', varStocks / 1000000, 'M');
            console.log('Marge Brute:', margeBrute / 1000000, 'M');
            console.log('OPEX:', opex / 1000000, 'M');
            console.log('EBITDA:', ebitda / 1000000, 'M');
            console.log('Autres produits (75):', autresProduits / 1000000, 'M');
            console.log('Dotations (68+69):', dotations / 1000000, 'M');
            console.log('Reprises (79):', reprises / 1000000, 'M');
            console.log('EBIT:', ebit / 1000000, 'M');
            console.log('Produits fin (77):', prodFin / 1000000, 'M');
            console.log('Charges fin (67):', chgFin / 1000000, 'M');
            console.log('RÃ©sultat Financier:', resultatFin / 1000000, 'M');
            console.log('RÃ©sultat HAO:', resultatHAO / 1000000, 'M');
            console.log('ImpÃ´t BIC (89):', impotBIC / 1000000, 'M');
            console.log('RÃ‰SULTAT NET:', resultatNet / 1000000, 'M');
            console.log('=====================');

            // === BILAN SYSCOHADA ===
            // Classes 2 et 3: toujours ACTIF
            // Classe 1: toujours PASSIF
            // Classes 4 et 5: selon le signe du solde
            
            // ACTIF IMMOBILISÃ‰ (classe 2)
            // Valeurs brutes (d'origine) - solde dÃ©biteur
            const immoIncorpBrut = accountsBilan.filter(a => a.compte.startsWith('21')).reduce((s, a) => s + Math.max(0, a.solde), 0);
            const immoCorpBrut = accountsBilan.filter(a => ['22', '23', '24'].some(p => a.compte.startsWith(p))).reduce((s, a) => s + Math.max(0, a.solde), 0);
            const immoFinBrut = accountsBilan.filter(a => ['25', '26', '27'].some(p => a.compte.startsWith(p))).reduce((s, a) => s + Math.max(0, a.solde), 0);
            
            // Amortissements cumulÃ©s (compte 28) - solde crÃ©diteur donc nÃ©gatif
            const amortIncorp = accountsBilan.filter(a => a.compte.startsWith('281')).reduce((s, a) => s + Math.abs(a.solde), 0);
            const amortCorp = accountsBilan.filter(a => ['282', '283', '284'].some(p => a.compte.startsWith(p))).reduce((s, a) => s + Math.abs(a.solde), 0);
            // Pas d'amortissement pour les immo financiÃ¨res
            
            // Provisions pour dÃ©prÃ©ciation (compte 29) - solde crÃ©diteur donc nÃ©gatif
            const provIncorp = accountsBilan.filter(a => a.compte.startsWith('291')).reduce((s, a) => s + Math.abs(a.solde), 0);
            const provCorp = accountsBilan.filter(a => ['292', '293', '294'].some(p => a.compte.startsWith(p))).reduce((s, a) => s + Math.abs(a.solde), 0);
            const provFin = accountsBilan.filter(a => ['295', '296', '297'].some(p => a.compte.startsWith(p))).reduce((s, a) => s + Math.abs(a.solde), 0);
            
            // Valeurs nettes
            const immoIncorp = immoIncorpBrut - amortIncorp - provIncorp;
            const immoCorp = immoCorpBrut - amortCorp - provCorp;
            const immoFin = immoFinBrut - provFin; // Pas d'amortissement pour les immo financiÃ¨res
            
            // Totaux pour affichage
            const amortissements = amortIncorp + amortCorp;
            const provisions29 = provIncorp + provCorp + provFin;
            const immoNet = immoIncorp + immoCorp + immoFin;
            
            console.log('=== IMMOBILISATIONS ===');
            console.log('Immo Incorp Brut:', immoIncorpBrut / 1000000, 'M - Amort:', amortIncorp / 1000000, 'M - Prov:', provIncorp / 1000000, 'M - Net:', immoIncorp / 1000000, 'M');
            console.log('Immo Corp Brut:', immoCorpBrut / 1000000, 'M - Amort:', amortCorp / 1000000, 'M - Prov:', provCorp / 1000000, 'M - Net:', immoCorp / 1000000, 'M');
            console.log('Immo Fin Brut:', immoFinBrut / 1000000, 'M - Prov:', provFin / 1000000, 'M - Net:', immoFin / 1000000, 'M');
            console.log('Total Immo Net:', immoNet / 1000000, 'M');
            console.log('=======================');
            
            // ACTIF CIRCULANT
            // Stocks = tout le compte 3 (solde net)
            const stocks = accountsBilan.filter(a => a.compte.startsWith('3')).reduce((s, a) => s + a.solde, 0);

            // Classe 4: Actif si solde > 0 (on verra les dÃ©tails aprÃ¨s)
            const clients = accountsBilan.filter(a => a.compte.startsWith('41') && a.solde > 0).reduce((s, a) => s + a.solde, 0);
            const autresCreancesActif = accountsBilan.filter(a => 
                ['40', '42', '43', '44', '45', '46', '47', '48', '49'].some(p => a.compte.startsWith(p)) && a.solde > 0
            ).reduce((s, a) => s + a.solde, 0);
            const actifCirculant = stocks + clients + autresCreancesActif;
            
            // TRÃ‰SORERIE (classe 5)
            // Solde net du compte 5
            const tresoNette = accountsBilan.filter(a => a.compte.startsWith('5')).reduce((s, a) => s + a.solde, 0);
            const tresoActif = Math.max(0, tresoNette); // Si positif = actif
            const tresoPassif = Math.abs(Math.min(0, tresoNette)); // Si nÃ©gatif = passif
            const banques = accountsBilan.filter(a => a.compte.startsWith('52')).reduce((s, a) => s + a.solde, 0);
            const caisse = accountsBilan.filter(a => a.compte.startsWith('57')).reduce((s, a) => s + a.solde, 0);
            
            const totalActif = immoNet + actifCirculant + tresoActif;

            // PASSIF (classe 1)
            // Capital social = 10
            const capital = accountsBilan.filter(a => a.compte.startsWith('10')).reduce((s, a) => s + Math.abs(a.solde), 0);
            // RÃ©serves = 11
            const reserves = accountsBilan.filter(a => a.compte.startsWith('11')).reduce((s, a) => s + Math.abs(a.solde), 0);
            // Report Ã  nouveau = 12 + 13 + RÃ©sultat Net (combinÃ©s)
            const reportAN12 = accountsBilan.filter(a => a.compte.startsWith('12')).reduce((s, a) => s - a.solde, 0);
            const resultatInstance = accountsBilan.filter(a => a.compte.startsWith('13')).reduce((s, a) => s - a.solde, 0);
            const reportAN = reportAN12 + resultatInstance + resultatNet; // CombinÃ©
            // Subventions = 14
            const subventions = accountsBilan.filter(a => a.compte.startsWith('14')).reduce((s, a) => s + Math.abs(a.solde), 0);
            // Provisions rÃ©glementÃ©es = 15
            const provisionsRegl = accountsBilan.filter(a => a.compte.startsWith('15')).reduce((s, a) => s + Math.abs(a.solde), 0);
            
            const capitauxPropres = capital + reserves + reportAN + subventions + provisionsRegl;
            
            // DETTES FINANCIÃˆRES
            // Emprunts = 16
            const emprunts = accountsBilan.filter(a => a.compte.startsWith('16')).reduce((s, a) => s + Math.abs(a.solde), 0);
            // Autres dettes financiÃ¨res = 17 + 18
            const autresDetteFin = accountsBilan.filter(a => ['17', '18'].some(p => a.compte.startsWith(p))).reduce((s, a) => s + Math.abs(a.solde), 0);
            // Provisions pour risques et charges = 19 (ligne sÃ©parÃ©e)
            const provisionsRisques = accountsBilan.filter(a => a.compte.startsWith('19')).reduce((s, a) => s + Math.abs(a.solde), 0);
            
            const totalDetteFin = emprunts + autresDetteFin;
            
            // PASSIF CIRCULANT (classe 4 si solde < 0)
            const fournisseurs = accountsBilan.filter(a => a.compte.startsWith('40') && a.solde < 0).reduce((s, a) => s + Math.abs(a.solde), 0);
            const dettesFiscales = accountsBilan.filter(a => a.compte.startsWith('44') && a.solde < 0).reduce((s, a) => s + Math.abs(a.solde), 0);
            const dettesSociales = accountsBilan.filter(a => ['42', '43'].some(p => a.compte.startsWith(p)) && a.solde < 0).reduce((s, a) => s + Math.abs(a.solde), 0);
            const autresDettes = accountsBilan.filter(a => 
                ['41', '45', '46', '47', '48', '49'].some(p => a.compte.startsWith(p)) && a.solde < 0
            ).reduce((s, a) => s + Math.abs(a.solde), 0);
            
            const passifCirculant = fournisseurs + dettesFiscales + dettesSociales + autresDettes + tresoPassif;
            
            const totalPassif = capitauxPropres + totalDetteFin + provisionsRisques + passifCirculant;
            
            const netDebt = totalDetteFin - tresoActif;

            console.log('=== BILAN ===');
            console.log('Stocks:', stocks / 1000000, 'M');
            console.log('Clients:', clients / 1000000, 'M');
            console.log('Autres crÃ©ances:', autresCreancesActif / 1000000, 'M');
            console.log('TrÃ©so nette:', tresoNette / 1000000, 'M (Actif:', tresoActif / 1000000, 'M, Passif:', tresoPassif / 1000000, 'M)');
            console.log('Capital:', capital / 1000000, 'M');
            console.log('RÃ©serves:', reserves / 1000000, 'M');
            console.log('Report AN:', reportAN / 1000000, 'M');
            console.log('RÃ©sultat instance:', resultatInstance / 1000000, 'M');
            console.log('Emprunts:', emprunts / 1000000, 'M');
            console.log('Autres dettes fin:', autresDetteFin / 1000000, 'M');
            console.log('Provisions risques (19):', provisionsRisques / 1000000, 'M');
            console.log('Total Actif:', totalActif / 1000000, 'M');
            console.log('Total Passif:', totalPassif / 1000000, 'M');
            console.log('Ã‰cart:', (totalActif - totalPassif) / 1000000, 'M');
            console.log('=============');

            // === RATIOS ===
            const margeEbitda = ca ? (ebitda / ca * 100) : 0;
            const margeBrutePct = ca ? (margeBrute / ca * 100) : 0;
            const margeNette = ca ? (resultatNet / ca * 100) : 0;
            const roe = capitauxPropres ? (resultatNet / capitauxPropres * 100) : 0;
            const roi = totalActif ? (resultatNet / totalActif * 100) : 0;
            const currentRatio = passifCirculant ? ((actifCirculant + tresoActif) / passifCirculant) : 0;
            const quickRatio = passifCirculant ? ((clients + tresoActif) / passifCirculant) : 0;
            const bfr = actifCirculant - passifCirculant;
            const bfrJours = ca ? Math.round(bfr / ca * 365) : 0;
            const netDebtEbitda = ebitda ? (netDebt / ebitda) : 0;

            // === CASH FLOW (mÃ©thode indirecte) ===
            const caf = resultatNet + dotations - reprises;
            const varBFR = 0; // NÃ©cessite N-1 pour calculer
            const fluxExploitation = caf - varBFR;

            return {
                // P&L
                ca, achats, varStocks, margeBrute, autresProduits,
                transports, servicesExt, autresServices, impotsTaxes, autresCharges, personnel, opex,
                ebitda, dotations, reprises, ebit,
                prodFin, chgFin, resultatFin,
                prodHAO, chgHAO, resultatHAO,
                impotBIC, resultatNet,
                // Actif
                immoIncorp, immoCorp, immoFin, amortissements, provisions: provisions29, immoNet,
                stocks, clients, autresCreances: autresCreancesActif, actifCirculant,
                banques, caisse, tresoActif, totalActif,
                // Passif
                capital, reserves, reportAN, resultatInstance, capitauxPropres,
                emprunts, autresDetteFin, totalDetteFin, provisionsRisques,
                fournisseurs, dettesFiscales, dettesSociales, autresDettes, tresoPassif, passifCirculant,
                totalPassif, netDebt,
                // Ratios
                margeEbitda, margeBrutePct, margeNette, roe, roi, currentRatio, quickRatio, bfr, bfrJours, netDebtEbitda,
                // Cash Flow
                caf, fluxExploitation
            };
        }

        // Load financial data from parser
        function loadFinancialData(data) {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';

            const M = n => Math.round((n || 0) / 1000000);
            const Mrd = n => (n / 1000000000).toFixed(1);

            // Update year display
            if (data.year) {
                document.getElementById('currentYear').textContent = data.year;
            }

            // Format helpers
            const fmtPct = n => new Intl.NumberFormat('fr-FR', {maximumFractionDigits: 1}).format(n) + '%';
            const fmtRatio = n => new Intl.NumberFormat('fr-FR', {maximumFractionDigits: 2}).format(n);

            // Stats
            document.getElementById('statRevenue').textContent = formatCompact(data.ca);
            document.getElementById('statEBITDA').textContent = formatCompact(data.ebitda);
            document.getElementById('statNetIncome').textContent = formatCompact(data.resultatNet);
            document.getElementById('statMargin').textContent = fmtPct(data.margeEbitda);

            // Calculer les variations par rapport Ã  l'annÃ©e prÃ©cÃ©dente de l'annÃ©e sÃ©lectionnÃ©e
            const years = Object.keys(yearsData).sort();
            const currentIdx = years.indexOf(data.year);
            
            if (currentIdx > 0) {
                // Il existe une annÃ©e prÃ©cÃ©dente
                const prevYear = years[currentIdx - 1];
                const prevData = yearsData[prevYear];
                updateTrend('trendCA', prevData.ca, data.ca);
                updateTrend('trendEBITDA', prevData.ebitda, data.ebitda);
                updateTrend('trendNet', prevData.resultatNet, data.resultatNet);
            } else {
                // Pas d'annÃ©e prÃ©cÃ©dente - masquer les variations
                clearTrend('trendCA');
                clearTrend('trendEBITDA');
                clearTrend('trendNet');
            }

            // Ratios compacts
            document.getElementById('ratioROE').textContent = fmtPct(data.roe);
            document.getElementById('ratioROI').textContent = fmtPct(data.roi);
            document.getElementById('ratioMargeBrute').textContent = fmtPct(data.margeBrutePct);
            document.getElementById('ratioCurrent').textContent = fmtRatio(data.currentRatio);
            document.getElementById('ratioQuick').textContent = fmtRatio(data.quickRatio);
            document.getElementById('ratioBFR').textContent = data.bfrJours + 'j';

            // Update ratio statuses
            updateRatioStatus('statusROE', data.roe > 10);
            updateRatioStatus('statusROI', data.roi > 5);
            updateRatioStatus('statusMargeBrute', data.margeBrutePct > 20);
            updateRatioStatus('statusCurrent', data.currentRatio > 1);
            updateRatioStatus('statusQuick', data.quickRatio > 0.8);
            updateRatioStatus('statusBFR', data.bfrJours < 60);

            // Initialize new charts
            initDashboardCharts(data);
            updateDetailPages(data);
            
            // === NOUVELLES FONCTIONNALITÃ‰S ===
            // Scoring financier
            const score = calculateFinancialScore(data);
            updateScoringDisplay(score);
            
            // Commentaires IA
            const insights = generateAIInsights(data);
            updateAIInsightsDisplay(insights);
            
            // PrÃ©visions N+1
            const forecasts = calculateForecasts(yearsData);
            updateForecastDisplay(forecasts);
            
            // Objectifs et alertes
            checkCriticalRatios(data);
            
            console.log('DonnÃ©es chargÃ©es:', data);
        }

        // Clear trend display
        function clearTrend(elementId) {
            const el = document.getElementById(elementId);
            if (el) {
                el.className = 'stat-trend';
                el.style.display = 'none';
            }
        }

        function updateRatioStatus(elementId, isGood) {
            const el = document.getElementById(elementId);
            if (el) {
                el.className = 'ratio-status ' + (isGood ? 'good' : 'warning');
            }
        }

        // Initialize dashboard charts
        function initDashboardCharts(data) {
            const M = n => Math.round((n || 0) / 1000000);
            const Mrd = n => parseFloat((n / 1000000000).toFixed(2));

            // Destroy existing charts
            Chart.helpers.each(Chart.instances, (instance) => instance.destroy());

            // Common donut options with percentage display
            const donutOptions = {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { 
                            padding: 10,
                            usePointStyle: true,
                            font: { size: 10 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const pct = ((context.raw / total) * 100).toFixed(1);
                                const montant = new Intl.NumberFormat('fr-FR').format(context.raw);
                                return context.label + ': ' + montant + ' M (' + pct + '%)';
                            }
                        }
                    },
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        formatter: (value, ctx) => {
                            const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                            const pct = ((value / total) * 100).toFixed(0);
                            return pct > 5 ? pct + '%' : '';
                        }
                    }
                }
            };

            // 1. Structure des charges (Donut)
            const chargesCtx = document.getElementById('chargesDonutChart');
            if (chargesCtx) {
                const chargesData = [
                    M(data.achats),
                    M(data.personnel),
                    M(data.servicesExt + data.autresServices),
                    M(data.transports),
                    M(data.autresCharges + data.impotsTaxes)
                ];
                new Chart(chargesCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Achats', 'Personnel', 'Services ext.', 'Transports', 'Autres'],
                        datasets: [{
                            data: chargesData,
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'],
                            borderWidth: 0
                        }]
                    },
                    options: donutOptions,
                    plugins: [ChartDataLabels]
                });
            }

            // 2. Structure Actif (Donut)
            const actifCtx = document.getElementById('actifDonutChart');
            if (actifCtx) {
                new Chart(actifCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Immobilisations', 'Stocks', 'CrÃ©ances', 'TrÃ©sorerie'],
                        datasets: [{
                            data: [
                                M(data.immoNet),
                                M(data.stocks),
                                M(data.clients + data.autresCreances),
                                M(data.tresoActif)
                            ],
                            backgroundColor: ['#1e40af', '#3b82f6', '#60a5fa', '#93c5fd'],
                            borderWidth: 0
                        }]
                    },
                    options: donutOptions,
                    plugins: [ChartDataLabels]
                });
            }

            // 3. Structure Passif (Donut)
            const passifCtx = document.getElementById('passifDonutChart');
            if (passifCtx) {
                new Chart(passifCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Capitaux propres', 'Dettes fin.', 'Fournisseurs', 'Autres dettes'],
                        datasets: [{
                            data: [
                                M(data.capitauxPropres),
                                M(data.totalDetteFin),
                                M(data.fournisseurs),
                                M(data.passifCirculant - data.fournisseurs)
                            ],
                            backgroundColor: ['#059669', '#10b981', '#34d399', '#6ee7b7'],
                            borderWidth: 0
                        }]
                    },
                    options: donutOptions,
                    plugins: [ChartDataLabels]
                });
            }

            // 4. Bridge Chart (Waterfall - Formation du RÃ©sultat Net)
            const bridgeCtx = document.getElementById('bridgeChart');
            if (bridgeCtx) {
                // Calculate bridge values
                const ca = Mrd(data.ca);
                const achats = Mrd(data.achats);
                const margeBrute = Mrd(data.margeBrute);
                const opex = Mrd(data.opex);
                const ebitda = Mrd(data.ebitda);
                const dotations = Mrd(data.dotations);
                const resultatFin = Mrd(data.resultatFin);
                const impots = Mrd(data.impotBIC);
                const resultatNet = Mrd(data.resultatNet);

                // For waterfall effect, we use floating bars
                const labels = ['CA', 'Achats', 'Marge Brute', 'Charges OpÃ©r.', 'EBITDA', 'Amort.', 'RÃ©s. Fin.', 'ImpÃ´ts', 'RÃ©sultat Net'];
                
                // Calculate running totals for waterfall
                let running = 0;
                const waterfallData = [];
                const colors = [];
                
                // CA (starting point)
                waterfallData.push([0, ca]);
                colors.push('#3b82f6');
                running = ca;
                
                // Achats (negative)
                waterfallData.push([running - achats, running]);
                colors.push('#ef4444');
                running = running - achats;
                
                // Marge Brute (subtotal)
                waterfallData.push([0, margeBrute]);
                colors.push('#10b981');
                running = margeBrute;
                
                // Charges OpÃ©rationnelles (negative)
                waterfallData.push([running - opex, running]);
                colors.push('#ef4444');
                running = running - opex;
                
                // EBITDA (subtotal)
                waterfallData.push([0, ebitda]);
                colors.push('#10b981');
                running = ebitda;
                
                // Amortissements (negative)
                waterfallData.push([running - dotations, running]);
                colors.push('#f59e0b');
                running = running - dotations;
                
                // RÃ©sultat Financier
                if (resultatFin >= 0) {
                    waterfallData.push([running, running + resultatFin]);
                    colors.push('#10b981');
                } else {
                    waterfallData.push([running + resultatFin, running]);
                    colors.push('#ef4444');
                }
                running = running + resultatFin;
                
                // ImpÃ´ts (negative)
                waterfallData.push([running - impots, running]);
                colors.push('#ef4444');
                running = running - impots;
                
                // RÃ©sultat Net (final)
                waterfallData.push([0, resultatNet]);
                colors.push(resultatNet >= 0 ? '#059669' : '#dc2626');

                new Chart(bridgeCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: waterfallData,
                            backgroundColor: colors,
                            borderRadius: 4,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(ctx) {
                                        const val = Array.isArray(ctx.raw) ? (ctx.raw[1] - ctx.raw[0]) : ctx.raw;
                                        return Math.abs(val).toFixed(1) + ' Mrd FCFA';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { 
                                    font: { size: 10 },
                                    maxRotation: 45
                                }
                            },
                            y: {
                                grid: { color: '#f1f5f9' },
                                ticks: {
                                    callback: v => v + ' Mrd'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Update evolution chart when multiple years are loaded
        function updateEvolutionChart() {
            const years = Object.keys(yearsData).sort();
            
            if (years.length < 2) {
                document.getElementById('evolutionChartContainer').style.display = 'none';
                document.getElementById('noEvolutionData').style.display = 'flex';
                document.getElementById('evolutionSubtitle').textContent = 'Chargez plusieurs annÃ©es pour voir l\'Ã©volution';
                return;
            }

            document.getElementById('evolutionChartContainer').style.display = 'block';
            document.getElementById('noEvolutionData').style.display = 'none';
            document.getElementById('evolutionSubtitle').textContent = `Comparaison ${years[0]} - ${years[years.length-1]}`;

            const Mrd = n => parseFloat(((n || 0) / 1000000000).toFixed(2));

            const caData = years.map(y => Mrd(yearsData[y].ca));
            const ebitdaData = years.map(y => Mrd(yearsData[y].ebitda));
            const netData = years.map(y => Mrd(yearsData[y].resultatNet));

            // Calculate trends
            if (years.length >= 2) {
                const prevYear = years[years.length - 2];
                const currYear = years[years.length - 1];
                const prev = yearsData[prevYear];
                const curr = yearsData[currYear];

                updateTrend('trendCA', prev.ca, curr.ca);
                updateTrend('trendEBITDA', prev.ebitda, curr.ebitda);
                updateTrend('trendNet', prev.resultatNet, curr.resultatNet);
            }

            const evolutionCtx = document.getElementById('evolutionBarChart');
            if (evolutionCtx) {
                // Destroy existing chart
                const existingChart = Chart.getChart(evolutionCtx);
                if (existingChart) existingChart.destroy();

                new Chart(evolutionCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: years,
                        datasets: [
                            {
                                label: 'Chiffre d\'affaires',
                                data: caData,
                                backgroundColor: '#3b82f6',
                                borderRadius: 6
                            },
                            {
                                label: 'EBITDA',
                                data: ebitdaData,
                                backgroundColor: '#10b981',
                                borderRadius: 6
                            },
                            {
                                label: 'RÃ©sultat Net',
                                data: netData,
                                backgroundColor: '#8b5cf6',
                                borderRadius: 6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                align: 'end'
                            },
                            tooltip: {
                                callbacks: {
                                    label: ctx => ctx.dataset.label + ': ' + ctx.raw + ' Mrd FCFA'
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: v => v + ' Mrd'
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateTrend(elementId, oldValue, newValue) {
            const el = document.getElementById(elementId);
            if (!el) return;
            
            if (!oldValue || oldValue === 0) {
                el.style.display = 'none';
                return;
            }
            
            el.style.display = 'flex';
            const pct = ((newValue - oldValue) / Math.abs(oldValue) * 100).toFixed(1);
            const isUp = newValue >= oldValue;
            
            el.className = 'stat-trend ' + (isUp ? 'up' : 'down');
            el.innerHTML = `
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isUp ? 'M5 10l7-7m0 0l7 7m-7-7v18' : 'M19 14l-7 7m0 0l-7-7m7 7V3'}"/>
                </svg>
                <span>${isUp ? '+' : ''}${pct}%</span>
            `;
        }

        // Drag and drop
        const uploadSection = document.getElementById('uploadSection');
        
        if (uploadSection) {
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });

            uploadSection.addEventListener('dragleave', () => {
                uploadSection.classList.remove('dragover');
            });

            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) {
                    document.getElementById('fileInput').files = e.dataTransfer.files;
                    handleFileUpload({ target: { files: [file] } });
                }
            });

            uploadSection.addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });
        }

        // ========== NAVIGATION SYSTEM ==========
        const pageNames = {
            'dashboard': 'Tableau de bord',
            'pnl': 'Compte de rÃ©sultat',
            'bilan': 'Bilan',
            'cashflow': 'Cash Flow',
            'ratios': 'Ratios financiers',
            'evolution': 'Ã‰volution',
            'import': 'Importer donnÃ©es',
            'settings': 'Configuration'
        };

        const pageMapping = {
            'dashboard': 'pageDashboard',
            'pnl': 'pagePnL',
            'bilan': 'pageBilan',
            'cashflow': 'pageCashflow',
            'ratios': 'pageRatios',
            'evolution': 'pageEvolution',
            'import': 'pageImport',
            'settings': 'pageSettings'
        };

        function navigateTo(page) {
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const activeNav = document.querySelector('.nav-item[data-page="' + page + '"]');
            if (activeNav) activeNav.classList.add('active');

            // Update breadcrumb
            document.querySelector('.breadcrumb-current').textContent = pageNames[page] || page;

            // Hide all page sections
            document.querySelectorAll('.page-section').forEach(p => p.style.display = 'none');

            // Show selected page with animation
            const pageId = pageMapping[page];
            if (pageId) {
                const pageElement = document.getElementById(pageId);
                if (pageElement) {
                    pageElement.style.display = 'block';
                    pageElement.style.animation = 'none';
                    pageElement.offsetHeight; // Trigger reflow
                    pageElement.style.animation = 'fadeInUp 0.4s ease-out forwards';
                }
            }
        }

        // Attach navigation to all nav items
        document.querySelectorAll('.nav-item[data-page]').forEach(item => {
            item.addEventListener('click', () => {
                navigateTo(item.dataset.page);
            });
        });

        // ========== UPDATE DETAIL PAGES ==========
        function updateDetailPages(data) {
            if (!data) return;
            const M = n => Math.round((n || 0) / 1000000);
            const fmt = n => new Intl.NumberFormat('fr-FR').format(n);

            // P&L Comparatif - Check if we have 2+ years
            updatePnLComparative();

            // Bilan Comparatif
            updateBilanComparative();

            // Cash Flow - Complet avec variations
            updateCashFlow();

            // Ratios Page - Detailed by category
            updateRatiosPage(data);

            // Check bilan equilibre
            checkBilanEquilibre(data);

            // Evolution Chart (old - kept for compatibility)
            initEvolutionChart(data);
        }

        // ========== UPDATE BILAN COMPARATIVE ==========
        function updateBilanComparative() {
            const years = Object.keys(yearsData).sort();
            if (years.length === 0) return;

            const yearN = currentYear || years[years.length - 1];
            const yearN1Index = years.indexOf(yearN) - 1;
            const yearN1 = yearN1Index >= 0 ? years[yearN1Index] : null;
            
            const dataN = yearsData[yearN];
            const dataN1 = yearN1 ? yearsData[yearN1] : null;
            const hasN1 = dataN1 !== null;

            const M = n => Math.round((n || 0) / 1000000);
            const fmt = n => new Intl.NumberFormat('fr-FR').format(n);
            const fmtVar = (n, n1) => {
                if (n1 === null || n1 === undefined || n1 === 0) return '-';
                const pct = ((n - n1) / Math.abs(n1)) * 100;
                const sign = pct >= 0 ? '+' : '';
                return sign + pct.toFixed(1) + '%';
            };
            const varClass = (n, n1) => {
                if (n1 === null || n1 === undefined || n1 === 0) return '';
                return n >= n1 ? 'var-positive' : 'var-negative';
            };

            // Update subtitle
            if (hasN1) {
                document.getElementById('bilanComparisonSubtitle').style.display = 'block';
                document.getElementById('bilanComparisonSubtitle').textContent = `Comparaison ${yearN1} â†’ ${yearN}`;
            } else {
                document.getElementById('bilanComparisonSubtitle').style.display = 'none';
            }

            // Update headers - 3 colonnes si comparaison : N-1, N, Var %
            const actifHead = hasN1 
                ? `<tr><th>LibellÃ©</th><th style="text-align:right;">${yearN1}</th><th style="text-align:right;">${yearN}</th><th style="text-align:right;">Var %</th></tr>`
                : `<tr><th>LibellÃ©</th><th style="text-align:right;">Montant</th></tr>`;
            const passifHead = hasN1 
                ? `<tr><th>LibellÃ©</th><th style="text-align:right;">${yearN1}</th><th style="text-align:right;">${yearN}</th><th style="text-align:right;">Var %</th></tr>`
                : `<tr><th>LibellÃ©</th><th style="text-align:right;">Montant</th></tr>`;
            
            document.getElementById('actifTableHead').innerHTML = actifHead;
            document.getElementById('passifTableHead').innerHTML = passifHead;

            // Actif rows
            const actifRows = [
                { label: "ACTIF IMMOBILISÃ‰", key: 'immoNet', highlight: true },
                { label: "Immo. incorporelles", key: 'immoIncorp', indent: true },
                { label: "Immo. corporelles", key: 'immoCorp', indent: true },
                { label: "Immo. financiÃ¨res", key: 'immoFin', indent: true },
                { label: "ACTIF CIRCULANT", key: 'actifCirculant', highlight: true },
                { label: "Stocks", key: 'stocks', indent: true },
                { label: "Clients", key: 'clients', indent: true },
                { label: "Autres crÃ©ances", key: 'autresCreances', indent: true },
                { label: "TRÃ‰SORERIE ACTIF", key: 'tresoActif', highlight: true },
                { label: "Banques", key: 'banques', indent: true },
                { label: "Caisse", key: 'caisse', indent: true },
                { label: "", key: null, empty: true },
                { label: "", key: null, empty: true },
                { label: "TOTAL ACTIF", key: 'totalActif', total: true }
            ];

            // Passif rows
            const passifRows = [
                { label: "CAPITAUX PROPRES", key: 'capitauxPropres', highlight: true },
                { label: "Capital social", key: 'capital', indent: true },
                { label: "RÃ©serves", key: 'reserves', indent: true },
                { label: "Report Ã  nouveau", key: 'reportAN', indent: true },
                { label: "DETTES FINANCIÃˆRES", key: 'totalDetteFin', highlight: true },
                { label: "Emprunts", key: 'emprunts', indent: true },
                { label: "Autres dettes fin.", key: 'autresDetteFin', indent: true },
                { label: "PROVISIONS RISQUES", key: 'provisionsRisques', highlight: true },
                { label: "PASSIF CIRCULANT", key: 'passifCirculant', highlight: true },
                { label: "Fournisseurs", key: 'fournisseurs', indent: true },
                { label: "Dettes fiscales", key: 'dettesFiscales', indent: true },
                { label: "Dettes sociales", key: 'dettesSociales', indent: true },
                { label: "Autres dettes", key: 'autresDettes', indent: true },
                { label: "TOTAL PASSIF", key: 'totalPassif', total: true }
            ];

            // Generate Actif HTML
            let actifHtml = '';
            actifRows.forEach(r => {
                if (r.empty) {
                    const cols = hasN1 ? 4 : 2;
                    actifHtml += `<tr class="empty-row">${'<td></td>'.repeat(cols)}</tr>`;
                } else {
                    const valN = M(dataN[r.key]);
                    const valN1 = dataN1 ? M(dataN1[r.key]) : null;
                    const rowClass = r.highlight ? 'highlight' : (r.total ? 'total' : '');
                    if (hasN1) {
                        actifHtml += `<tr class="${rowClass}">
                            <td class="${r.indent ? 'indent' : ''}">${r.label}</td>
                            <td style="text-align:right;">${fmt(valN1)}</td>
                            <td style="text-align:right;">${fmt(valN)}</td>
                            <td style="text-align:right;" class="${varClass(valN, valN1)}">${fmtVar(valN, valN1)}</td>
                        </tr>`;
                    } else {
                        actifHtml += `<tr class="${rowClass}">
                            <td class="${r.indent ? 'indent' : ''}">${r.label}</td>
                            <td style="text-align:right;">${fmt(valN)}</td>
                        </tr>`;
                    }
                }
            });
            document.getElementById('actifDetailBody').innerHTML = actifHtml;

            // Generate Passif HTML
            let passifHtml = '';
            passifRows.forEach(r => {
                if (r.empty) {
                    const cols = hasN1 ? 4 : 2;
                    passifHtml += `<tr class="empty-row">${'<td></td>'.repeat(cols)}</tr>`;
                } else {
                    const valN = M(dataN[r.key]);
                    const valN1 = dataN1 ? M(dataN1[r.key]) : null;
                    const rowClass = r.highlight ? 'highlight' : (r.total ? 'total' : '');
                    if (hasN1) {
                        passifHtml += `<tr class="${rowClass}">
                            <td class="${r.indent ? 'indent' : ''}">${r.label}</td>
                            <td style="text-align:right;">${fmt(valN1)}</td>
                            <td style="text-align:right;">${fmt(valN)}</td>
                            <td style="text-align:right;" class="${varClass(valN, valN1)}">${fmtVar(valN, valN1)}</td>
                        </tr>`;
                    } else {
                        passifHtml += `<tr class="${rowClass}">
                            <td class="${r.indent ? 'indent' : ''}">${r.label}</td>
                            <td style="text-align:right;">${fmt(valN)}</td>
                        </tr>`;
                    }
                }
            });
            document.getElementById('passifDetailBody').innerHTML = passifHtml;
        }

        // ========== UPDATE CASH FLOW ==========
        function updateCashFlow() {
            const years = Object.keys(yearsData).sort();
            if (years.length === 0) return;

            const yearN = currentYear || years[years.length - 1];
            const yearN1Index = years.indexOf(yearN) - 1;
            const yearN1 = yearN1Index >= 0 ? years[yearN1Index] : null;
            
            const dataN = yearsData[yearN];
            const dataN1 = yearN1 ? yearsData[yearN1] : null;
            const hasN1 = dataN1 !== null;

            const M = n => Math.round((n || 0) / 1000000);
            const fmt = n => new Intl.NumberFormat('fr-FR').format(n);
            const fmtSigned = n => {
                if (n === 0) return '0';
                const formatted = fmt(Math.abs(n));
                return n > 0 ? '+' + formatted : '-' + formatted;
            };
            const colorClass = n => n >= 0 ? 'style="color:var(--success)"' : 'style="color:var(--danger)"';

            // Calcul CAF
            const caf = M(dataN.caf);

            // GÃ©nÃ©rer le HTML
            let html = '';

            if (hasN1) {
                // ===== CALCULS =====
                
                // Variation BFR
                const varStocks = M(dataN.stocks) - M(dataN1.stocks);
                const varClients = M(dataN.clients) - M(dataN1.clients);
                const varAutresCreances = M(dataN.autresCreances) - M(dataN1.autresCreances);
                const varFournisseurs = M(dataN.fournisseurs) - M(dataN1.fournisseurs);
                const varDettesFiscales = M(dataN.dettesFiscales) - M(dataN1.dettesFiscales);
                const varDettesSociales = M(dataN.dettesSociales || 0) - M(dataN1.dettesSociales || 0);
                const varAutresDettes = M(dataN.autresDettes) - M(dataN1.autresDettes);
                
                const varActifCirc = varStocks + varClients + varAutresCreances;
                const varPassifCirc = varFournisseurs + varDettesFiscales + varDettesSociales + varAutresDettes;
                const varBFR = varActifCirc - varPassifCirc;
                
                // Flux d'exploitation = CAF - Variation BFR
                const fluxExploitation = caf - varBFR;

                // Flux d'investissement
                const varImmoIncorp = M(dataN.immoIncorp) - M(dataN1.immoIncorp);
                const varImmoCorp = M(dataN.immoCorp) - M(dataN1.immoCorp);
                const varImmoFin = M(dataN.immoFin) - M(dataN1.immoFin);
                // Investissement net = Variation immo nettes + dotations (reconstitution des acquisitions)
                const investissementNet = (varImmoIncorp + varImmoCorp + varImmoFin) + M(dataN.dotations);
                const fluxInvestissement = -investissementNet;

                // Flux de financement
                const varEmprunts = M(dataN.emprunts) - M(dataN1.emprunts);
                const varCapital = M(dataN.capital) - M(dataN1.capital);
                const varReserves = M(dataN.reserves) - M(dataN1.reserves);
                const varReportAN = M(dataN.reportAN) - M(dataN1.reportAN);
                
                // Dividendes versÃ©s = RÃ©sultat N-1 - (Var RÃ©serves + Var Report AN)
                const resultatN1 = M(dataN1.resultatNet);
                const dividendes = resultatN1 - varReserves - varReportAN;
                
                const fluxFinancement = varEmprunts + varCapital - dividendes;

                // Variation de trÃ©sorerie
                const varTreso = fluxExploitation + fluxInvestissement + fluxFinancement;

                // TrÃ©sorerie
                const tresoN = M(dataN.tresoActif);
                const tresoN1 = M(dataN1.tresoActif);
                const varTresoReelle = tresoN - tresoN1;

                // Version complÃ¨te avec 2 annÃ©es
                html = `
                    <div style="margin-bottom:16px;padding:12px 16px;background:var(--blue-50);border-radius:8px;border-left:4px solid var(--blue-500);">
                        <strong>Tableau des Flux de TrÃ©sorerie ${yearN1} â†’ ${yearN}</strong>
                        <span style="float:right;color:var(--slate-500);font-size:13px;">Montants en M FCFA</span>
                    </div>

                    <div class="cashflow-section">
                        <h4>A. FLUX DE TRÃ‰SORERIE LIÃ‰S Ã€ L'EXPLOITATION</h4>
                        <div class="cashflow-row"><span class="label">RÃ©sultat net</span><span class="value">${fmt(M(dataN.resultatNet))}</span></div>
                        <div class="cashflow-row"><span class="label">+ Dotations aux amortissements</span><span class="value">${fmt(M(dataN.dotations))}</span></div>
                        <div class="cashflow-row"><span class="label">- Reprises de provisions</span><span class="value">${fmt(-M(dataN.reprises))}</span></div>
                        <div class="cashflow-row"><span class="label">- Variation du BFR</span><span class="value">${fmtSigned(-varBFR)}</span></div>
                        <div class="cashflow-total">
                            <span class="label">FLUX NET D'EXPLOITATION (A)</span>
                            <span class="value">${fmtSigned(fluxExploitation)}</span>
                        </div>
                    </div>

                    <div class="cashflow-section">
                        <h4>B. FLUX DE TRÃ‰SORERIE LIÃ‰S Ã€ L'INVESTISSEMENT</h4>
                        <div class="cashflow-row"><span class="label">Acquisitions d'immobilisations (net)</span><span class="value">${fmtSigned(-investissementNet)}</span></div>
                        <div class="cashflow-total">
                            <span class="label">FLUX NET D'INVESTISSEMENT (B)</span>
                            <span class="value">${fmtSigned(fluxInvestissement)}</span>
                        </div>
                    </div>

                    <div class="cashflow-section">
                        <h4>C. FLUX DE TRÃ‰SORERIE LIÃ‰S AU FINANCEMENT</h4>
                        <div class="cashflow-row"><span class="label">Variation des emprunts</span><span class="value">${fmtSigned(varEmprunts)}</span></div>
                        <div class="cashflow-row"><span class="label">Variation du capital</span><span class="value">${fmtSigned(varCapital)}</span></div>
                        <div class="cashflow-row"><span class="label">Dividendes versÃ©s</span><span class="value">${fmtSigned(-dividendes)}</span></div>
                        <div class="cashflow-total">
                            <span class="label">FLUX NET DE FINANCEMENT (C)</span>
                            <span class="value">${fmtSigned(fluxFinancement)}</span>
                        </div>
                    </div>

                    <div class="cashflow-total" style="background:var(--blue-600);color:white;margin-top:16px;">
                        <span class="label">VARIATION DE TRÃ‰SORERIE (A + B + C)</span>
                        <span class="value">${fmtSigned(varTreso)} M</span>
                    </div>

                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-top:20px;">
                        <div style="background:var(--slate-50);padding:16px;border-radius:12px;text-align:center;">
                            <div style="font-size:12px;color:var(--slate-500);margin-bottom:4px;">TrÃ©sorerie ${yearN1}</div>
                            <div style="font-size:20px;font-weight:700;color:var(--slate-700);">${fmt(tresoN1)} M</div>
                        </div>
                        <div style="background:var(--blue-50);padding:16px;border-radius:12px;text-align:center;">
                            <div style="font-size:12px;color:var(--slate-500);margin-bottom:4px;">Variation rÃ©elle</div>
                            <div style="font-size:20px;font-weight:700;color:var(--blue-700);">${fmtSigned(varTresoReelle)} M</div>
                        </div>
                        <div style="background:var(--slate-50);padding:16px;border-radius:12px;text-align:center;">
                            <div style="font-size:12px;color:var(--slate-500);margin-bottom:4px;">TrÃ©sorerie ${yearN}</div>
                            <div style="font-size:20px;font-weight:700;color:var(--slate-700);">${fmt(tresoN)} M</div>
                        </div>
                    </div>

                    ${Math.abs(varTreso - varTresoReelle) > 1 ? `
                    <div style="margin-top:16px;padding:12px;background:var(--warning-light);border-radius:8px;font-size:13px;color:var(--slate-600);">
                        <strong>âš  Ã‰cart de rÃ©conciliation :</strong> ${fmt(Math.abs(varTreso - varTresoReelle))} M FCFA<br>
                        <span style="font-size:12px;">Cet Ã©cart peut provenir de plus/moins values de cession, Ã©lÃ©ments HAO, ou autres Ã©lÃ©ments non captÃ©s.</span>
                    </div>
                    ` : `
                    <div style="margin-top:16px;padding:12px;background:var(--success-light);border-radius:8px;font-size:13px;color:var(--success);">
                        <strong>âœ“ RÃ©conciliation OK</strong> - La variation de trÃ©sorerie calculÃ©e correspond Ã  la variation rÃ©elle.
                    </div>
                    `}
                `;
            } else {
                // Version simplifiÃ©e sans N-1
                html = `
                    <div style="margin-bottom:16px;padding:12px 16px;background:var(--warning-light);border-radius:8px;border-left:4px solid var(--warning);">
                        <strong>âš  DonnÃ©es N-1 non disponibles</strong><br>
                        <span style="font-size:13px;">Importez la balance de l'exercice prÃ©cÃ©dent pour calculer les flux complets.</span>
                    </div>

                    <div class="cashflow-section">
                        <h4>A. FLUX DE TRÃ‰SORERIE LIÃ‰S Ã€ L'EXPLOITATION</h4>
                        <div class="cashflow-row"><span class="label">RÃ©sultat net</span><span class="value">${fmt(M(dataN.resultatNet))}</span></div>
                        <div class="cashflow-row"><span class="label">+ Dotations aux amortissements</span><span class="value">${fmt(M(dataN.dotations))}</span></div>
                        <div class="cashflow-row"><span class="label">- Reprises de provisions</span><span class="value">${fmt(-M(dataN.reprises))}</span></div>
                        <div class="cashflow-row highlight"><span class="label">= CapacitÃ© d'autofinancement (CAF)</span><span class="value">${fmt(caf)}</span></div>
                        <div class="cashflow-row" style="color:var(--slate-400);"><span class="label">- Variation du BFR</span><span class="value">N/A</span></div>
                        <div class="cashflow-total" style="margin-top:12px;background:var(--slate-100);">
                            <span class="label">FLUX NET D'EXPLOITATION</span>
                            <span class="value" style="color:var(--slate-400);">Requiert N-1</span>
                        </div>
                    </div>

                    <div class="cashflow-section">
                        <h4>B. FLUX DE TRÃ‰SORERIE LIÃ‰S Ã€ L'INVESTISSEMENT</h4>
                        <div class="cashflow-row"><span class="label">Acquisitions d'immobilisations</span><span class="value" style="color:var(--slate-400);">N/A</span></div>
                        <div class="cashflow-total" style="margin-top:12px;background:var(--slate-100);">
                            <span class="label">FLUX NET D'INVESTISSEMENT</span>
                            <span class="value" style="color:var(--slate-400);">Requiert N-1</span>
                        </div>
                    </div>

                    <div class="cashflow-section">
                        <h4>C. FLUX DE TRÃ‰SORERIE LIÃ‰S AU FINANCEMENT</h4>
                        <div class="cashflow-row"><span class="label">Variation des emprunts</span><span class="value" style="color:var(--slate-400);">N/A</span></div>
                        <div class="cashflow-row"><span class="label">Variation du capital</span><span class="value" style="color:var(--slate-400);">N/A</span></div>
                        <div class="cashflow-row"><span class="label">Dividendes versÃ©s</span><span class="value" style="color:var(--slate-400);">N/A</span></div>
                        <div class="cashflow-total" style="margin-top:12px;background:var(--slate-100);">
                            <span class="label">FLUX NET DE FINANCEMENT</span>
                            <span class="value" style="color:var(--slate-400);">Requiert N-1</span>
                        </div>
                    </div>

                    <div class="cashflow-total">
                        <span class="label">TRÃ‰SORERIE NETTE AU ${yearN}</span>
                        <span class="value">${fmt(M(dataN.tresoActif))} M FCFA</span>
                    </div>
                `;
            }

            document.getElementById('cashflowBody').innerHTML = html;
        }

        // ========== UPDATE RATIOS PAGE ==========
        function updateRatiosPage(data) {
            if (!data) return;

            document.getElementById('ratiosContent').style.display = 'block';
            document.getElementById('ratiosEmpty').style.display = 'none';

            // Calculate additional ratios
            const margeOp = data.ca > 0 ? (data.ebit / data.ca * 100) : 0;
            const cashRatio = data.passifCirculant > 0 ? (data.tresoActif / data.passifCirculant) : 0;
            const endettement = data.totalPassif > 0 ? ((data.totalDetteFin + data.passifCirculant) / data.totalPassif * 100) : 0;
            const gearing = data.capitauxPropres > 0 ? (data.totalDetteFin / data.capitauxPropres * 100) : 0;
            const autonomie = data.totalPassif > 0 ? (data.capitauxPropres / data.totalPassif * 100) : 0;
            const roce = (data.capitauxPropres + data.totalDetteFin) > 0 ? (data.ebit / (data.capitauxPropres + data.totalDetteFin) * 100) : 0;
            
            // Rotation ratios (in days)
            const rotationStocks = data.achats > 0 ? Math.round(data.stocks / (data.achats / 365)) : 0;
            const delaiClients = data.ca > 0 ? Math.round(data.clients / (data.ca / 365)) : 0;
            const delaiFournisseurs = data.achats > 0 ? Math.round(data.fournisseurs / (data.achats / 365)) : 0;

            // Update values with thousand separators
            const fmt = (n, suffix = '%') => new Intl.NumberFormat('fr-FR', {maximumFractionDigits: 1}).format(n) + suffix;
            const fmtX = n => new Intl.NumberFormat('fr-FR', {maximumFractionDigits: 1}).format(n) + 'x';
            const fmtJ = n => new Intl.NumberFormat('fr-FR', {maximumFractionDigits: 0}).format(n) + ' j';
            const fmtN = n => new Intl.NumberFormat('fr-FR', {maximumFractionDigits: 2}).format(n);

            // ProfitabilitÃ©
            document.getElementById('ratioMargeBruteDetail').textContent = fmt(data.margeBrutePct);
            document.getElementById('ratioMargeEbitdaDetail').textContent = fmt(data.margeEbitda);
            document.getElementById('ratioMargeOpDetail').textContent = fmt(margeOp);
            document.getElementById('ratioMargeNetteDetail').textContent = fmt(data.margeNette);

            // RentabilitÃ©
            document.getElementById('ratioROEDetail').textContent = fmt(data.roe);
            document.getElementById('ratioROADetail').textContent = fmt(data.roi);
            document.getElementById('ratioROCEDetail').textContent = fmt(roce);

            // LiquiditÃ©
            document.getElementById('ratioCurrentDetail').textContent = fmtN(data.currentRatio);
            document.getElementById('ratioQuickDetail').textContent = fmtN(data.quickRatio);
            document.getElementById('ratioCashDetail').textContent = fmtN(cashRatio);

            // SolvabilitÃ©
            document.getElementById('ratioEndettementDetail').textContent = fmt(endettement);
            document.getElementById('ratioGearingDetail').textContent = fmt(gearing);
            document.getElementById('ratioNetDebtDetail').textContent = fmtX(data.netDebtEbitda);
            document.getElementById('ratioAutonomieDetail').textContent = fmt(autonomie);

            // EfficacitÃ©
            document.getElementById('ratioBFRDetail').textContent = fmtJ(data.bfrJours);
            document.getElementById('ratioRotationStocksDetail').textContent = fmtJ(rotationStocks);
            document.getElementById('ratioDelaiClientsDetail').textContent = fmtJ(delaiClients);
            document.getElementById('ratioDelaiFournDetail').textContent = fmtJ(delaiFournisseurs);

            // Update bars (normalize to 100% based on benchmarks)
            const setBar = (id, value, max) => {
                const el = document.getElementById(id);
                if (el) el.style.width = Math.min(100, Math.max(0, (value / max) * 100)) + '%';
            };

            // ProfitabilitÃ© bars (max ~50%)
            setBar('barMargeBrute', data.margeBrutePct, 50);
            setBar('barMargeEbitda', data.margeEbitda, 40);
            setBar('barMargeOp', margeOp, 30);
            setBar('barMargeNette', data.margeNette, 20);

            // RentabilitÃ© bars (max ~30%)
            setBar('barROE', data.roe, 30);
            setBar('barROA', data.roi, 15);
            setBar('barROCE', roce, 20);

            // LiquiditÃ© bars (max 3)
            setBar('barCurrent', data.currentRatio, 3);
            setBar('barQuick', data.quickRatio, 2);
            setBar('barCash', cashRatio, 1);

            // SolvabilitÃ© bars (inverse for some)
            setBar('barEndettement', 100 - endettement, 100);
            setBar('barGearing', 100 - Math.min(gearing, 100), 100);
            setBar('barNetDebt', Math.max(0, 5 - data.netDebtEbitda), 5);
            setBar('barAutonomie', autonomie, 100);

            // EfficacitÃ© bars (inverse - lower is better)
            setBar('barBFR', Math.max(0, 90 - data.bfrJours), 90);
            setBar('barRotationStocks', Math.max(0, 90 - rotationStocks), 90);
            setBar('barDelaiClients', Math.max(0, 90 - delaiClients), 90);
            setBar('barDelaiFourn', Math.min(delaiFournisseurs, 60), 60);
        }

        function initEvolutionChart(data) {
            const ctx = document.getElementById('evolutionChart');
            if (!ctx) return;
            
            const M = n => Math.round((n || 0) / 1000000);
            // Simulate historical data (in real app, would come from multiple years)
            const years = ['2022', '2023', '2024'];
            const caData = [M(data.ca * 0.8), M(data.ca * 0.9), M(data.ca)];
            const ebitdaData = [M(data.ebitda * 0.75), M(data.ebitda * 0.85), M(data.ebitda)];
            const netData = [M(data.resultatNet * 0.7), M(data.resultatNet * 0.82), M(data.resultatNet)];

            new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        { label: "Chiffre d'affaires", data: caData, backgroundColor: '#3b82f6', borderRadius: 8 },
                        { label: 'EBITDA', data: ebitdaData, backgroundColor: '#10b981', borderRadius: 8 },
                        { label: 'RÃ©sultat Net', data: netData, backgroundColor: '#8b5cf6', borderRadius: 8 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', align: 'end' },
                        tooltip: {
                            callbacks: {
                                label: ctx => ctx.dataset.label + ': ' + ctx.raw + ' M FCFA'
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { callback: v => v + ' M' }
                        }
                    }
                }
            });
        }

        // ========== P&L COMPARATIVE ==========
        function updatePnLComparative() {
            const years = Object.keys(yearsData).sort();
            const fmt = n => new Intl.NumberFormat('fr-FR').format(n);
            const M = n => Math.round((n || 0) / 1000000);
            
            // Get current year and previous
            const yearN = currentYear || years[years.length - 1];
            const yearN1Index = years.indexOf(yearN) - 1;
            const yearN1 = yearN1Index >= 0 ? years[yearN1Index] : null;
            const hasComparison = yearN1 !== null;
            
            const dataN = yearsData[yearN];
            const dataN1 = hasComparison ? yearsData[yearN1] : null;

            // Variation formatter
            const fmtVar = (n, n1) => {
                if (n1 === null || n1 === undefined || n1 === 0) return '-';
                const pct = ((n - n1) / Math.abs(n1)) * 100;
                const sign = pct >= 0 ? '+' : '';
                return sign + pct.toFixed(1) + '%';
            };
            const varClass = (n, n1) => {
                if (n1 === null || n1 === undefined || n1 === 0) return '';
                return n >= n1 ? 'var-positive' : 'var-negative';
            };

            // Update subtitle
            document.getElementById('pnlSubtitle').textContent = hasComparison 
                ? `Comparaison ${yearN1} â†’ ${yearN}` 
                : `Exercice ${yearN}`;

            // Update table header
            const thead = document.getElementById('pnlTableHead');
            if (hasComparison) {
                thead.innerHTML = `
                    <tr>
                        <th>LibellÃ©</th>
                        <th style="text-align: right;">${yearN1}</th>
                        <th style="text-align: right;">${yearN}</th>
                        <th style="text-align: right;">Var %</th>
                    </tr>
                `;
            } else {
                thead.innerHTML = `
                    <tr>
                        <th>LibellÃ©</th>
                        <th style="text-align: right;">${yearN}</th>
                    </tr>
                `;
            }

            // Define P&L rows with keys
            const pnlStructure = [
                { label: "CHIFFRE D'AFFAIRES", key: 'ca', highlight: true },
                { label: "Achats consommÃ©s", key: 'achats', neg: true },
                { label: "Variation de stocks", key: 'varStocks' },
                { label: "MARGE BRUTE", key: 'margeBrute', highlight: true },
                { label: "Transports", key: 'transports', indent: true, neg: true },
                { label: "Services extÃ©rieurs", key: 'servicesExt', indent: true, neg: true },
                { label: "Autres services", key: 'autresServices', indent: true, neg: true },
                { label: "ImpÃ´ts et taxes", key: 'impotsTaxes', indent: true, neg: true },
                { label: "Autres charges", key: 'autresCharges', indent: true, neg: true },
                { label: "Charges de personnel", key: 'personnel', indent: true, neg: true },
                { label: "EBITDA", key: 'ebitda', highlight: true },
                { label: "Dotations aux amortissements", key: 'dotations', neg: true },
                { label: "Reprises de provisions", key: 'reprises' },
                { label: "RÃ‰SULTAT D'EXPLOITATION (EBIT)", key: 'ebit', highlight: true },
                { label: "Produits financiers", key: 'prodFin', indent: true },
                { label: "Charges financiÃ¨res", key: 'chgFin', indent: true, neg: true },
                { label: "RÃ‰SULTAT FINANCIER", key: 'resultatFin', highlight: true },
                { label: "Produits HAO", key: 'prodHAO', indent: true },
                { label: "Charges HAO", key: 'chgHAO', indent: true, neg: true },
                { label: "RÃ‰SULTAT HAO", key: 'resultatHAO', highlight: true },
                { label: "ImpÃ´ts sur les bÃ©nÃ©fices", key: 'impotBIC', neg: true },
                { label: "RÃ‰SULTAT NET", key: 'resultatNet', total: true }
            ];

            // Generate table body
            const tbody = document.getElementById('pnlDetailBody');
            
            if (hasComparison) {
                tbody.innerHTML = pnlStructure.map(row => {
                    const valN1 = row.neg ? -M(dataN1[row.key]) : M(dataN1[row.key]);
                    const valN = row.neg ? -M(dataN[row.key]) : M(dataN[row.key]);
                    
                    return `<tr class="${row.highlight ? 'highlight' : ''} ${row.total ? 'total' : ''}">
                        <td class="${row.indent ? 'indent' : ''}">${row.label}</td>
                        <td style="text-align:right" class="${valN1 < 0 ? 'negative' : ''}">${fmt(valN1)}</td>
                        <td style="text-align:right" class="${valN < 0 ? 'negative' : ''}">${fmt(valN)}</td>
                        <td style="text-align:right" class="${varClass(valN, valN1)}">${fmtVar(valN, valN1)}</td>
                    </tr>`;
                }).join('');
            } else {
                tbody.innerHTML = pnlStructure.map(row => {
                    const val = row.neg ? -M(dataN[row.key]) : M(dataN[row.key]);
                    return `<tr class="${row.highlight ? 'highlight' : ''} ${row.total ? 'total' : ''}">
                        <td class="${row.indent ? 'indent' : ''}">${row.label}</td>
                        <td style="text-align:right" class="${val < 0 ? 'negative' : ''}">${fmt(val)}</td>
                    </tr>`;
                }).join('');
            }
        }

        // ========== ACCOUNT MAPPING CONFIGURATION - SYSCOHADA ==========
        
        // Mapping par dÃ©faut SYSCOHADA rÃ©visÃ© - basÃ© sur le plan comptable OHADA
        const defaultMappingSYSCOHADA = {
            // BILAN - ACTIF
            actifImmobilise: ['20', '21', '22', '23', '24', '25', '26', '27'],  // Classe 2 (hors 28, 29 = amort/prov)
            amortissements: ['28', '29'],  // Amortissements et provisions pour dÃ©prÃ©ciation
            actifCirculant: ['31', '32', '33', '34', '35', '36', '37', '38', '39'],  // Stocks classe 3
            creancesClients: ['41'],  // Clients
            autresCreances: ['42', '43', '44', '45', '46', '47', '48', '49'],  // Autres crÃ©ances classe 4
            tresorerieActif: ['50', '51', '52', '53', '54', '55', '57', '58'],  // TrÃ©sorerie classe 5
            
            // BILAN - PASSIF
            capitauxPropres: ['10', '11', '12', '13', '14', '15'],  // Capital, rÃ©serves, rÃ©sultat (pas 18, 19)
            provisions: ['16'],  // Provisions pour risques et charges
            dettesFinancieres: ['17'],  // Emprunts et dettes financiÃ¨res
            fournisseurs: ['40'],  // Fournisseurs
            autresDettes: ['42', '43', '44', '45', '46', '47', '48', '49'],  // Autres dettes classe 4
            
            // COMPTE DE RESULTAT - PRODUITS
            chiffreAffaires: ['70'],  // Ventes uniquement
            productionStockee: ['71'],  // Production stockÃ©e
            productionImmo: ['72'],  // Production immobilisÃ©e
            subventions: ['73'],  // Subventions d'exploitation
            autresProduits: ['74', '75'],  // Autres produits d'exploitation
            produitsFinanciers: ['77'],  // Produits financiers
            reprises: ['79'],  // Reprises de provisions
            produitsHAO: ['82', '84', '86', '88'],  // Produits HAO
            
            // COMPTE DE RESULTAT - CHARGES
            achats: ['60'],  // Achats et variations de stocks
            transports: ['61'],  // Transports
            servicesExterieurs: ['62'],  // Services extÃ©rieurs
            autresServices: ['63'],  // Autres services extÃ©rieurs
            impotsTaxes: ['64'],  // ImpÃ´ts et taxes (hors IS)
            autresCharges: ['65'],  // Autres charges
            chargesPersonnel: ['66'],  // Charges de personnel
            chargesFinancieres: ['67'],  // Charges financiÃ¨res
            dotations: ['68', '69'],  // Dotations aux amortissements et provisions
            chargesHAO: ['81', '83', '85', '87'],  // Charges HAO
            impotResultat: ['89']  // ImpÃ´t sur le rÃ©sultat (BIC)
        };

        let accountMapping = JSON.parse(JSON.stringify(defaultMappingSYSCOHADA));
        let mappingExceptions = [];
        let unclassifiedAccounts = [];

        const categoryNames = {
            // Bilan Actif
            actifImmobilise: 'Actif ImmobilisÃ© (brut)',
            amortissements: 'Amortissements & Provisions',
            actifCirculant: 'Stocks',
            creancesClients: 'Clients',
            autresCreances: 'Autres CrÃ©ances',
            tresorerieActif: 'TrÃ©sorerie Actif',
            // Bilan Passif
            capitauxPropres: 'Capitaux Propres',
            provisions: 'Provisions Risques/Charges',
            dettesFinancieres: 'Dettes FinanciÃ¨res',
            fournisseurs: 'Fournisseurs',
            autresDettes: 'Autres Dettes',
            // Produits
            chiffreAffaires: 'Chiffre d\'Affaires (70)',
            productionStockee: 'Production StockÃ©e (71)',
            productionImmo: 'Production ImmobilisÃ©e (72)',
            subventions: 'Subventions (73)',
            autresProduits: 'Autres Produits (74-75)',
            produitsFinanciers: 'Produits Financiers (77)',
            reprises: 'Reprises Provisions (79)',
            produitsHAO: 'Produits HAO',
            // Charges
            achats: 'Achats (60)',
            transports: 'Transports (61)',
            servicesExterieurs: 'Services ExtÃ©rieurs (62)',
            autresServices: 'Autres Services (63)',
            impotsTaxes: 'ImpÃ´ts & Taxes (64)',
            autresCharges: 'Autres Charges (65)',
            chargesPersonnel: 'Personnel (66)',
            chargesFinancieres: 'Charges FinanciÃ¨res (67)',
            dotations: 'Dotations (68-69)',
            chargesHAO: 'Charges HAO',
            impotResultat: 'ImpÃ´t sur RÃ©sultat (89)'
        };

        function loadMapping() {
            const saved = localStorage.getItem('findalyx_mapping_v2');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    accountMapping = data.mapping || JSON.parse(JSON.stringify(defaultMappingSYSCOHADA));
                    mappingExceptions = data.exceptions || [];
                } catch (e) {
                    console.error('Error loading mapping:', e);
                }
            }
            renderAllMapping();
            updateMappingStats();
        }

        function saveMapping() {
            localStorage.setItem('findalyx_mapping_v2', JSON.stringify({
                mapping: accountMapping,
                exceptions: mappingExceptions
            }));
        }

        function switchMappingTab(tabId) {
            document.querySelectorAll('.mapping-tab').forEach(tab => tab.classList.remove('active'));
            event.target.closest('.mapping-tab').classList.add('active');
            document.querySelectorAll('.mapping-tab-content').forEach(c => c.classList.remove('active'));
            const content = document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1));
            if (content) content.classList.add('active');
        }

        function renderAllMapping() {
            renderPrefixesMapping();
            renderExceptions();
            renderUnclassifiedAccounts();
        }

        function renderPrefixesMapping() {
            const grid = document.getElementById('mappingPrefixesGrid');
            if (!grid) return;
            
            // Configuration des catÃ©gories avec icÃ´nes et couleurs
            const categoryConfig = {
                // Bilan Actif
                actifImmobilise: { icon: 'building', color: 'blue', badge: 'Classe 2', desc: 'Immobilisations incorporelles, corporelles et financiÃ¨res' },
                amortissements: { icon: 'minus-circle', color: 'gray', badge: 'Classe 28-29', desc: 'Amortissements et provisions pour dÃ©prÃ©ciation' },
                actifCirculant: { icon: 'cube', color: 'cyan', badge: 'Classe 3', desc: 'Stocks de marchandises, matiÃ¨res, produits' },
                creancesClients: { icon: 'users', color: 'blue', badge: 'Classe 41', desc: 'CrÃ©ances clients et comptes rattachÃ©s' },
                autresCreances: { icon: 'clipboard', color: 'cyan', badge: 'Classe 42-49', desc: 'Personnel, Ã‰tat, comptes de rÃ©gularisation' },
                tresorerieActif: { icon: 'cash', color: 'green', badge: 'Classe 5', desc: 'Banques, caisses, VMP' },
                // Bilan Passif
                capitauxPropres: { icon: 'shield', color: 'purple', badge: 'Classe 10-15', desc: 'Capital, rÃ©serves, rÃ©sultat' },
                provisions: { icon: 'alert', color: 'orange', badge: 'Classe 16', desc: 'Provisions pour risques et charges' },
                dettesFinancieres: { icon: 'bank', color: 'orange', badge: 'Classe 17', desc: 'Emprunts et dettes financiÃ¨res' },
                fournisseurs: { icon: 'truck', color: 'red', badge: 'Classe 40', desc: 'Fournisseurs et comptes rattachÃ©s' },
                autresDettes: { icon: 'document', color: 'orange', badge: 'Classe 42-49', desc: 'Dettes fiscales, sociales, diverses' },
                // Produits
                chiffreAffaires: { icon: 'trending-up', color: 'green', badge: 'Classe 70', desc: 'Ventes de produits et services' },
                productionStockee: { icon: 'archive', color: 'green', badge: 'Classe 71', desc: 'Variation de production stockÃ©e' },
                productionImmo: { icon: 'cog', color: 'green', badge: 'Classe 72', desc: 'Production immobilisÃ©e' },
                subventions: { icon: 'gift', color: 'green', badge: 'Classe 73', desc: 'Subventions d\'exploitation' },
                autresProduits: { icon: 'plus-circle', color: 'green', badge: 'Classe 74-75', desc: 'Autres produits d\'exploitation' },
                produitsFinanciers: { icon: 'dollar', color: 'green', badge: 'Classe 77', desc: 'IntÃ©rÃªts, dividendes, gains de change' },
                reprises: { icon: 'refresh', color: 'green', badge: 'Classe 79', desc: 'Reprises de provisions et dÃ©prÃ©ciations' },
                produitsHAO: { icon: 'star', color: 'green', badge: 'Classe 82-88', desc: 'Produits hors activitÃ©s ordinaires' },
                // Charges
                achats: { icon: 'cart', color: 'red', badge: 'Classe 60', desc: 'Achats et variations de stocks' },
                transports: { icon: 'truck', color: 'red', badge: 'Classe 61', desc: 'Transports de biens et personnel' },
                servicesExterieurs: { icon: 'office', color: 'orange', badge: 'Classe 62', desc: 'Locations, entretiens, assurances' },
                autresServices: { icon: 'briefcase', color: 'orange', badge: 'Classe 63', desc: 'Honoraires, publicitÃ©, dÃ©placements' },
                impotsTaxes: { icon: 'receipt', color: 'red', badge: 'Classe 64', desc: 'ImpÃ´ts et taxes (hors IS)' },
                autresCharges: { icon: 'folder', color: 'orange', badge: 'Classe 65', desc: 'Autres charges de gestion' },
                chargesPersonnel: { icon: 'users', color: 'purple', badge: 'Classe 66', desc: 'Salaires et charges sociales' },
                chargesFinancieres: { icon: 'credit-card', color: 'orange', badge: 'Classe 67', desc: 'IntÃ©rÃªts, pertes de change' },
                dotations: { icon: 'chart-down', color: 'red', badge: 'Classe 68-69', desc: 'Dotations aux amort. et provisions' },
                chargesHAO: { icon: 'x-circle', color: 'red', badge: 'Classe 81-87', desc: 'Charges hors activitÃ©s ordinaires' },
                impotResultat: { icon: 'calculator', color: 'red', badge: 'Classe 89', desc: 'ImpÃ´t sur les bÃ©nÃ©fices (BIC/IS)' }
            };
            
            const icons = {
                'building': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>',
                'cube': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>',
                'cash': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>',
                'shield': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>',
                'bank': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/>',
                'trending-up': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>',
                'cart': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>',
                'users': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>',
                'chart-down': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>',
                'credit-card': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>',
                'receipt': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2zM10 8.5a.5.5 0 11-1 0 .5.5 0 011 0zm5 5a.5.5 0 11-1 0 .5.5 0 011 0z"/>',
                'calculator': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>',
                'truck': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>',
                'office': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>',
                'briefcase': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>',
                'folder': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>',
                'plus-circle': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/>',
                'minus-circle': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/>',
                'x-circle': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>',
                'alert': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>',
                'clipboard': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>',
                'document': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>',
                'dollar': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>',
                'refresh': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>',
                'gift': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/>',
                'archive': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>',
                'cog': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>',
                'star': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>'
            };
            
            let html = '';
            
            // Grouper par sections
            const sections = [
                { title: 'ðŸ“Š BILAN - ACTIF', categories: ['actifImmobilise', 'amortissements', 'actifCirculant', 'creancesClients', 'autresCreances', 'tresorerieActif'] },
                { title: 'ðŸ“Š BILAN - PASSIF', categories: ['capitauxPropres', 'provisions', 'dettesFinancieres', 'fournisseurs', 'autresDettes'] },
                { title: 'ðŸ“ˆ PRODUITS', categories: ['chiffreAffaires', 'productionStockee', 'productionImmo', 'subventions', 'autresProduits', 'produitsFinanciers', 'reprises', 'produitsHAO'] },
                { title: 'ðŸ“‰ CHARGES', categories: ['achats', 'transports', 'servicesExterieurs', 'autresServices', 'impotsTaxes', 'autresCharges', 'chargesPersonnel', 'chargesFinancieres', 'dotations', 'chargesHAO', 'impotResultat'] }
            ];
            
            sections.forEach(section => {
                html += `<div class="mapping-section-title" style="grid-column:1/-1;font-weight:700;font-size:14px;color:var(--slate-600);margin:16px 0 8px;padding-bottom:8px;border-bottom:2px solid var(--slate-200);">${section.title}</div>`;
                
                section.categories.forEach(cat => {
                    const config = categoryConfig[cat];
                    if (!config || !accountMapping[cat]) return;
                    
                    const iconSvg = icons[config.icon] || icons['folder'];
                    const prefixes = accountMapping[cat] || [];
                    const inputId = 'add' + cat.charAt(0).toUpperCase() + cat.slice(1) + 'Input';
                    const prefixesId = 'mapping' + cat.charAt(0).toUpperCase() + cat.slice(1);
                    
                    html += `
                        <div class="mapping-category" data-category="${cat}">
                            <div class="mapping-category-header">
                                <h4><span class="icon ${config.color}"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24">${iconSvg}</svg></span>${categoryNames[cat]}</h4>
                                <span class="mapping-badge ${config.color}">${config.badge}</span>
                            </div>
                            <div class="mapping-category-body">
                                <p class="mapping-description">${config.desc}</p>
                                <div class="mapping-prefixes" id="${prefixesId}">
                                    ${prefixes.length === 0 ? '<span style="color:var(--slate-400);font-size:13px;">Aucun prÃ©fixe</span>' : 
                                      prefixes.map(p => `<span class="prefix-tag">${p}<button onclick="removePrefix('${cat}', '${p}')">Ã—</button></span>`).join('')}
                                </div>
                                <div class="mapping-add">
                                    <input type="text" placeholder="PrÃ©fixe..." id="${inputId}" maxlength="4" onkeypress="if(event.key==='Enter')addPrefix('${cat}')">
                                    <button class="btn btn-sm btn-secondary" onclick="addPrefix('${cat}')">+ Ajouter</button>
                                </div>
                            </div>
                        </div>`;
                });
            });
            
            grid.innerHTML = html;
        }

        function addPrefix(category) {
            const inputId = 'add' + category.charAt(0).toUpperCase() + category.slice(1) + 'Input';
            const input = document.getElementById(inputId);
            if (!input) return;
            
            const value = input.value.trim();
            
            if (value && /^\d{2,4}$/.test(value)) {
                if (!accountMapping[category]) accountMapping[category] = [];
                if (accountMapping[category].includes(value)) {
                    showToast('Ce prÃ©fixe existe dÃ©jÃ ', 'warning');
                    return;
                }
                
                // Remove from other categories if present
                Object.keys(accountMapping).forEach(cat => {
                    if (cat !== category && accountMapping[cat]) {
                        accountMapping[cat] = accountMapping[cat].filter(p => p !== value);
                    }
                });
                
                accountMapping[category].push(value);
                accountMapping[category].sort();
                renderPrefixesMapping();
                updateMappingStats();
                input.value = '';
                showToast(`PrÃ©fixe ${value} ajoutÃ©`, 'success');
            } else {
                showToast('PrÃ©fixe invalide (2-4 chiffres)', 'error');
            }
        }

        function removePrefix(category, prefix) {
            if (accountMapping[category]) {
                accountMapping[category] = accountMapping[category].filter(p => p !== prefix);
                renderPrefixesMapping();
                updateMappingStats();
                showToast(`PrÃ©fixe ${prefix} supprimÃ©`, 'success');
            }
        }

        function filterMappingCategories() {
            const search = (document.getElementById('searchPrefixInput')?.value || '').toLowerCase();
            document.querySelectorAll('.mapping-category[data-category]').forEach(cat => {
                const category = cat.getAttribute('data-category');
                const name = categoryNames[category] || '';
                const prefixes = accountMapping[category] || [];
                const matches = name.toLowerCase().includes(search) || prefixes.some(p => p.includes(search));
                cat.style.display = matches || search === '' ? 'block' : 'none';
            });
        }

        function renderExceptions() {
            const container = document.getElementById('exceptionsList');
            if (!container) return;
            
            if (mappingExceptions.length === 0) {
                container.innerHTML = `<div id="noExceptions" style="text-align:center;color:#92400e;padding:20px;font-size:14px;">
                    Aucune exception configurÃ©e. Les comptes sont classÃ©s selon leurs prÃ©fixes.
                </div>`;
                return;
            }
            
            container.innerHTML = mappingExceptions.map((exc, i) => `
                <div class="exception-item">
                    <span class="compte">${exc.compte}</span>
                    <span class="arrow">â†’</span>
                    <span class="target">${categoryNames[exc.target] || exc.target}</span>
                    ${exc.libelle ? `<span class="libelle">${exc.libelle}</span>` : ''}
                    <button class="remove" onclick="removeException(${i})">Ã—</button>
                </div>
            `).join('');
        }

        function addException() {
            const compte = document.getElementById('exceptionCompte')?.value.trim();
            const libelle = document.getElementById('exceptionLibelle')?.value.trim();
            const target = document.getElementById('exceptionTarget')?.value;

            if (!compte || !/^\d{3,10}$/.test(compte)) {
                showToast('NumÃ©ro de compte invalide (3-10 chiffres)', 'error');
                return;
            }
            
            if (mappingExceptions.some(e => e.compte === compte)) {
                showToast('Ce compte a dÃ©jÃ  une exception', 'warning');
                return;
            }

            mappingExceptions.push({ compte, libelle, target });
            mappingExceptions.sort((a, b) => a.compte.localeCompare(b.compte));
            renderExceptions();
            updateMappingStats();
            
            document.getElementById('exceptionCompte').value = '';
            document.getElementById('exceptionLibelle').value = '';
            showToast(`Exception ajoutÃ©e: ${compte}`, 'success');
        }

        function removeException(index) {
            mappingExceptions.splice(index, 1);
            renderExceptions();
            updateMappingStats();
            showToast('Exception supprimÃ©e', 'success');
        }

        function renderUnclassifiedAccounts() {
            const container = document.getElementById('unclassifiedList');
            const countBadge = document.getElementById('unclassifiedCount');
            const tabBadge = document.getElementById('unclassifiedBadge');
            const section = document.getElementById('unclassifiedSection');
            
            const count = unclassifiedAccounts.length;
            if (countBadge) countBadge.textContent = count;
            if (tabBadge) {
                tabBadge.textContent = count;
                tabBadge.style.background = count > 0 ? '#ef4444' : '#16a34a';
            }
            if (section) section.classList.toggle('empty', count === 0);
            
            if (!container) return;
            
            if (count === 0) {
                container.innerHTML = `<div style="text-align:center;color:#166534;padding:40px;grid-column:1/-1;">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:48px;height:48px;margin-bottom:12px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <p style="font-weight:600;">Tous les comptes sont classÃ©s !</p>
                </div>`;
                return;
            }
            
            container.innerHTML = unclassifiedAccounts.map((acc, i) => `
                <div class="unclassified-item">
                    <span class="numero">${acc.numero}</span>
                    <span class="libelle" title="${acc.libelle}">${acc.libelle}</span>
                    <select onchange="classifyAccount(${i}, this.value)">
                        <option value="">Classer...</option>
                        ${Object.keys(categoryNames).map(k => `<option value="${k}">${categoryNames[k]}</option>`).join('')}
                    </select>
                </div>
            `).join('');
        }

        function classifyAccount(index, category) {
            if (!category) return;
            const acc = unclassifiedAccounts[index];
            mappingExceptions.push({ compte: acc.numero, libelle: acc.libelle, target: category });
            unclassifiedAccounts.splice(index, 1);
            renderUnclassifiedAccounts();
            renderExceptions();
            updateMappingStats();
            showToast(`${acc.numero} classÃ© dans ${categoryNames[category]}`, 'success');
        }

        function updateMappingStats() {
            let totalPrefixes = 0;
            Object.values(accountMapping).forEach(arr => { if (arr) totalPrefixes += arr.length; });
            
            const statPrefixes = document.getElementById('statPrefixes');
            const statExceptions = document.getElementById('statExceptions');
            const statUnclassified = document.getElementById('statUnclassified');
            
            if (statPrefixes) statPrefixes.textContent = totalPrefixes;
            if (statExceptions) statExceptions.textContent = mappingExceptions.length;
            if (statUnclassified) {
                statUnclassified.textContent = unclassifiedAccounts.length;
                statUnclassified.className = 'value ' + (unclassifiedAccounts.length > 0 ? 'danger' : 'success');
            }
        }

        function resetMapping() {
            if (confirm('RÃ©initialiser le mapping aux valeurs SYSCOHADA par dÃ©faut ?')) {
                accountMapping = JSON.parse(JSON.stringify(defaultMappingSYSCOHADA));
                mappingExceptions = [];
                renderAllMapping();
                updateMappingStats();
                showToast('Mapping rÃ©initialisÃ©', 'success');
            }
        }

        function cancelMappingChanges() {
            loadMapping();
            showToast('Modifications annulÃ©es', 'info');
        }

        function saveMappingAndReload() {
            saveMapping();
            showToast('Mapping sauvegardÃ© ! Recalcul en cours...', 'success');
            if (currentYear && yearsData[currentYear]) {
                // Recalculate with new mapping
                setTimeout(() => location.reload(), 1000);
            }
        }

        function exportMapping() {
            const data = { mapping: accountMapping, exceptions: mappingExceptions, exportDate: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'findalyx-mapping.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Mapping exportÃ©', 'success');
        }

        function importMapping(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.mapping) {
                        accountMapping = data.mapping;
                        mappingExceptions = data.exceptions || [];
                        renderAllMapping();
                        updateMappingStats();
                        saveMapping();
                        showToast('Mapping importÃ© avec succÃ¨s', 'success');
                    } else {
                        showToast('Format de fichier invalide', 'error');
                    }
                } catch (err) {
                    showToast('Erreur de lecture du fichier', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Fonction pour classifier un compte selon le mapping
        function getAccountCategory(accountNumber) {
            const numStr = String(accountNumber);
            
            // D'abord vÃ©rifier les exceptions
            const exception = mappingExceptions.find(e => numStr.startsWith(e.compte) || e.compte === numStr);
            if (exception) return exception.target;
            
            // Ensuite vÃ©rifier les prÃ©fixes
            for (const [category, prefixes] of Object.entries(accountMapping)) {
                if (prefixes && prefixes.some(prefix => numStr.startsWith(prefix))) {
                    return category;
                }
            }
            
            return null; // Non classÃ©
        }

        // ========== EVOLUTION PAGE UPDATE ==========
        function updateEvolutionPage() {
            const years = Object.keys(yearsData).sort();

            // Update badges
            const badgesContainer = document.getElementById('evolutionYearsBadges');
            if (badgesContainer) {
                if (years.length === 0) {
                    badgesContainer.innerHTML = '<span style="color: var(--slate-400);">Aucune annÃ©e chargÃ©e</span>';
                } else {
                    badgesContainer.innerHTML = years.map(y => 
                        `<span style="background: var(--blue-100); color: var(--blue-700); padding: 4px 12px; border-radius: 16px; font-weight: 600; font-size: 13px;">${y}</span>`
                    ).join('');
                }
            }

            if (years.length < 2) {
                document.getElementById('evolutionChartContainer2').style.display = 'none';
                document.getElementById('ratiosChartContainer').style.display = 'none';
                document.getElementById('noEvolutionPageData').style.display = 'block';
                document.getElementById('noRatiosData').style.display = 'block';
                return;
            }

            document.getElementById('evolutionChartContainer2').style.display = 'block';
            document.getElementById('ratiosChartContainer').style.display = 'block';
            document.getElementById('noEvolutionPageData').style.display = 'none';
            document.getElementById('noRatiosData').style.display = 'none';

            const Mrd = n => parseFloat(((n || 0) / 1000000000).toFixed(2));
            const fmtMrd = n => new Intl.NumberFormat('fr-FR', {maximumFractionDigits: 1}).format(n);

            // Evolution Chart
            const evolutionCtx = document.getElementById('evolutionPageChart');
            if (evolutionCtx) {
                const existingChart = Chart.getChart(evolutionCtx);
                if (existingChart) existingChart.destroy();

                new Chart(evolutionCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: years,
                        datasets: [
                            {
                                label: 'CA',
                                data: years.map(y => Mrd(yearsData[y].ca)),
                                backgroundColor: '#3b82f6',
                                borderRadius: 6
                            },
                            {
                                label: 'EBITDA',
                                data: years.map(y => Mrd(yearsData[y].ebitda)),
                                backgroundColor: '#10b981',
                                borderRadius: 6
                            },
                            {
                                label: 'RÃ©sultat Net',
                                data: years.map(y => Mrd(yearsData[y].resultatNet)),
                                backgroundColor: '#8b5cf6',
                                borderRadius: 6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: ctx => ctx.dataset.label + ': ' + fmtMrd(ctx.raw) + ' Mrd FCFA'
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: { callback: v => fmtMrd(v) + ' Mrd' }
                            }
                        }
                    }
                });
            }

            // Ratios Evolution Chart
            const ratiosCtx = document.getElementById('ratiosEvolutionChart');
            if (ratiosCtx) {
                const existingChart = Chart.getChart(ratiosCtx);
                if (existingChart) existingChart.destroy();

                new Chart(ratiosCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: [
                            {
                                label: 'Marge EBITDA %',
                                data: years.map(y => yearsData[y].margeEbitda.toFixed(1)),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'ROE %',
                                data: years.map(y => yearsData[y].roe.toFixed(1)),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Marge Nette %',
                                data: years.map(y => yearsData[y].margeNette.toFixed(1)),
                                borderColor: '#8b5cf6',
                                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                fill: true,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: ctx => ctx.dataset.label + ': ' + ctx.raw + '%'
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: { callback: v => v + '%' }
                            }
                        }
                    }
                });
            }

            // Variation Table
            updateVariationTable(years);
        }

        function updateVariationTable(years) {
            if (years.length < 2) return;

            const y1 = years[years.length - 2];
            const y2 = years[years.length - 1];
            const d1 = yearsData[y1];
            const d2 = yearsData[y2];

            document.getElementById('varYear1').textContent = y1;
            document.getElementById('varYear2').textContent = y2;

            const M = n => Math.round((n || 0) / 1000000);
            const pct = (o, n) => o ? (((n - o) / Math.abs(o)) * 100).toFixed(1) : '-';
            const fmt = n => new Intl.NumberFormat('fr-FR').format(n);

            const indicators = [
                { label: "Chiffre d'affaires", key: 'ca' },
                { label: "Marge Brute", key: 'margeBrute' },
                { label: "EBITDA", key: 'ebitda' },
                { label: "RÃ©sultat d'exploitation", key: 'ebit' },
                { label: "RÃ©sultat Net", key: 'resultatNet' },
                { label: "Capitaux propres", key: 'capitauxPropres' },
                { label: "Total Actif", key: 'totalActif' },
                { label: "BFR", key: 'bfr' }
            ];

            const tbody = document.getElementById('variationTableBody');
            tbody.innerHTML = indicators.map(ind => {
                const v1 = M(d1[ind.key]);
                const v2 = M(d2[ind.key]);
                const variation = v2 - v1;
                const pctVar = pct(d1[ind.key], d2[ind.key]);
                const isPositive = variation >= 0;

                return `<tr>
                    <td>${ind.label}</td>
                    <td style="text-align: right;">${fmt(v1)}</td>
                    <td style="text-align: right;">${fmt(v2)}</td>
                    <td style="text-align: right; color: ${isPositive ? 'var(--green-600)' : 'var(--red-500)'};">${isPositive ? '+' : ''}${fmt(variation)}</td>
                    <td style="text-align: right; color: ${isPositive ? 'var(--green-600)' : 'var(--red-500)'};">${isPositive ? '+' : ''}${pctVar}%</td>
                </tr>`;
            }).join('');
        }

        // Call updateEvolutionPage when data changes
        const originalUpdateEvolutionChart = updateEvolutionChart;
        updateEvolutionChart = function() {
            originalUpdateEvolutionChart();
            updateEvolutionPage();
        };

        // ========== EXPORT FUNCTIONS ==========
        function exportToExcel(type) {
            if (!currentYear || !yearsData[currentYear]) {
                alert('Veuillez d\'abord charger une balance comptable');
                return;
            }

            const data = yearsData[currentYear];
            const years = Object.keys(yearsData).sort();
            const yearN = currentYear || years[years.length - 1];
            const yearN1Index = years.indexOf(yearN) - 1;
            const yearN1 = yearN1Index >= 0 ? years[yearN1Index] : null;
            const hasComparison = yearN1 !== null;
            const dataN1 = hasComparison ? yearsData[yearN1] : null;
            
            const fmt = n => Math.round((n || 0) / 1000000);
            const fmtVar = (n, n1) => {
                if (n1 === null || n1 === undefined || n1 === 0) return '-';
                const pct = ((n - n1) / Math.abs(n1)) * 100;
                const sign = pct >= 0 ? '+' : '';
                return sign + pct.toFixed(1) + '%';
            };
            
            let wsData = [];
            let fileName = '';

            if (type === 'pnl') {
                fileName = hasComparison ? `Compte_Resultat_${yearN1}_${yearN}.xlsx` : `Compte_Resultat_${yearN}.xlsx`;

                const pnlStructure = [
                    { label: "CHIFFRE D'AFFAIRES", key: 'ca' },
                    { label: "Achats consommÃ©s", key: 'achats', neg: true },
                    { label: "Variation de stocks", key: 'varStocks' },
                    { label: "MARGE BRUTE", key: 'margeBrute' },
                    { label: "Transports", key: 'transports', neg: true },
                    { label: "Services extÃ©rieurs", key: 'servicesExt', neg: true },
                    { label: "Autres services", key: 'autresServices', neg: true },
                    { label: "ImpÃ´ts et taxes", key: 'impotsTaxes', neg: true },
                    { label: "Autres charges", key: 'autresCharges', neg: true },
                    { label: "Charges de personnel", key: 'personnel', neg: true },
                    { label: "EBITDA", key: 'ebitda' },
                    { label: "Dotations aux amortissements", key: 'dotations', neg: true },
                    { label: "RÃ‰SULTAT D'EXPLOITATION (EBIT)", key: 'ebit' },
                    { label: "Produits financiers", key: 'prodFin' },
                    { label: "Charges financiÃ¨res", key: 'chgFin', neg: true },
                    { label: "RÃ‰SULTAT FINANCIER", key: 'resultatFin' },
                    { label: "RÃ‰SULTAT NET", key: 'resultatNet' }
                ];

                if (hasComparison) {
                    wsData.push(['LibellÃ©', `${yearN1} (M)`, `${yearN} (M)`, 'Var %']);
                    pnlStructure.forEach(row => {
                        const valN1 = row.neg ? -fmt(dataN1[row.key]) : fmt(dataN1[row.key]);
                        const valN = row.neg ? -fmt(data[row.key]) : fmt(data[row.key]);
                        wsData.push([row.label, valN1, valN, fmtVar(valN, valN1)]);
                    });
                } else {
                    wsData.push(['LibellÃ©', `${yearN} (M FCFA)`]);
                    pnlStructure.forEach(row => {
                        const val = row.neg ? -fmt(data[row.key]) : fmt(data[row.key]);
                        wsData.push([row.label, val]);
                    });
                }
            } else if (type === 'bilan') {
                const hasN1 = hasComparison && dataN1 !== null;
                fileName = hasN1 ? `Bilan_${yearN1}_${yearN}.xlsx` : `Bilan_${yearN}.xlsx`;

                // ACTIF
                if (hasN1) {
                    wsData.push(['ACTIF', `${yearN1} (M)`, `${yearN} (M)`, 'Var %']);
                } else {
                    wsData.push(['ACTIF', 'Montant (M FCFA)']);
                }

                const actifRows = [
                    { label: 'ACTIF IMMOBILISÃ‰', key: 'immoNet' },
                    { label: '  Immo. incorporelles', key: 'immoIncorp' },
                    { label: '  Immo. corporelles', key: 'immoCorp' },
                    { label: '  Immo. financiÃ¨res', key: 'immoFin' },
                    { label: 'ACTIF CIRCULANT', key: 'actifCirculant' },
                    { label: '  Stocks', key: 'stocks' },
                    { label: '  Clients', key: 'clients' },
                    { label: '  Autres crÃ©ances', key: 'autresCreances' },
                    { label: 'TRÃ‰SORERIE ACTIF', key: 'tresoActif' },
                    { label: '  Banques', key: 'banques' },
                    { label: '  Caisse', key: 'caisse' },
                    { label: 'TOTAL ACTIF', key: 'totalActif' }
                ];

                actifRows.forEach(row => {
                    const valN = fmt(data[row.key]);
                    if (hasN1) {
                        const valN1 = fmt(dataN1[row.key]);
                        wsData.push([row.label, valN1, valN, fmtVar(data[row.key], dataN1[row.key])]);
                    } else {
                        wsData.push([row.label, valN]);
                    }
                });

                wsData.push([]);

                // PASSIF
                if (hasN1) {
                    wsData.push(['PASSIF', `${yearN1} (M)`, `${yearN} (M)`, 'Var %']);
                } else {
                    wsData.push(['PASSIF', 'Montant (M FCFA)']);
                }

                const passifRows = [
                    { label: 'CAPITAUX PROPRES', key: 'capitauxPropres' },
                    { label: '  Capital social', key: 'capital' },
                    { label: '  RÃ©serves', key: 'reserves' },
                    { label: '  Report Ã  nouveau', key: 'reportAN' },
                    { label: 'DETTES FINANCIÃˆRES', key: 'totalDetteFin' },
                    { label: '  Emprunts', key: 'emprunts' },
                    { label: '  Autres dettes fin.', key: 'autresDetteFin' },
                    { label: 'PROVISIONS RISQUES', key: 'provisionsRisques' },
                    { label: 'PASSIF CIRCULANT', key: 'passifCirculant' },
                    { label: '  Fournisseurs', key: 'fournisseurs' },
                    { label: '  Dettes fiscales', key: 'dettesFiscales' },
                    { label: '  Dettes sociales', key: 'dettesSociales' },
                    { label: '  Autres dettes', key: 'autresDettes' },
                    { label: 'TOTAL PASSIF', key: 'totalPassif' }
                ];

                passifRows.forEach(row => {
                    const valN = fmt(data[row.key]);
                    if (hasN1) {
                        const valN1 = fmt(dataN1[row.key]);
                        wsData.push([row.label, valN1, valN, fmtVar(data[row.key], dataN1[row.key])]);
                    } else {
                        wsData.push([row.label, valN]);
                    }
                });
            } else if (type === 'ratios') {
                fileName = `Ratios_${currentYear}.xlsx`;
                wsData.push(['Ratio', 'Valeur', 'Benchmark']);
                wsData.push(['ROE', data.roe.toFixed(1) + '%', '> 15%']);
                wsData.push(['ROA', data.roi.toFixed(1) + '%', '> 5%']);
                wsData.push(['Marge Brute', data.margeBrutePct.toFixed(1) + '%', '> 20%']);
                wsData.push(['Marge EBITDA', data.margeEbitda.toFixed(1) + '%', '> 15%']);
                wsData.push(['Marge Nette', data.margeNette.toFixed(1) + '%', '> 5%']);
                wsData.push(['Current Ratio', data.currentRatio.toFixed(2), '> 1.5']);
                wsData.push(['Quick Ratio', data.quickRatio.toFixed(2), '> 1']);
                wsData.push(['BFR (jours CA)', data.bfrJours, '< 60 jours']);
                wsData.push(['Dette Nette / EBITDA', data.netDebtEbitda.toFixed(1) + 'x', '< 3x']);
            } else if (type === 'cashflow') {
                fileName = `CashFlow_${currentYear}.xlsx`;
                wsData.push(['FLUX DE TRÃ‰SORERIE', 'Montant (M FCFA)']);
                wsData.push(['RÃ©sultat net', fmt(data.resultatNet)]);
                wsData.push(['Dotations aux amortissements', fmt(data.dotations)]);
                wsData.push(['Reprises de provisions', -fmt(data.reprises)]);
                wsData.push(['CapacitÃ© d\'autofinancement (CAF)', fmt(data.caf)]);
            }

            // CrÃ©er un fichier Excel XLS avec formatage HTML
            const fmtNum = n => {
                if (n === null || n === undefined || n === '') return '';
                return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            };

            // GÃ©nÃ©rer le HTML pour Excel avec styles
            let htmlContent = `
<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel">
<head>
<meta charset="UTF-8">
<!--[if gte mso 9]><xml>
<x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet>
<x:Name>${type.toUpperCase()}</x:Name>
<x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions>
</x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook>
</xml><![endif]-->
<style>
td, th { mso-number-format:"\\@"; }
</style>
</head>
<body>
<table border="1" cellspacing="0" cellpadding="5">
`;

            // Construire le tableau selon le type
            if (type === 'pnl') {
                const pnlRows = [
                    { label: "CHIFFRE D'AFFAIRES", key: 'ca', bold: true },
                    { label: "Achats consommÃ©s", key: 'achats', neg: true },
                    { label: "Variation de stocks", key: 'varStocks' },
                    { label: "MARGE BRUTE", key: 'margeBrute', bold: true },
                    { label: "Transports", key: 'transports', neg: true },
                    { label: "Services extÃ©rieurs", key: 'servicesExt', neg: true },
                    { label: "Autres services", key: 'autresServices', neg: true },
                    { label: "ImpÃ´ts et taxes", key: 'impotsTaxes', neg: true },
                    { label: "Autres charges", key: 'autresCharges', neg: true },
                    { label: "Charges de personnel", key: 'personnel', neg: true },
                    { label: "EBITDA", key: 'ebitda', bold: true },
                    { label: "Dotations aux amortissements", key: 'dotations', neg: true },
                    { label: "Reprises de provisions", key: 'reprises' },
                    { label: "RÃ‰SULTAT D'EXPLOITATION (EBIT)", key: 'ebit', bold: true },
                    { label: "Produits financiers", key: 'prodFin' },
                    { label: "Charges financiÃ¨res", key: 'chgFin', neg: true },
                    { label: "RÃ‰SULTAT FINANCIER", key: 'resultatFin', bold: true },
                    { label: "RÃ‰SULTAT NET", key: 'resultatNet', total: true }
                ];

                if (hasComparison) {
                    htmlContent += `<tr>
                        <th style="background-color:#1E40AF;color:white;font-weight:bold;">LibellÃ©</th>
                        <th style="background-color:#1E40AF;color:white;font-weight:bold;text-align:right;">${yearN1} (M FCFA)</th>
                        <th style="background-color:#1E40AF;color:white;font-weight:bold;text-align:right;">${yearN} (M FCFA)</th>
                        <th style="background-color:#1E40AF;color:white;font-weight:bold;text-align:right;">Var %</th>
                    </tr>`;
                    pnlRows.forEach(row => {
                        const valN1 = row.neg ? -fmt(dataN1[row.key]) : fmt(dataN1[row.key]);
                        const valN = row.neg ? -fmt(data[row.key]) : fmt(data[row.key]);
                        let style = '';
                        if (row.total) {
                            style = 'background-color:#DBEAFE;font-weight:bold;';
                        } else if (row.bold) {
                            style = 'background-color:#F1F5F9;font-weight:bold;';
                        }
                        htmlContent += `<tr>
                            <td style="${style}">${row.label}</td>
                            <td style="${style}text-align:right;">${fmtNum(valN1)}</td>
                            <td style="${style}text-align:right;">${fmtNum(valN)}</td>
                            <td style="${style}text-align:right;">${fmtVar(valN, valN1)}</td>
                        </tr>`;
                    });
                } else {
                    htmlContent += `<tr>
                        <th style="background-color:#1E40AF;color:white;font-weight:bold;">LibellÃ©</th>
                        <th style="background-color:#1E40AF;color:white;font-weight:bold;text-align:right;">${yearN} (M FCFA)</th>
                    </tr>`;
                    pnlRows.forEach(row => {
                        const val = row.neg ? -fmt(data[row.key]) : fmt(data[row.key]);
                        let style = '';
                        if (row.total) {
                            style = 'background-color:#DBEAFE;font-weight:bold;';
                        } else if (row.bold) {
                            style = 'background-color:#F1F5F9;font-weight:bold;';
                        }
                        htmlContent += `<tr>
                            <td style="${style}">${row.label}</td>
                            <td style="${style}text-align:right;">${fmtNum(val)}</td>
                        </tr>`;
                    });
                }
            } else if (type === 'bilan') {
                const hasN1 = hasComparison && dataN1 !== null;

                // ACTIF Header
                if (hasN1) {
                    htmlContent += `<tr>
                        <th style="background-color:#1E40AF;color:white;font-weight:bold;">ACTIF</th>
                        <th style="background-color:#1E40AF;color:white;font-weight:bold;text-align:right;">${yearN1} (M FCFA)</th>
                        <th style="background-color:#1E40AF;color:white;font-weight:bold;text-align:right;">${yearN} (M FCFA)</th>
                        <th style="background-color:#1E40AF;color:white;font-weight:bold;text-align:right;">Var %</th>
                    </tr>`;
                } else {
                    htmlContent += `<tr>
                        <th style="background-color:#1E40AF;color:white;font-weight:bold;">ACTIF</th>
                        <th style="background-color:#1E40AF;color:white;font-weight:bold;text-align:right;">Montant (M FCFA)</th>
                    </tr>`;
                }

                const actifRows = [
                    { label: 'ACTIF IMMOBILISÃ‰', key: 'immoNet', bold: true },
                    { label: '   Immo. incorporelles', key: 'immoIncorp' },
                    { label: '   Immo. corporelles', key: 'immoCorp' },
                    { label: '   Immo. financiÃ¨res', key: 'immoFin' },
                    { label: 'ACTIF CIRCULANT', key: 'actifCirculant', bold: true },
                    { label: '   Stocks', key: 'stocks' },
                    { label: '   Clients', key: 'clients' },
                    { label: '   Autres crÃ©ances', key: 'autresCreances' },
                    { label: 'TRÃ‰SORERIE ACTIF', key: 'tresoActif', bold: true },
                    { label: '   Banques', key: 'banques' },
                    { label: '   Caisse', key: 'caisse' },
                    { label: 'TOTAL ACTIF', key: 'totalActif', total: true }
                ];

                actifRows.forEach(row => {
                    const valN = fmt(data[row.key]);
                    let style = '';
                    if (row.total) {
                        style = 'background-color:#DBEAFE;font-weight:bold;';
                    } else if (row.bold) {
                        style = 'background-color:#F1F5F9;font-weight:bold;';
                    }
                    if (hasN1) {
                        const valN1 = fmt(dataN1[row.key]);
                        htmlContent += `<tr>
                            <td style="${style}">${row.label}</td>
                            <td style="${style}text-align:right;">${fmtNum(valN1)}</td>
                            <td style="${style}text-align:right;">${fmtNum(valN)}</td>
                            <td style="${style}text-align:right;">${fmtVar(data[row.key], dataN1[row.key])}</td>
                        </tr>`;
                    } else {
                        htmlContent += `<tr>
                            <td style="${style}">${row.label}</td>
                            <td style="${style}text-align:right;">${fmtNum(valN)}</td>
                        </tr>`;
                    }
                });

                // Ligne vide
                htmlContent += `<tr><td colspan="${hasN1 ? 4 : 2}">&nbsp;</td></tr>`;

                // PASSIF Header
                if (hasN1) {
                    htmlContent += `<tr>
                        <th style="background-color:#1E40AF;color:white;font-weight:bold;">PASSIF</th>
                        <th style="background-color:#1E40AF;color:white;font-weight:bold;text-align:right;">${yearN1} (M FCFA)</th>
                        <th style="background-color:#1E40AF;color:white;font-weight:bold;text-align:right;">${yearN} (M FCFA)</th>
                        <th style="background-color:#1E40AF;color:white;font-weight:bold;text-align:right;">Var %</th>
                    </tr>`;
                } else {
                    htmlContent += `<tr>
                        <th style="background-color:#1E40AF;color:white;font-weight:bold;">PASSIF</th>
                        <th style="background-color:#1E40AF;color:white;font-weight:bold;text-align:right;">Montant (M FCFA)</th>
                    </tr>`;
                }

                const passifRows = [
                    { label: 'CAPITAUX PROPRES', key: 'capitauxPropres', bold: true },
                    { label: '   Capital social', key: 'capital' },
                    { label: '   RÃ©serves', key: 'reserves' },
                    { label: '   Report Ã  nouveau', key: 'reportAN' },
                    { label: 'DETTES FINANCIÃˆRES', key: 'totalDetteFin', bold: true },
                    { label: '   Emprunts', key: 'emprunts' },
                    { label: '   Autres dettes fin.', key: 'autresDetteFin' },
                    { label: 'PROVISIONS RISQUES', key: 'provisionsRisques', bold: true },
                    { label: 'PASSIF CIRCULANT', key: 'passifCirculant', bold: true },
                    { label: '   Fournisseurs', key: 'fournisseurs' },
                    { label: '   Dettes fiscales', key: 'dettesFiscales' },
                    { label: '   Dettes sociales', key: 'dettesSociales' },
                    { label: '   Autres dettes', key: 'autresDettes' },
                    { label: 'TOTAL PASSIF', key: 'totalPassif', total: true }
                ];

                passifRows.forEach(row => {
                    const valN = fmt(data[row.key]);
                    let style = '';
                    if (row.total) {
                        style = 'background-color:#DBEAFE;font-weight:bold;';
                    } else if (row.bold) {
                        style = 'background-color:#F1F5F9;font-weight:bold;';
                    }
                    if (hasN1) {
                        const valN1 = fmt(dataN1[row.key]);
                        htmlContent += `<tr>
                            <td style="${style}">${row.label}</td>
                            <td style="${style}text-align:right;">${fmtNum(valN1)}</td>
                            <td style="${style}text-align:right;">${fmtNum(valN)}</td>
                            <td style="${style}text-align:right;">${fmtVar(data[row.key], dataN1[row.key])}</td>
                        </tr>`;
                    } else {
                        htmlContent += `<tr>
                            <td style="${style}">${row.label}</td>
                            <td style="${style}text-align:right;">${fmtNum(valN)}</td>
                        </tr>`;
                    }
                });
            } else if (type === 'ratios') {
                htmlContent += `<tr>
                    <th style="background-color:#1E40AF;color:white;font-weight:bold;">CatÃ©gorie</th>
                    <th style="background-color:#1E40AF;color:white;font-weight:bold;">Ratio</th>
                    <th style="background-color:#1E40AF;color:white;font-weight:bold;text-align:right;">Valeur</th>
                    <th style="background-color:#1E40AF;color:white;font-weight:bold;">Benchmark</th>
                    <th style="background-color:#1E40AF;color:white;font-weight:bold;text-align:center;">Statut</th>
                </tr>`;
                const ratiosData = [
                    ['ProfitabilitÃ©', 'Marge Brute', data.margeBrutePct.toFixed(1) + '%', '> 20%', data.margeBrutePct > 20],
                    ['ProfitabilitÃ©', 'Marge EBITDA', data.margeEbitda.toFixed(1) + '%', '> 15%', data.margeEbitda > 15],
                    ['ProfitabilitÃ©', 'Marge Nette', data.margeNette.toFixed(1) + '%', '> 5%', data.margeNette > 5],
                    ['RentabilitÃ©', 'ROE', data.roe.toFixed(1) + '%', '> 15%', data.roe > 15],
                    ['RentabilitÃ©', 'ROA', data.roi.toFixed(1) + '%', '> 5%', data.roi > 5],
                    ['LiquiditÃ©', 'Current Ratio', data.currentRatio.toFixed(2), '> 1.5', data.currentRatio > 1.5],
                    ['LiquiditÃ©', 'Quick Ratio', data.quickRatio.toFixed(2), '> 1', data.quickRatio > 1],
                    ['LiquiditÃ©', 'BFR (jours)', data.bfrJours + 'j', '< 60j', data.bfrJours < 60],
                    ['SolvabilitÃ©', 'Dette Nette/EBITDA', data.netDebtEbitda.toFixed(1) + 'x', '< 3x', data.netDebtEbitda < 3]
                ];
                ratiosData.forEach(r => {
                    const statusColor = r[4] ? '#10B981' : '#EF4444';
                    const statusBg = r[4] ? '#D1FAE5' : '#FEE2E2';
                    htmlContent += `<tr>
                        <td>${r[0]}</td>
                        <td>${r[1]}</td>
                        <td style="text-align:right;">${r[2]}</td>
                        <td>${r[3]}</td>
                        <td style="text-align:center;background-color:${statusBg};color:${statusColor};font-weight:bold;">${r[4] ? 'âœ“' : 'âš '}</td>
                    </tr>`;
                });
            } else if (type === 'cashflow') {
                // Cash Flow complet avec N-1 si disponible
                const years = Object.keys(yearsData).sort();
                const yearN1Index = years.indexOf(currentYear) - 1;
                const yearN1 = yearN1Index >= 0 ? years[yearN1Index] : null;
                const dataN1Cf = yearN1 ? yearsData[yearN1] : null;
                const hasN1Cf = dataN1Cf !== null;

                const M = n => Math.round((n || 0) / 1000000);
                const caf = M(data.caf);

                fileName = hasN1Cf ? `CashFlow_${yearN1}_${currentYear}.xls` : `CashFlow_${currentYear}.xls`;

                htmlContent += `<tr>
                    <th style="background-color:#1E40AF;color:white;font-weight:bold;" colspan="2">TABLEAU DES FLUX DE TRÃ‰SORERIE ${hasN1Cf ? yearN1 + ' â†’ ' + currentYear : currentYear}</th>
                </tr>
                <tr>
                    <th style="background-color:#1E40AF;color:white;font-weight:bold;">LibellÃ©</th>
                    <th style="background-color:#1E40AF;color:white;font-weight:bold;text-align:right;">Montant (M FCFA)</th>
                </tr>`;

                // Section A - Exploitation
                htmlContent += `<tr><td style="background-color:#E0E7FF;font-weight:bold;" colspan="2">A. FLUX DE TRÃ‰SORERIE LIÃ‰S Ã€ L'EXPLOITATION</td></tr>`;
                htmlContent += `<tr><td>RÃ©sultat net</td><td style="text-align:right;">${fmtNum(M(data.resultatNet))}</td></tr>`;
                htmlContent += `<tr><td>+ Dotations aux amortissements</td><td style="text-align:right;">${fmtNum(M(data.dotations))}</td></tr>`;
                htmlContent += `<tr><td>- Reprises de provisions</td><td style="text-align:right;">${fmtNum(-M(data.reprises))}</td></tr>`;
                htmlContent += `<tr><td style="background-color:#F1F5F9;font-weight:bold;">= CapacitÃ© d'autofinancement (CAF)</td><td style="background-color:#F1F5F9;font-weight:bold;text-align:right;">${fmtNum(caf)}</td></tr>`;

                if (hasN1Cf) {
                    const varStocks = M(data.stocks) - M(dataN1Cf.stocks);
                    const varClients = M(data.clients) - M(dataN1Cf.clients);
                    const varAutresCreances = M(data.autresCreances) - M(dataN1Cf.autresCreances);
                    const varFournisseurs = M(data.fournisseurs) - M(dataN1Cf.fournisseurs);
                    const varDettesFiscales = M(data.dettesFiscales) - M(dataN1Cf.dettesFiscales);
                    const varAutresDettes = M(data.autresDettes) - M(dataN1Cf.autresDettes);
                    const varBFR = (varStocks + varClients + varAutresCreances) - (varFournisseurs + varDettesFiscales + varAutresDettes);
                    const fluxExploitation = caf - varBFR;

                    htmlContent += `<tr><td colspan="2" style="font-style:italic;color:#64748b;">Variation du BFR :</td></tr>`;
                    htmlContent += `<tr><td style="padding-left:20px;">Î” Stocks</td><td style="text-align:right;">${fmtNum(-varStocks)}</td></tr>`;
                    htmlContent += `<tr><td style="padding-left:20px;">Î” Clients</td><td style="text-align:right;">${fmtNum(-varClients)}</td></tr>`;
                    htmlContent += `<tr><td style="padding-left:20px;">Î” Autres crÃ©ances</td><td style="text-align:right;">${fmtNum(-varAutresCreances)}</td></tr>`;
                    htmlContent += `<tr><td style="padding-left:20px;">Î” Fournisseurs</td><td style="text-align:right;">${fmtNum(varFournisseurs)}</td></tr>`;
                    htmlContent += `<tr><td style="padding-left:20px;">Î” Dettes fiscales & sociales</td><td style="text-align:right;">${fmtNum(varDettesFiscales)}</td></tr>`;
                    htmlContent += `<tr><td style="padding-left:20px;">Î” Autres dettes</td><td style="text-align:right;">${fmtNum(varAutresDettes)}</td></tr>`;
                    htmlContent += `<tr><td style="background-color:#F1F5F9;font-weight:bold;">= Variation du BFR</td><td style="background-color:#F1F5F9;font-weight:bold;text-align:right;">${fmtNum(-varBFR)}</td></tr>`;
                    htmlContent += `<tr><td style="background-color:#DBEAFE;font-weight:bold;">FLUX NET D'EXPLOITATION (A)</td><td style="background-color:#DBEAFE;font-weight:bold;text-align:right;">${fmtNum(fluxExploitation)}</td></tr>`;

                    // Section B - Investissement
                    const varImmo = (M(data.immoNet) - M(dataN1Cf.immoNet)) + M(data.dotations);
                    const fluxInvestissement = -varImmo;
                    htmlContent += `<tr><td style="background-color:#E0E7FF;font-weight:bold;" colspan="2">B. FLUX DE TRÃ‰SORERIE LIÃ‰S Ã€ L'INVESTISSEMENT</td></tr>`;
                    htmlContent += `<tr><td>Acquisitions d'immobilisations (estimÃ©es)</td><td style="text-align:right;">${fmtNum(-varImmo)}</td></tr>`;
                    htmlContent += `<tr><td style="background-color:#DBEAFE;font-weight:bold;">FLUX NET D'INVESTISSEMENT (B)</td><td style="background-color:#DBEAFE;font-weight:bold;text-align:right;">${fmtNum(fluxInvestissement)}</td></tr>`;

                    // Section C - Financement
                    const varEmprunts = M(data.emprunts) - M(dataN1Cf.emprunts);
                    const varCapital = M(data.capital) - M(dataN1Cf.capital);
                    const varReserves = M(data.reserves) - M(dataN1Cf.reserves);
                    const fluxFinancement = varEmprunts + varCapital + varReserves;
                    htmlContent += `<tr><td style="background-color:#E0E7FF;font-weight:bold;" colspan="2">C. FLUX DE TRÃ‰SORERIE LIÃ‰S AU FINANCEMENT</td></tr>`;
                    htmlContent += `<tr><td>Î” Emprunts</td><td style="text-align:right;">${fmtNum(varEmprunts)}</td></tr>`;
                    htmlContent += `<tr><td>Î” Capital et rÃ©serves</td><td style="text-align:right;">${fmtNum(varCapital + varReserves)}</td></tr>`;
                    htmlContent += `<tr><td style="background-color:#DBEAFE;font-weight:bold;">FLUX NET DE FINANCEMENT (C)</td><td style="background-color:#DBEAFE;font-weight:bold;text-align:right;">${fmtNum(fluxFinancement)}</td></tr>`;

                    // Total
                    const varTreso = fluxExploitation + fluxInvestissement + fluxFinancement;
                    htmlContent += `<tr><td>&nbsp;</td><td></td></tr>`;
                    htmlContent += `<tr><td style="background-color:#1E3A5F;color:white;font-weight:bold;">VARIATION DE TRÃ‰SORERIE (A + B + C)</td><td style="background-color:#1E3A5F;color:white;font-weight:bold;text-align:right;">${fmtNum(varTreso)}</td></tr>`;

                    // RÃ©conciliation
                    const tresoN = M(data.tresoActif);
                    const tresoN1 = M(dataN1Cf.tresoActif);
                    htmlContent += `<tr><td>&nbsp;</td><td></td></tr>`;
                    htmlContent += `<tr><td>TrÃ©sorerie ${yearN1}</td><td style="text-align:right;">${fmtNum(tresoN1)}</td></tr>`;
                    htmlContent += `<tr><td>TrÃ©sorerie ${currentYear}</td><td style="text-align:right;">${fmtNum(tresoN)}</td></tr>`;
                    htmlContent += `<tr><td style="font-weight:bold;">Variation rÃ©elle</td><td style="font-weight:bold;text-align:right;">${fmtNum(tresoN - tresoN1)}</td></tr>`;
                } else {
                    htmlContent += `<tr><td colspan="2" style="color:#64748b;font-style:italic;">Variation du BFR : donnÃ©es N-1 requises</td></tr>`;
                    htmlContent += `<tr><td style="background-color:#E0E7FF;font-weight:bold;" colspan="2">B. FLUX DE TRÃ‰SORERIE LIÃ‰S Ã€ L'INVESTISSEMENT</td></tr>`;
                    htmlContent += `<tr><td colspan="2" style="color:#64748b;font-style:italic;">DonnÃ©es N-1 requises</td></tr>`;
                    htmlContent += `<tr><td style="background-color:#E0E7FF;font-weight:bold;" colspan="2">C. FLUX DE TRÃ‰SORERIE LIÃ‰S AU FINANCEMENT</td></tr>`;
                    htmlContent += `<tr><td colspan="2" style="color:#64748b;font-style:italic;">DonnÃ©es N-1 requises</td></tr>`;
                    htmlContent += `<tr><td>&nbsp;</td><td></td></tr>`;
                    htmlContent += `<tr><td style="background-color:#F1F5F9;font-weight:bold;">TrÃ©sorerie nette ${currentYear}</td><td style="background-color:#F1F5F9;font-weight:bold;text-align:right;">${fmtNum(M(data.tresoActif))}</td></tr>`;
                }
            }

            htmlContent += `</table></body></html>`;

            // TÃ©lÃ©charger le fichier en .xls
            const blob = new Blob(['\ufeff' + htmlContent], { type: 'application/vnd.ms-excel;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName.replace('.xlsx', '.xls');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportToPDF(type) {
            if (!currentYear || !yearsData[currentYear]) {
                alert('Veuillez d\'abord charger une balance comptable');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const data = yearsData[currentYear];
            // Format: espace insÃ©cable comme sÃ©parateur de milliers
            const fmt = n => {
                const val = Math.round((n || 0) / 1000000);
                return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            };

            // Header
            doc.setFontSize(20);
            doc.setTextColor(30, 64, 175);
            
            let title = '';
            let tableData = [];
            let headers = [];

            if (type === 'pnl') {
                // Check for comparison data
                const years = Object.keys(yearsData).sort();
                const yearN = currentYear || years[years.length - 1];
                const yearN1Index = years.indexOf(yearN) - 1;
                const yearN1 = yearN1Index >= 0 ? years[yearN1Index] : null;
                const dataN1 = yearN1 ? yearsData[yearN1] : null;
                const hasN1 = dataN1 !== null;

                const fmtVar = (n, n1) => {
                    if (n1 === null || n1 === undefined || n1 === 0) return '-';
                    const pct = ((n - n1) / Math.abs(n1)) * 100;
                    const sign = pct >= 0 ? '+' : '';
                    return sign + pct.toFixed(1) + '%';
                };

                title = hasN1 ? `Compte de RÃ©sultat ${yearN1} - ${yearN}` : `Compte de RÃ©sultat - ${yearN}`;
                
                const pnlRows = [
                    { label: "CHIFFRE D'AFFAIRES", key: 'ca', bold: true },
                    { label: "Achats consommÃ©s", key: 'achats', neg: true },
                    { label: "Variation de stocks", key: 'varStocks' },
                    { label: "MARGE BRUTE", key: 'margeBrute', bold: true },
                    { label: "Transports", key: 'transports', neg: true },
                    { label: "Services extÃ©rieurs", key: 'servicesExt', neg: true },
                    { label: "Autres services", key: 'autresServices', neg: true },
                    { label: "ImpÃ´ts et taxes", key: 'impotsTaxes', neg: true },
                    { label: "Autres charges", key: 'autresCharges', neg: true },
                    { label: "Charges de personnel", key: 'personnel', neg: true },
                    { label: "EBITDA", key: 'ebitda', bold: true },
                    { label: "Dotations aux amortissements", key: 'dotations', neg: true },
                    { label: "Reprises de provisions", key: 'reprises' },
                    { label: "RÃ‰SULTAT D'EXPLOITATION (EBIT)", key: 'ebit', bold: true },
                    { label: "Produits financiers", key: 'prodFin' },
                    { label: "Charges financiÃ¨res", key: 'chgFin', neg: true },
                    { label: "RÃ‰SULTAT FINANCIER", key: 'resultatFin', bold: true },
                    { label: "Produits HAO", key: 'prodHAO' },
                    { label: "Charges HAO", key: 'chgHAO', neg: true },
                    { label: "RÃ‰SULTAT HAO", key: 'resultatHAO', bold: true },
                    { label: "ImpÃ´ts sur les bÃ©nÃ©fices", key: 'impotBIC', neg: true },
                    { label: "RÃ‰SULTAT NET", key: 'resultatNet', bold: true, total: true }
                ];

                if (hasN1) {
                    headers = [['LibellÃ©', yearN1 + ' (M)', yearN + ' (M)', 'Var %']];
                    tableData = pnlRows.map(row => {
                        const valN1 = row.neg ? -Math.round(dataN1[row.key] / 1000000) : Math.round(dataN1[row.key] / 1000000);
                        const valN = row.neg ? -Math.round(data[row.key] / 1000000) : Math.round(data[row.key] / 1000000);
                        return [
                            row.label,
                            valN1.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' '),
                            valN.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' '),
                            fmtVar(valN, valN1)
                        ];
                    });
                } else {
                    headers = [['LibellÃ©', 'Montant (M FCFA)']];
                    tableData = pnlRows.map(row => {
                        const val = row.neg ? -Math.round(data[row.key] / 1000000) : Math.round(data[row.key] / 1000000);
                        return [row.label, val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ')];
                    });
                }

                // Trouver l'index de la ligne RÃ©sultat Net pour la styliser
                const resultatNetIndex = pnlRows.findIndex(r => r.total);

                doc.text(title, 14, 22);
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text('GÃ©nÃ©rÃ© par Findalyx - ' + new Date().toLocaleDateString('fr-FR'), 14, 30);

                doc.autoTable({
                    head: headers,
                    body: tableData,
                    startY: 40,
                    theme: 'striped',
                    headStyles: { fillColor: [30, 64, 175], fontSize: 9 },
                    styles: { fontSize: 9, cellPadding: 3 },
                    didParseCell: function(data) {
                        // Ligne RÃ©sultat Net en bleu clair
                        if (data.section === 'body' && data.row.index === resultatNetIndex) {
                            data.cell.styles.fillColor = [219, 234, 254]; // bleu clair
                            data.cell.styles.fontStyle = 'bold';
                        }
                    }
                });

                doc.save(`PnL_${currentYear}.pdf`);
                return;
            } else if (type === 'bilan') {
                // Check for comparison data
                const years = Object.keys(yearsData).sort();
                const yearN = currentYear || years[years.length - 1];
                const yearN1Index = years.indexOf(yearN) - 1;
                const yearN1 = yearN1Index >= 0 ? years[yearN1Index] : null;
                const dataN1 = yearN1 ? yearsData[yearN1] : null;
                const hasN1 = dataN1 !== null;

                const fmtN1 = n => {
                    const val = Math.round((n || 0) / 1000000);
                    return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
                };
                const fmtVar = (n, n1) => {
                    if (n1 === null || n1 === undefined || n1 === 0) return '-';
                    const pct = ((n - n1) / Math.abs(n1)) * 100;
                    const sign = pct >= 0 ? '+' : '';
                    return sign + pct.toFixed(0) + '%';
                };

                // PDF en mode paysage pour tout mettre sur 1 page
                const docLandscape = new jsPDF('landscape');
                
                title = hasN1 ? `Bilan Comparatif ${yearN1} - ${yearN}` : `Bilan - ${yearN}`;
                docLandscape.setFontSize(14);
                docLandscape.setTextColor(30, 64, 175);
                docLandscape.text(title, 14, 15);
                docLandscape.setFontSize(8);
                docLandscape.setTextColor(100);
                docLandscape.text('GÃ©nÃ©rÃ© par Findalyx - ' + new Date().toLocaleDateString('fr-FR'), 14, 21);

                // Style commun pour les tableaux compacts
                const tableStyles = {
                    theme: 'grid',
                    headStyles: { fillColor: [30, 64, 175], fontSize: 7, cellPadding: 1.5, halign: 'right' },
                    styles: { fontSize: 7, cellPadding: 1.5 },
                    didParseCell: function(data) {
                        // PremiÃ¨re colonne des headers alignÃ©e Ã  gauche
                        if (data.section === 'head' && data.column.index === 0) {
                            data.cell.styles.halign = 'left';
                        }
                        // Sous-totaux en gras avec fond gris
                        if (data.section === 'body') {
                            const label = data.row.raw[0];
                            if (label && !label.startsWith('  ') && !label.startsWith('TOTAL')) {
                                data.cell.styles.fontStyle = 'bold';
                                data.cell.styles.fillColor = [241, 245, 249];
                            }
                            // Total en bleu clair
                            if (label && label.startsWith('TOTAL')) {
                                data.cell.styles.fontStyle = 'bold';
                                data.cell.styles.fillColor = [219, 234, 254];
                            }
                        }
                    }
                };

                // Tableau ACTIF (gauche)
                const actifHeaders = hasN1 
                    ? [['ACTIF', `${yearN1} (M)`, `${yearN} (M)`, 'Var']]
                    : [['ACTIF', 'M FCFA']];
                
                const actifData = hasN1 ? [
                    ['ACTIF IMMOBILISÃ‰', fmtN1(dataN1.immoNet), fmt(data.immoNet), fmtVar(data.immoNet, dataN1.immoNet)],
                    ['  Immo. incorporelles', fmtN1(dataN1.immoIncorp), fmt(data.immoIncorp), fmtVar(data.immoIncorp, dataN1.immoIncorp)],
                    ['  Immo. corporelles', fmtN1(dataN1.immoCorp), fmt(data.immoCorp), fmtVar(data.immoCorp, dataN1.immoCorp)],
                    ['  Immo. financiÃ¨res', fmtN1(dataN1.immoFin), fmt(data.immoFin), fmtVar(data.immoFin, dataN1.immoFin)],
                    ['ACTIF CIRCULANT', fmtN1(dataN1.actifCirculant), fmt(data.actifCirculant), fmtVar(data.actifCirculant, dataN1.actifCirculant)],
                    ['  Stocks', fmtN1(dataN1.stocks), fmt(data.stocks), fmtVar(data.stocks, dataN1.stocks)],
                    ['  Clients', fmtN1(dataN1.clients), fmt(data.clients), fmtVar(data.clients, dataN1.clients)],
                    ['  Autres crÃ©ances', fmtN1(dataN1.autresCreances), fmt(data.autresCreances), fmtVar(data.autresCreances, dataN1.autresCreances)],
                    ['TRÃ‰SORERIE ACTIF', fmtN1(dataN1.tresoActif), fmt(data.tresoActif), fmtVar(data.tresoActif, dataN1.tresoActif)],
                    ['  Banques', fmtN1(dataN1.banques), fmt(data.banques), fmtVar(data.banques, dataN1.banques)],
                    ['  Caisse', fmtN1(dataN1.caisse), fmt(data.caisse), fmtVar(data.caisse, dataN1.caisse)],
                    ['TOTAL ACTIF', fmtN1(dataN1.totalActif), fmt(data.totalActif), fmtVar(data.totalActif, dataN1.totalActif)]
                ] : [
                    ['ACTIF IMMOBILISÃ‰', fmt(data.immoNet)],
                    ['  Immo. incorporelles', fmt(data.immoIncorp)],
                    ['  Immo. corporelles', fmt(data.immoCorp)],
                    ['  Immo. financiÃ¨res', fmt(data.immoFin)],
                    ['ACTIF CIRCULANT', fmt(data.actifCirculant)],
                    ['  Stocks', fmt(data.stocks)],
                    ['  Clients', fmt(data.clients)],
                    ['  Autres crÃ©ances', fmt(data.autresCreances)],
                    ['TRÃ‰SORERIE ACTIF', fmt(data.tresoActif)],
                    ['  Banques', fmt(data.banques)],
                    ['  Caisse', fmt(data.caisse)],
                    ['TOTAL ACTIF', fmt(data.totalActif)]
                ];

                docLandscape.autoTable({
                    head: actifHeaders,
                    body: actifData,
                    startY: 25,
                    margin: { left: 14 },
                    tableWidth: 130,
                    ...tableStyles,
                    columnStyles: hasN1 ? {
                        0: { cellWidth: 55 },
                        1: { cellWidth: 25, halign: 'right' },
                        2: { cellWidth: 25, halign: 'right' },
                        3: { cellWidth: 18, halign: 'right' }
                    } : {
                        0: { cellWidth: 80 },
                        1: { cellWidth: 40, halign: 'right' }
                    }
                });

                // Tableau PASSIF (droite)
                const passifHeaders = hasN1 
                    ? [['PASSIF', `${yearN1} (M)`, `${yearN} (M)`, 'Var']]
                    : [['PASSIF', 'M FCFA']];
                
                const passifData = hasN1 ? [
                    ['CAPITAUX PROPRES', fmtN1(dataN1.capitauxPropres), fmt(data.capitauxPropres), fmtVar(data.capitauxPropres, dataN1.capitauxPropres)],
                    ['  Capital social', fmtN1(dataN1.capital), fmt(data.capital), fmtVar(data.capital, dataN1.capital)],
                    ['  RÃ©serves', fmtN1(dataN1.reserves), fmt(data.reserves), fmtVar(data.reserves, dataN1.reserves)],
                    ['  Report Ã  nouveau', fmtN1(dataN1.reportAN), fmt(data.reportAN), fmtVar(data.reportAN, dataN1.reportAN)],
                    ['DETTES FINANCIÃˆRES', fmtN1(dataN1.totalDetteFin), fmt(data.totalDetteFin), fmtVar(data.totalDetteFin, dataN1.totalDetteFin)],
                    ['  Emprunts', fmtN1(dataN1.emprunts), fmt(data.emprunts), fmtVar(data.emprunts, dataN1.emprunts)],
                    ['PROVISIONS RISQUES', fmtN1(dataN1.provisionsRisques), fmt(data.provisionsRisques), fmtVar(data.provisionsRisques, dataN1.provisionsRisques)],
                    ['PASSIF CIRCULANT', fmtN1(dataN1.passifCirculant), fmt(data.passifCirculant), fmtVar(data.passifCirculant, dataN1.passifCirculant)],
                    ['  Fournisseurs', fmtN1(dataN1.fournisseurs), fmt(data.fournisseurs), fmtVar(data.fournisseurs, dataN1.fournisseurs)],
                    ['  Dettes fiscales', fmtN1(dataN1.dettesFiscales), fmt(data.dettesFiscales), fmtVar(data.dettesFiscales, dataN1.dettesFiscales)],
                    ['  Autres dettes', fmtN1(dataN1.autresDettes), fmt(data.autresDettes), fmtVar(data.autresDettes, dataN1.autresDettes)],
                    ['TOTAL PASSIF', fmtN1(dataN1.totalPassif), fmt(data.totalPassif), fmtVar(data.totalPassif, dataN1.totalPassif)]
                ] : [
                    ['CAPITAUX PROPRES', fmt(data.capitauxPropres)],
                    ['  Capital social', fmt(data.capital)],
                    ['  RÃ©serves', fmt(data.reserves)],
                    ['  Report Ã  nouveau', fmt(data.reportAN)],
                    ['DETTES FINANCIÃˆRES', fmt(data.totalDetteFin)],
                    ['  Emprunts', fmt(data.emprunts)],
                    ['PROVISIONS RISQUES', fmt(data.provisionsRisques)],
                    ['PASSIF CIRCULANT', fmt(data.passifCirculant)],
                    ['  Fournisseurs', fmt(data.fournisseurs)],
                    ['  Dettes fiscales', fmt(data.dettesFiscales)],
                    ['  Autres dettes', fmt(data.autresDettes)],
                    ['TOTAL PASSIF', fmt(data.totalPassif)]
                ];

                docLandscape.autoTable({
                    head: passifHeaders,
                    body: passifData,
                    startY: 25,
                    margin: { left: 152 },
                    tableWidth: 130,
                    ...tableStyles,
                    columnStyles: hasN1 ? {
                        0: { cellWidth: 55 },
                        1: { cellWidth: 25, halign: 'right' },
                        2: { cellWidth: 25, halign: 'right' },
                        3: { cellWidth: 18, halign: 'right' }
                    } : {
                        0: { cellWidth: 80 },
                        1: { cellWidth: 40, halign: 'right' }
                    }
                });

                docLandscape.save(`Bilan_${yearN}.pdf`);
                return;
            } else if (type === 'ratios') {
                title = 'Ratios Financiers - ' + currentYear;
                headers = [['CatÃ©gorie', 'Ratio', 'Valeur', 'Benchmark', 'Statut']];
                tableData = [
                    ['ProfitabilitÃ©', 'Marge Brute', data.margeBrutePct.toFixed(1) + '%', '> 20%', data.margeBrutePct > 20 ? 'âœ“' : 'âš '],
                    ['ProfitabilitÃ©', 'Marge EBITDA', data.margeEbitda.toFixed(1) + '%', '> 15%', data.margeEbitda > 15 ? 'âœ“' : 'âš '],
                    ['ProfitabilitÃ©', 'Marge Nette', data.margeNette.toFixed(1) + '%', '> 5%', data.margeNette > 5 ? 'âœ“' : 'âš '],
                    ['RentabilitÃ©', 'ROE', data.roe.toFixed(1) + '%', '> 15%', data.roe > 15 ? 'âœ“' : 'âš '],
                    ['RentabilitÃ©', 'ROA', data.roi.toFixed(1) + '%', '> 5%', data.roi > 5 ? 'âœ“' : 'âš '],
                    ['LiquiditÃ©', 'Current Ratio', data.currentRatio.toFixed(2), '> 1.5', data.currentRatio > 1.5 ? 'âœ“' : 'âš '],
                    ['LiquiditÃ©', 'Quick Ratio', data.quickRatio.toFixed(2), '> 1', data.quickRatio > 1 ? 'âœ“' : 'âš '],
                    ['LiquiditÃ©', 'BFR (jours CA)', data.bfrJours + 'j', '< 60j', data.bfrJours < 60 ? 'âœ“' : 'âš '],
                    ['SolvabilitÃ©', 'Dette Nette/EBITDA', data.netDebtEbitda.toFixed(1) + 'x', '< 3x', data.netDebtEbitda < 3 ? 'âœ“' : 'âš ']
                ];
            } else if (type === 'cashflow') {
                // Cash Flow complet avec N-1 si disponible
                const years = Object.keys(yearsData).sort();
                const yearN1Index = years.indexOf(currentYear) - 1;
                const yearN1 = yearN1Index >= 0 ? years[yearN1Index] : null;
                const dataN1Cf = yearN1 ? yearsData[yearN1] : null;
                const hasN1Cf = dataN1Cf !== null;

                const M = n => Math.round((n || 0) / 1000000);
                const fmtM = n => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
                const caf = M(data.caf);

                title = hasN1Cf ? `Tableau des Flux de TrÃ©sorerie ${yearN1} â†’ ${currentYear}` : `Tableau des Flux de TrÃ©sorerie - ${currentYear}`;

                doc.text(title, 14, 22);
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text('GÃ©nÃ©rÃ© par Findalyx - ' + new Date().toLocaleDateString('fr-FR') + ' | Montants en M FCFA', 14, 30);

                if (hasN1Cf) {
                    // Calculs
                    const varStocks = M(data.stocks) - M(dataN1Cf.stocks);
                    const varClients = M(data.clients) - M(dataN1Cf.clients);
                    const varAutresCreances = M(data.autresCreances) - M(dataN1Cf.autresCreances);
                    const varFournisseurs = M(data.fournisseurs) - M(dataN1Cf.fournisseurs);
                    const varDettesFiscales = M(data.dettesFiscales) - M(dataN1Cf.dettesFiscales);
                    const varAutresDettes = M(data.autresDettes) - M(dataN1Cf.autresDettes);
                    const varBFR = (varStocks + varClients + varAutresCreances) - (varFournisseurs + varDettesFiscales + varAutresDettes);
                    const fluxExploitation = caf - varBFR;

                    const varImmo = (M(data.immoNet) - M(dataN1Cf.immoNet)) + M(data.dotations);
                    const fluxInvestissement = -varImmo;

                    const varEmprunts = M(data.emprunts) - M(dataN1Cf.emprunts);
                    const varCapital = M(data.capital) - M(dataN1Cf.capital);
                    const varReserves = M(data.reserves) - M(dataN1Cf.reserves);
                    const fluxFinancement = varEmprunts + varCapital + varReserves;

                    const varTreso = fluxExploitation + fluxInvestissement + fluxFinancement;
                    const tresoN = M(data.tresoActif);
                    const tresoN1 = M(dataN1Cf.tresoActif);

                    tableData = [
                        ['A. FLUX D\'EXPLOITATION', ''],
                        ['RÃ©sultat net', fmtM(M(data.resultatNet))],
                        ['+ Dotations aux amortissements', fmtM(M(data.dotations))],
                        ['- Reprises de provisions', fmtM(-M(data.reprises))],
                        ['= CAF', fmtM(caf)],
                        ['', ''],
                        ['Variation du BFR:', ''],
                        ['   Î” Stocks', fmtM(-varStocks)],
                        ['   Î” Clients', fmtM(-varClients)],
                        ['   Î” Fournisseurs', fmtM(varFournisseurs)],
                        ['= Variation BFR', fmtM(-varBFR)],
                        ['FLUX NET EXPLOITATION (A)', fmtM(fluxExploitation)],
                        ['', ''],
                        ['B. FLUX D\'INVESTISSEMENT', ''],
                        ['Acquisitions d\'immobilisations', fmtM(-varImmo)],
                        ['FLUX NET INVESTISSEMENT (B)', fmtM(fluxInvestissement)],
                        ['', ''],
                        ['C. FLUX DE FINANCEMENT', ''],
                        ['Î” Emprunts', fmtM(varEmprunts)],
                        ['Î” Capital et rÃ©serves', fmtM(varCapital + varReserves)],
                        ['FLUX NET FINANCEMENT (C)', fmtM(fluxFinancement)],
                        ['', ''],
                        ['VARIATION DE TRÃ‰SORERIE (A+B+C)', fmtM(varTreso)],
                        ['', ''],
                        ['TrÃ©sorerie ' + yearN1, fmtM(tresoN1)],
                        ['TrÃ©sorerie ' + currentYear, fmtM(tresoN)],
                        ['Variation rÃ©elle', fmtM(tresoN - tresoN1)]
                    ];
                } else {
                    tableData = [
                        ['A. FLUX D\'EXPLOITATION', ''],
                        ['RÃ©sultat net', fmtM(M(data.resultatNet))],
                        ['+ Dotations aux amortissements', fmtM(M(data.dotations))],
                        ['- Reprises de provisions', fmtM(-M(data.reprises))],
                        ['= CAF', fmtM(caf)],
                        ['- Variation du BFR', 'N/A (requiert N-1)'],
                        ['', ''],
                        ['B. FLUX D\'INVESTISSEMENT', 'N/A (requiert N-1)'],
                        ['', ''],
                        ['C. FLUX DE FINANCEMENT', 'N/A (requiert N-1)'],
                        ['', ''],
                        ['TrÃ©sorerie nette ' + currentYear, fmtM(M(data.tresoActif))]
                    ];
                }

                headers = [['LibellÃ©', 'Montant']];

                doc.autoTable({
                    head: headers,
                    body: tableData,
                    startY: 40,
                    theme: 'striped',
                    headStyles: { fillColor: [30, 64, 175], fontSize: 9 },
                    styles: { fontSize: 9, cellPadding: 3 },
                    columnStyles: {
                        0: { cellWidth: 100 },
                        1: { cellWidth: 40, halign: 'right' }
                    },
                    didParseCell: function(cellData) {
                        const label = cellData.row.raw[0];
                        if (label && (label.startsWith('A.') || label.startsWith('B.') || label.startsWith('C.'))) {
                            cellData.cell.styles.fillColor = [224, 231, 255];
                            cellData.cell.styles.fontStyle = 'bold';
                        }
                        if (label && (label.startsWith('FLUX NET') || label.startsWith('= ') || label === 'VARIATION DE TRÃ‰SORERIE (A+B+C)')) {
                            cellData.cell.styles.fillColor = [219, 234, 254];
                            cellData.cell.styles.fontStyle = 'bold';
                        }
                    }
                });

                doc.save(`CashFlow_${currentYear}.pdf`);
                return;
            }

            doc.text(title, 14, 22);
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('GÃ©nÃ©rÃ© par Findalyx - ' + new Date().toLocaleDateString('fr-FR'), 14, 30);

            doc.autoTable({
                head: headers,
                body: tableData,
                startY: 40,
                theme: 'striped',
                headStyles: { fillColor: [30, 64, 175], fontSize: 9 },
                styles: { fontSize: 9, cellPadding: 3 },
                columnStyles: type === 'bilan' ? {
                    0: { cellWidth: 45 },
                    1: { cellWidth: 30, halign: 'right' },
                    2: { cellWidth: 45 },
                    3: { cellWidth: 30, halign: 'right' }
                } : {}
            });

            doc.save(`${type}_${currentYear}.pdf`);
        }

        // ========== BALANCE CHECK ==========
        function checkBilanEquilibre(data) {
            const totalActif = data.totalActif || 0;
            const totalPassif = data.totalPassif || 0;
            const diff = Math.abs(totalActif - totalPassif);
            const tolerance = Math.max(totalActif, totalPassif) * 0.001; // 0.1% tolerance

            const alertEl = document.getElementById('bilanAlert');
            const detailEl = document.getElementById('bilanAlertDetail');
            const actifBadge = document.getElementById('totalActifBadge');
            const passifBadge = document.getElementById('totalPassifBadge');

            const fmt = n => new Intl.NumberFormat('fr-FR').format(Math.round(n / 1000000));

            if (actifBadge) actifBadge.textContent = fmt(totalActif) + ' M';
            if (passifBadge) passifBadge.textContent = fmt(totalPassif) + ' M';

            if (diff > tolerance) {
                if (alertEl) {
                    alertEl.style.display = 'flex';
                    if (detailEl) {
                        detailEl.textContent = `Total Actif: ${fmt(totalActif)} M | Total Passif: ${fmt(totalPassif)} M | Ã‰cart: ${fmt(diff)} M`;
                    }
                }
            } else {
                if (alertEl) alertEl.style.display = 'none';
            }
        }

        // =====================================================
        // USER MENU FUNCTIONS
        // =====================================================
        
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            const userCard = document.getElementById('userCard');
            
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                userCard.classList.remove('menu-open');
            } else {
                dropdown.classList.add('show');
                userCard.classList.add('menu-open');
            }
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('userDropdown');
            const userCard = document.getElementById('userCard');
            
            if (dropdown && userCard) {
                if (!dropdown.contains(e.target) && !userCard.contains(e.target)) {
                    dropdown.classList.remove('show');
                    userCard.classList.remove('menu-open');
                }
            }
        });

        function showUserProfile() {
            toggleUserMenu();
            openModal('modalProfile');
        }

        function showSubscription() {
            toggleUserMenu();
            openModal('modalSubscription');
        }

        function showHelp() {
            toggleUserMenu();
            openModal('modalHelp');
        }

        function showDocumentation() {
            toggleUserMenu();
            // Ouvrir documentation externe ou page dÃ©diÃ©e
            window.open('https://docs.findalyx.com', '_blank');
        }

        function handleLogout() {
            toggleUserMenu();
            if (confirm('ÃŠtes-vous sÃ»r de vouloir vous dÃ©connecter ?')) {
                showNotification('DÃ©connexion rÃ©ussie', 'success');
                // Ici on pourrait rediriger vers une page de login
                // window.location.href = '/login';
            }
        }

        // =====================================================
        // MODAL FUNCTIONS
        // =====================================================

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = '';
            }
        }

        // Close modal on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('show');
                    document.body.style.overflow = '';
                }
            });
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.show').forEach(modal => {
                    modal.classList.remove('show');
                });
                document.body.style.overflow = '';
            }
        });

        // Profile Functions
        function saveProfile() {
            const firstName = document.getElementById('profileFirstName').value;
            const lastName = document.getElementById('profileLastName').value;
            const email = document.getElementById('profileEmail').value;
            
            // Mettre Ã  jour l'avatar et le nom dans le sidebar
            const initials = (firstName[0] || '') + (lastName[0] || '');
            document.querySelectorAll('.user-avatar').forEach(el => el.textContent = initials.toUpperCase());
            document.querySelectorAll('.user-name').forEach(el => {
                if (el.closest('.user-card')) {
                    el.textContent = firstName;
                } else {
                    el.textContent = firstName + ' ' + lastName;
                }
            });
            
            closeModal('modalProfile');
            showNotification('Profil mis Ã  jour avec succÃ¨s', 'success');
        }

        // Subscription Functions
        let selectedPlan = 'pro';

        function selectPlan(plan) {
            selectedPlan = plan;
            document.querySelectorAll('.plan-card').forEach(card => {
                card.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
        }

        function upgradePlan() {
            if (selectedPlan === 'enterprise') {
                showNotification('Notre Ã©quipe vous contactera sous 24h', 'info');
            } else if (selectedPlan === 'free') {
                showNotification('Vous Ãªtes passÃ© au plan Gratuit', 'success');
            } else {
                showNotification('Plan Pro activÃ© avec succÃ¨s !', 'success');
            }
            closeModal('modalSubscription');
        }

        // FAQ Functions
        function toggleFaq(element) {
            element.classList.toggle('open');
        }

        // =====================================================
        // TOAST NOTIFICATION SYSTEM
        // =====================================================
        
        function showNotification(message, type = 'info', title = null) {
            const container = document.getElementById('toastContainer');
            
            // Default titles based on type
            const defaultTitles = {
                success: 'SuccÃ¨s',
                error: 'Erreur',
                info: 'Information',
                warning: 'Attention'
            };
            
            // Icons for each type
            const icons = {
                success: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',
                error: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>',
                info: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                warning: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${title || defaultTitles[type]}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="closeToast(this.parentElement)">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <div class="toast-progress"></div>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                closeToast(toast);
            }, 4000);
        }

        function closeToast(toast) {
            if (toast && !toast.classList.contains('hiding')) {
                toast.classList.add('hiding');
                setTimeout(() => {
                    toast.remove();
                }, 400);
            }
        }

        // =====================================================
        // EXPORT MENU
        // =====================================================
        
        function toggleExportMenu() {
            const dropdown = document.getElementById('exportDropdown');
            dropdown.classList.toggle('open');
        }

        // Close export menu when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('exportDropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                dropdown.classList.remove('open');
            }
        });

        // =====================================================
        // SCORING FINANCIER
        // =====================================================
        
        function calculateFinancialScore(data) {
            if (!data) return null;
            
            // Calcul des sous-scores (0-100)
            let scoreRentabilite = 50;
            let scoreLiquidite = 50;
            let scoreSolvabilite = 50;
            
            // Score RentabilitÃ© (basÃ© sur marges et ROE)
            const margeEBITDA = data.ca > 0 ? (data.ebitda / data.ca) * 100 : 0;
            const margeNette = data.ca > 0 ? (data.resultatNet / data.ca) * 100 : 0;
            
            if (margeEBITDA >= 20) scoreRentabilite = 90;
            else if (margeEBITDA >= 15) scoreRentabilite = 75;
            else if (margeEBITDA >= 10) scoreRentabilite = 60;
            else if (margeEBITDA >= 5) scoreRentabilite = 45;
            else if (margeEBITDA >= 0) scoreRentabilite = 30;
            else scoreRentabilite = 15;
            
            // Ajustement si rÃ©sultat net nÃ©gatif
            if (data.resultatNet < 0) scoreRentabilite = Math.max(10, scoreRentabilite - 30);
            
            // Score LiquiditÃ© (basÃ© sur trÃ©sorerie vs dettes CT)
            const tresorerieRatio = data.tresorerieNette > 0 ? 70 : 40;
            scoreLiquidite = tresorerieRatio;
            
            // Score SolvabilitÃ© (basÃ© sur capitaux propres vs dettes)
            const totalPassif = (data.capitauxPropres || 0) + (data.dettesLT || 0) + (data.dettesCT || 0);
            const ratioCP = totalPassif > 0 ? ((data.capitauxPropres || 0) / totalPassif) * 100 : 50;
            
            if (ratioCP >= 50) scoreSolvabilite = 85;
            else if (ratioCP >= 35) scoreSolvabilite = 65;
            else if (ratioCP >= 20) scoreSolvabilite = 45;
            else scoreSolvabilite = 25;
            
            // Score global pondÃ©rÃ©
            const scoreGlobal = Math.round(
                scoreRentabilite * 0.40 + 
                scoreLiquidite * 0.30 + 
                scoreSolvabilite * 0.30
            );
            
            // Grade
            let grade, gradeClass, interpretation;
            if (scoreGlobal >= 80) {
                grade = 'A';
                gradeClass = 'excellent';
                interpretation = 'Excellente santÃ© financiÃ¨re. Structure solide et rentabilitÃ© Ã©levÃ©e.';
            } else if (scoreGlobal >= 65) {
                grade = 'B';
                gradeClass = 'good';
                interpretation = 'Bonne situation financiÃ¨re. Quelques optimisations possibles.';
            } else if (scoreGlobal >= 50) {
                grade = 'C';
                gradeClass = 'average';
                interpretation = 'Situation moyenne. Des amÃ©liorations sont recommandÃ©es.';
            } else if (scoreGlobal >= 35) {
                grade = 'D';
                gradeClass = 'weak';
                interpretation = 'Situation fragile. Actions correctives nÃ©cessaires.';
            } else {
                grade = 'E';
                gradeClass = 'critical';
                interpretation = 'Situation critique. Mesures urgentes requises.';
            }
            
            return {
                global: scoreGlobal,
                rentabilite: Math.round(scoreRentabilite),
                liquidite: Math.round(scoreLiquidite),
                solvabilite: Math.round(scoreSolvabilite),
                grade,
                gradeClass,
                interpretation
            };
        }

        function updateScoringDisplay(score) {
            if (!score) return;
            
            // Aiguille de jauge (-90deg = 0, 90deg = 100)
            const needleAngle = -90 + (score.global * 1.8);
            document.getElementById('gaugeNeedle').style.transform = `translateX(-50%) rotate(${needleAngle}deg)`;
            
            // Score et grade
            document.getElementById('scoreNumber').textContent = score.global;
            const gradeEl = document.getElementById('scoreGrade');
            gradeEl.textContent = score.grade;
            gradeEl.className = 'score-grade ' + score.gradeClass;
            
            // InterprÃ©tation
            document.getElementById('scoreInterpretation').textContent = score.interpretation;
            
            // Sous-scores
            document.getElementById('scoreRentabilite').textContent = score.rentabilite + '/100';
            document.getElementById('scoreLiquidite').textContent = score.liquidite + '/100';
            document.getElementById('scoreSolvabilite').textContent = score.solvabilite + '/100';
        }

        // =====================================================
        // COMMENTAIRES IA (INSIGHTS)
        // =====================================================
        
        function generateAIInsights(data) {
            if (!data) return [];
            
            const insights = [];
            const fmtMrd = n => new Intl.NumberFormat('fr-FR', {maximumFractionDigits: 1}).format(n / 1000000000);
            
            // Analyse du CA
            if (data.ca > 0) {
                insights.push({
                    type: 'neutral',
                    icon: 'chart',
                    title: 'Chiffre d\'affaires',
                    text: `CA de ${fmtMrd(data.ca)} Mrd FCFA. ${data.ca > 100000000000 ? 'Entreprise de taille importante.' : 'Structure de taille moyenne.'}`
                });
            }
            
            // Analyse de la marge EBITDA
            const margeEBITDA = data.ca > 0 ? (data.ebitda / data.ca) * 100 : 0;
            if (margeEBITDA >= 15) {
                insights.push({
                    type: 'positive',
                    icon: 'check',
                    title: 'Marge opÃ©rationnelle solide',
                    text: `Marge EBITDA de ${margeEBITDA.toFixed(1)}%, supÃ©rieure Ã  la moyenne sectorielle (~10-12%). Bonne maÃ®trise des coÃ»ts d'exploitation.`
                });
            } else if (margeEBITDA >= 8) {
                insights.push({
                    type: 'neutral',
                    icon: 'info',
                    title: 'Marge opÃ©rationnelle correcte',
                    text: `Marge EBITDA de ${margeEBITDA.toFixed(1)}%. Niveau acceptable mais des optimisations de coÃ»ts pourraient amÃ©liorer la rentabilitÃ©.`
                });
            } else if (margeEBITDA > 0) {
                insights.push({
                    type: 'warning',
                    icon: 'alert',
                    title: 'Marge opÃ©rationnelle faible',
                    text: `Marge EBITDA de ${margeEBITDA.toFixed(1)}% seulement. Revoir la structure de coÃ»ts et la politique de prix.`
                });
            } else {
                insights.push({
                    type: 'negative',
                    icon: 'x',
                    title: 'EBITDA nÃ©gatif',
                    text: `L'exploitation gÃ©nÃ¨re des pertes. Mesures urgentes nÃ©cessaires pour rÃ©tablir la rentabilitÃ© opÃ©rationnelle.`
                });
            }
            
            // Analyse du rÃ©sultat net
            if (data.resultatNet > 0) {
                const margeNette = (data.resultatNet / data.ca) * 100;
                insights.push({
                    type: 'positive',
                    icon: 'check',
                    title: 'RÃ©sultat net positif',
                    text: `BÃ©nÃ©fice de ${fmtMrd(data.resultatNet)} Mrd FCFA (marge nette: ${margeNette.toFixed(1)}%). L'entreprise est profitable.`
                });
            } else if (data.resultatNet < 0) {
                insights.push({
                    type: 'negative',
                    icon: 'x',
                    title: 'RÃ©sultat net dÃ©ficitaire',
                    text: `Perte de ${fmtMrd(Math.abs(data.resultatNet))} Mrd FCFA. Analyser les causes: charges financiÃ¨res, Ã©lÃ©ments exceptionnels, ou problÃ¨me structurel.`
                });
            }
            
            // Analyse de la trÃ©sorerie
            if (data.tresorerieNette > 0) {
                insights.push({
                    type: 'positive',
                    icon: 'check',
                    title: 'TrÃ©sorerie excÃ©dentaire',
                    text: `TrÃ©sorerie nette positive de ${fmtMrd(data.tresorerieNette)} Mrd FCFA. Bonne capacitÃ© de financement Ã  court terme.`
                });
            } else if (data.tresorerieNette < 0) {
                insights.push({
                    type: 'warning',
                    icon: 'alert',
                    title: 'TrÃ©sorerie tendue',
                    text: `TrÃ©sorerie nette nÃ©gative. Surveiller le BFR et optimiser le cycle de conversion du cash.`
                });
            }
            
            return insights.slice(0, 4); // Max 4 insights
        }

        function updateAIInsightsDisplay(insights) {
            const container = document.getElementById('aiInsightsBody');
            if (!container || !insights || insights.length === 0) return;
            
            const iconSvgs = {
                check: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>',
                x: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>',
                alert: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>',
                info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>',
                chart: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>'
            };
            
            container.innerHTML = insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-icon ${insight.type}">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">${iconSvgs[insight.icon] || iconSvgs.info}</svg>
                    </div>
                    <div class="insight-content">
                        <div class="insight-title">${insight.title}</div>
                        <div class="insight-text">${insight.text}</div>
                    </div>
                </div>
            `).join('');
        }

        // =====================================================
        // PRÃ‰VISIONS N+1
        // =====================================================
        
        function calculateForecasts(yearsData) {
            const years = Object.keys(yearsData).sort();
            if (years.length === 0) return null;
            
            const currentYear = years[years.length - 1];
            const current = yearsData[currentYear];
            
            // Si une seule annÃ©e, hypothÃ¨ses par dÃ©faut
            if (years.length === 1) {
                return {
                    ca: { current: current.ca, predicted: current.ca * 1.05, change: 5 },
                    ebitda: { current: current.ebitda, predicted: current.ebitda * 1.03, change: 3 },
                    net: { current: current.resultatNet, predicted: current.resultatNet * 1.02, change: 2 },
                    margin: { 
                        current: current.ca > 0 ? (current.ebitda / current.ca) * 100 : 0, 
                        predicted: current.ca > 0 ? (current.ebitda * 1.03 / (current.ca * 1.05)) * 100 : 0,
                        change: -0.2
                    }
                };
            }
            
            // Calculer tendances sur plusieurs annÃ©es
            const growthRates = [];
            for (let i = 1; i < years.length; i++) {
                const prev = yearsData[years[i-1]];
                const curr = yearsData[years[i]];
                if (prev.ca > 0) {
                    growthRates.push((curr.ca - prev.ca) / prev.ca);
                }
            }
            
            // Moyenne des taux de croissance
            const avgGrowth = growthRates.length > 0 
                ? growthRates.reduce((a, b) => a + b, 0) / growthRates.length 
                : 0.05;
            
            const predictedCA = current.ca * (1 + avgGrowth);
            const predictedEBITDA = current.ebitda * (1 + avgGrowth * 0.8); // EBITDA croÃ®t moins vite
            const predictedNet = current.resultatNet * (1 + avgGrowth * 0.6);
            
            const currentMargin = current.ca > 0 ? (current.ebitda / current.ca) * 100 : 0;
            const predictedMargin = predictedCA > 0 ? (predictedEBITDA / predictedCA) * 100 : 0;
            
            return {
                ca: { current: current.ca, predicted: predictedCA, change: avgGrowth * 100 },
                ebitda: { current: current.ebitda, predicted: predictedEBITDA, change: avgGrowth * 80 },
                net: { current: current.resultatNet, predicted: predictedNet, change: avgGrowth * 60 },
                margin: { current: currentMargin, predicted: predictedMargin, change: predictedMargin - currentMargin }
            };
        }

        function updateForecastDisplay(forecasts) {
            if (!forecasts) return;
            
            const fmtMrd = n => new Intl.NumberFormat('fr-FR', {maximumFractionDigits: 1}).format(Math.abs(n) / 1000000000) + ' Mrd';
            const fmtPct = n => (n >= 0 ? '+' : '') + n.toFixed(1) + '%';
            
            // CA
            document.getElementById('fcstCAcurrent').textContent = fmtMrd(forecasts.ca.current);
            document.getElementById('fcstCApredicted').textContent = fmtMrd(forecasts.ca.predicted);
            const fcstCAchange = document.getElementById('fcstCAchange');
            fcstCAchange.textContent = fmtPct(forecasts.ca.change);
            fcstCAchange.className = 'forecast-change ' + (forecasts.ca.change >= 0 ? 'up' : 'down');
            
            // EBITDA
            document.getElementById('fcstEBITDAcurrent').textContent = fmtMrd(forecasts.ebitda.current);
            document.getElementById('fcstEBITDApredicted').textContent = fmtMrd(forecasts.ebitda.predicted);
            const fcstEBITDAchange = document.getElementById('fcstEBITDAchange');
            fcstEBITDAchange.textContent = fmtPct(forecasts.ebitda.change);
            fcstEBITDAchange.className = 'forecast-change ' + (forecasts.ebitda.change >= 0 ? 'up' : 'down');
            
            // RÃ©sultat Net
            document.getElementById('fcstNETcurrent').textContent = fmtMrd(forecasts.net.current);
            document.getElementById('fcstNETpredicted').textContent = fmtMrd(forecasts.net.predicted);
            const fcstNETchange = document.getElementById('fcstNETchange');
            fcstNETchange.textContent = fmtPct(forecasts.net.change);
            fcstNETchange.className = 'forecast-change ' + (forecasts.net.change >= 0 ? 'up' : 'down');
            
            // Marge
            document.getElementById('fcstMARGcurrent').textContent = forecasts.margin.current.toFixed(1) + '%';
            document.getElementById('fcstMARGpredicted').textContent = forecasts.margin.predicted.toFixed(1) + '%';
            const fcstMARGchange = document.getElementById('fcstMARGchange');
            fcstMARGchange.textContent = fmtPct(forecasts.margin.change);
            fcstMARGchange.className = 'forecast-change ' + (forecasts.margin.change >= 0 ? 'up' : 'down');
        }

        // =====================================================
        // EXPORT FONCTIONS
        // =====================================================
        
        function exportToPDF() {
            if (!currentYear || !yearsData[currentYear]) {
                showNotification('Veuillez d\'abord importer des donnÃ©es', 'warning');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const data = yearsData[currentYear];
            
            const fmtMrd = n => new Intl.NumberFormat('fr-FR', {maximumFractionDigits: 2}).format((n || 0) / 1000000000);
            
            // Header
            doc.setFillColor(30, 64, 175);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('FINDALYX', 20, 25);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Rapport d\'Analyse FinanciÃ¨re - Exercice ' + currentYear, 20, 35);
            
            // Reset colors
            doc.setTextColor(0, 0, 0);
            let y = 55;
            
            // KPIs Section
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Indicateurs ClÃ©s', 20, y);
            y += 10;
            
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text(`Chiffre d'Affaires: ${fmtMrd(data.ca)} Mrd FCFA`, 25, y); y += 7;
            doc.text(`EBITDA: ${fmtMrd(data.ebitda)} Mrd FCFA`, 25, y); y += 7;
            doc.text(`RÃ©sultat Net: ${fmtMrd(data.resultatNet)} Mrd FCFA`, 25, y); y += 7;
            doc.text(`Marge EBITDA: ${data.ca > 0 ? ((data.ebitda/data.ca)*100).toFixed(1) : 0}%`, 25, y); y += 15;
            
            // Score Section
            const score = calculateFinancialScore(data);
            if (score) {
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Score de SantÃ© FinanciÃ¨re', 20, y);
                y += 10;
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text(`Score Global: ${score.global}/100 (${score.grade})`, 25, y); y += 7;
                doc.text(`RentabilitÃ©: ${score.rentabilite}/100`, 25, y); y += 7;
                doc.text(`LiquiditÃ©: ${score.liquidite}/100`, 25, y); y += 7;
                doc.text(`SolvabilitÃ©: ${score.solvabilite}/100`, 25, y); y += 7;
                doc.text(score.interpretation, 25, y, { maxWidth: 160 }); y += 15;
            }
            
            // AI Insights
            const insights = generateAIInsights(data);
            if (insights.length > 0) {
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Analyse et Recommandations', 20, y);
                y += 10;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                insights.forEach(insight => {
                    doc.text(`â€¢ ${insight.title}: ${insight.text}`, 25, y, { maxWidth: 160 });
                    y += 12;
                });
            }
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text(`GÃ©nÃ©rÃ© par Findalyx le ${new Date().toLocaleDateString('fr-FR')}`, 20, 285);
            
            doc.save(`Findalyx_Rapport_${currentYear}.pdf`);
            showNotification('Rapport PDF exportÃ© avec succÃ¨s', 'success');
            toggleExportMenu();
        }

        async function exportToPowerPoint() {
            if (!currentYear || !yearsData[currentYear]) {
                showNotification('Veuillez d\'abord importer des donnÃ©es', 'warning');
                return;
            }
            
            showNotification('GÃ©nÃ©ration du PowerPoint en cours...', 'info');
            
            // Load PptxGenJS dynamically
            if (!window.PptxGenJS) {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js';
                document.head.appendChild(script);
                await new Promise(resolve => script.onload = resolve);
            }
            
            const pptx = new PptxGenJS();
            pptx.author = 'Findalyx';
            pptx.title = `Analyse FinanciÃ¨re ${currentYear}`;
            pptx.subject = 'Rapport d\'analyse financiÃ¨re';
            pptx.company = document.getElementById('companyName')?.value || 'Entreprise';
            
            const data = yearsData[currentYear];
            const companyName = document.getElementById('companyName')?.value || 'Entreprise';
            const fmtMrd = n => new Intl.NumberFormat('fr-FR', {maximumFractionDigits: 1}).format((n || 0) / 1000000000);
            const fmtM = n => new Intl.NumberFormat('fr-FR', {maximumFractionDigits: 0}).format((n || 0) / 1000000);
            const fmtPct = n => (n || 0).toFixed(1) + '%';
            const score = calculateFinancialScore(data);
            const insights = generateAIInsights(data);
            
            // Couleurs thÃ¨me
            const colors = {
                primary: '1e40af',
                secondary: '3b82f6', 
                success: '10b981',
                warning: 'f59e0b',
                danger: 'ef4444',
                purple: '8b5cf6',
                dark: '1e293b',
                gray: '64748b',
                lightGray: '94a3b8',
                bgLight: 'f1f5f9',
                white: 'ffffff'
            };
            
            // ============ SLIDE 1: PAGE DE TITRE ============
            let slide = pptx.addSlide();
            // Background gradient effect
            slide.addShape(pptx.ShapeType.rect, { x: 0, y: 0, w: '100%', h: '100%', fill: { color: colors.primary } });
            slide.addShape(pptx.ShapeType.rect, { x: 0, y: 4.5, w: '100%', h: 1, fill: { color: colors.secondary } });
            
            slide.addText('FINDALYX', { x: 0.5, y: 1.5, w: 9, h: 0.8, fontSize: 48, bold: true, color: colors.white, fontFace: 'Arial' });
            slide.addText('Rapport d\'Analyse FinanciÃ¨re', { x: 0.5, y: 2.3, w: 9, h: 0.5, fontSize: 24, color: 'a5b4fc', fontFace: 'Arial' });
            slide.addText(companyName.toUpperCase(), { x: 0.5, y: 3.2, w: 9, h: 0.6, fontSize: 32, bold: true, color: colors.white, fontFace: 'Arial' });
            slide.addText(`Exercice ${currentYear}`, { x: 0.5, y: 4.6, w: 4, h: 0.4, fontSize: 18, color: colors.white, fontFace: 'Arial' });
            slide.addText(new Date().toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' }), { x: 5.5, y: 4.6, w: 4, h: 0.4, fontSize: 14, color: colors.white, align: 'right', fontFace: 'Arial' });
            
            // ============ SLIDE 2: SOMMAIRE ============
            slide = pptx.addSlide();
            slide.addText('Sommaire', { x: 0.5, y: 0.3, w: 9, h: 0.7, fontSize: 32, bold: true, color: colors.dark, fontFace: 'Arial' });
            slide.addShape(pptx.ShapeType.rect, { x: 0.5, y: 0.95, w: 2, h: 0.05, fill: { color: colors.primary } });
            
            const sommaire = [
                { num: '01', title: 'Indicateurs ClÃ©s', desc: 'CA, EBITDA, RÃ©sultat Net' },
                { num: '02', title: 'Score de SantÃ©', desc: 'Ã‰valuation globale de la performance' },
                { num: '03', title: 'Compte de RÃ©sultat', desc: 'Analyse de la rentabilitÃ©' },
                { num: '04', title: 'Structure Bilancielle', desc: 'Actif et Passif' },
                { num: '05', title: 'Ratios Financiers', desc: 'Indicateurs de performance' },
                { num: '06', title: 'Recommandations', desc: 'Points d\'attention et actions' }
            ];
            
            sommaire.forEach((item, i) => {
                const y = 1.4 + i * 0.75;
                slide.addText(item.num, { x: 0.5, y, w: 0.8, h: 0.5, fontSize: 24, bold: true, color: colors.primary, fontFace: 'Arial' });
                slide.addText(item.title, { x: 1.5, y, w: 4, h: 0.3, fontSize: 16, bold: true, color: colors.dark, fontFace: 'Arial' });
                slide.addText(item.desc, { x: 1.5, y: y + 0.3, w: 5, h: 0.25, fontSize: 11, color: colors.gray, fontFace: 'Arial' });
            });
            
            // ============ SLIDE 3: KPIs ============
            slide = pptx.addSlide();
            slide.addText('01  Indicateurs ClÃ©s de Performance', { x: 0.5, y: 0.3, w: 9, h: 0.7, fontSize: 28, bold: true, color: colors.dark, fontFace: 'Arial' });
            slide.addShape(pptx.ShapeType.rect, { x: 0.5, y: 0.95, w: 2, h: 0.05, fill: { color: colors.primary } });
            
            const kpis = [
                { label: 'Chiffre d\'Affaires', value: `${fmtMrd(data.ca)}`, unit: 'Mrd FCFA', color: colors.secondary, icon: 'ðŸ“Š' },
                { label: 'EBITDA', value: `${fmtMrd(data.ebitda)}`, unit: 'Mrd FCFA', color: colors.success, icon: 'ðŸ“ˆ' },
                { label: 'RÃ©sultat Net', value: `${fmtMrd(data.resultatNet)}`, unit: 'Mrd FCFA', color: colors.purple, icon: 'ðŸ’°' },
                { label: 'Marge EBITDA', value: `${fmtPct(data.margeEbitda || (data.ca > 0 ? (data.ebitda/data.ca)*100 : 0))}`, unit: '', color: colors.warning, icon: 'ðŸ“‰' }
            ];
            
            kpis.forEach((kpi, i) => {
                const x = 0.5 + (i % 2) * 4.7;
                const y = 1.3 + Math.floor(i / 2) * 2.2;
                
                // Card background
                slide.addShape(pptx.ShapeType.roundRect, { x, y, w: 4.2, h: 1.9, fill: { color: colors.white }, line: { color: 'e2e8f0', pt: 1 }, rounding: 0.1 });
                // Left accent bar
                slide.addShape(pptx.ShapeType.rect, { x, y, w: 0.08, h: 1.9, fill: { color: kpi.color } });
                
                slide.addText(kpi.label, { x: x + 0.25, y: y + 0.2, w: 3.8, h: 0.35, fontSize: 13, color: colors.gray, fontFace: 'Arial' });
                slide.addText(kpi.value, { x: x + 0.25, y: y + 0.65, w: 3, h: 0.7, fontSize: 36, bold: true, color: colors.dark, fontFace: 'Arial' });
                slide.addText(kpi.unit, { x: x + 0.25, y: y + 1.35, w: 3.8, h: 0.3, fontSize: 11, color: colors.lightGray, fontFace: 'Arial' });
            });
            
            // ============ SLIDE 4: SCORE ============
            if (score) {
                slide = pptx.addSlide();
                slide.addText('02  Score de SantÃ© FinanciÃ¨re', { x: 0.5, y: 0.3, w: 9, h: 0.7, fontSize: 28, bold: true, color: colors.dark, fontFace: 'Arial' });
                slide.addShape(pptx.ShapeType.rect, { x: 0.5, y: 0.95, w: 2, h: 0.05, fill: { color: colors.primary } });
                
                const gradeColors = { excellent: colors.success, good: '84cc16', average: colors.warning, weak: 'f97316', critical: colors.danger };
                const gradeColor = gradeColors[score.gradeClass] || colors.gray;
                
                // Score circle
                slide.addShape(pptx.ShapeType.ellipse, { x: 1.5, y: 1.5, w: 2.5, h: 2.5, fill: { color: colors.bgLight }, line: { color: gradeColor, pt: 8 } });
                slide.addText(`${score.global}`, { x: 1.5, y: 1.9, w: 2.5, h: 1, fontSize: 48, bold: true, align: 'center', color: colors.dark, fontFace: 'Arial' });
                slide.addText('/100', { x: 1.5, y: 2.8, w: 2.5, h: 0.4, fontSize: 14, align: 'center', color: colors.gray, fontFace: 'Arial' });
                
                // Grade badge
                slide.addShape(pptx.ShapeType.roundRect, { x: 2.25, y: 4.1, w: 1, h: 0.5, fill: { color: gradeColor }, rounding: 0.2 });
                slide.addText(`${score.grade}`, { x: 2.25, y: 4.1, w: 1, h: 0.5, fontSize: 18, bold: true, align: 'center', valign: 'middle', color: colors.white, fontFace: 'Arial' });
                
                // Interpretation
                slide.addText(score.interpretation, { x: 4.5, y: 1.5, w: 5, h: 0.8, fontSize: 16, color: colors.dark, fontFace: 'Arial' });
                
                // Sub-scores
                const subScores = [
                    { label: 'RentabilitÃ©', value: score.rentabilite, color: colors.secondary },
                    { label: 'LiquiditÃ©', value: score.liquidite, color: colors.success },
                    { label: 'SolvabilitÃ©', value: score.solvabilite, color: colors.purple }
                ];
                
                subScores.forEach((s, i) => {
                    const y = 2.6 + i * 0.8;
                    slide.addText(s.label, { x: 4.5, y, w: 2.5, h: 0.3, fontSize: 12, color: colors.gray, fontFace: 'Arial' });
                    // Progress bar background
                    slide.addShape(pptx.ShapeType.rect, { x: 4.5, y: y + 0.35, w: 4, h: 0.2, fill: { color: 'e2e8f0' } });
                    // Progress bar fill
                    slide.addShape(pptx.ShapeType.rect, { x: 4.5, y: y + 0.35, w: 4 * (s.value / 100), h: 0.2, fill: { color: s.color } });
                    slide.addText(`${s.value}`, { x: 8.6, y: y + 0.2, w: 0.8, h: 0.4, fontSize: 14, bold: true, color: colors.dark, fontFace: 'Arial' });
                });
            }
            
            // ============ SLIDE 5: COMPTE DE RÃ‰SULTAT ============
            slide = pptx.addSlide();
            slide.addText('03  Compte de RÃ©sultat', { x: 0.5, y: 0.3, w: 9, h: 0.7, fontSize: 28, bold: true, color: colors.dark, fontFace: 'Arial' });
            slide.addShape(pptx.ShapeType.rect, { x: 0.5, y: 0.95, w: 2, h: 0.05, fill: { color: colors.primary } });
            
            const pnlData = [
                ['LibellÃ©', 'Montant (M)', '%CA'],
                ['Chiffre d\'Affaires', fmtM(data.ca), '100%'],
                ['Achats consommÃ©s', `(${fmtM(Math.abs(data.achats || 0))})`, fmtPct(data.ca > 0 ? (Math.abs(data.achats || 0)/data.ca)*100 : 0)],
                ['Marge Brute', fmtM(data.margeBrute), fmtPct(data.margeBrutePct || 0)],
                ['Charges de personnel', `(${fmtM(Math.abs(data.chargesPersonnel || 0))})`, fmtPct(data.ca > 0 ? (Math.abs(data.chargesPersonnel || 0)/data.ca)*100 : 0)],
                ['EBITDA', fmtM(data.ebitda), fmtPct(data.margeEbitda || 0)],
                ['Dotations', `(${fmtM(Math.abs(data.dotations || 0))})`, ''],
                ['EBIT', fmtM(data.ebit), fmtPct(data.ca > 0 ? (data.ebit/data.ca)*100 : 0)],
                ['RÃ©sultat Net', fmtM(data.resultatNet), fmtPct(data.margeNette || 0)]
            ];
            
            slide.addTable(pnlData, {
                x: 0.5, y: 1.2, w: 9,
                fontFace: 'Arial',
                fontSize: 11,
                color: colors.dark,
                border: { pt: 0.5, color: 'e2e8f0' },
                colW: [5, 2, 2],
                rowH: 0.45,
                valign: 'middle',
                align: ['left', 'right', 'right']
            });
            
            // ============ SLIDE 6: BILAN ============
            slide = pptx.addSlide();
            slide.addText('04  Structure Bilancielle', { x: 0.5, y: 0.3, w: 9, h: 0.7, fontSize: 28, bold: true, color: colors.dark, fontFace: 'Arial' });
            slide.addShape(pptx.ShapeType.rect, { x: 0.5, y: 0.95, w: 2, h: 0.05, fill: { color: colors.primary } });
            
            // Actif
            slide.addText('ACTIF', { x: 0.5, y: 1.2, w: 4, h: 0.4, fontSize: 14, bold: true, color: colors.secondary, fontFace: 'Arial' });
            const actifItems = [
                ['Actif ImmobilisÃ©', fmtM(data.actifImmobilise || 0)],
                ['Actif Circulant', fmtM(data.actifCirculant || 0)],
                ['TrÃ©sorerie Actif', fmtM(data.tresorerieActif || 0)],
                ['TOTAL ACTIF', fmtM((data.actifImmobilise || 0) + (data.actifCirculant || 0) + (data.tresorerieActif || 0))]
            ];
            slide.addTable(actifItems, {
                x: 0.5, y: 1.6, w: 4.2,
                fontFace: 'Arial', fontSize: 11, color: colors.dark,
                border: { pt: 0.5, color: 'e2e8f0' },
                colW: [2.8, 1.4], rowH: 0.4
            });
            
            // Passif
            slide.addText('PASSIF', { x: 5.3, y: 1.2, w: 4, h: 0.4, fontSize: 14, bold: true, color: colors.success, fontFace: 'Arial' });
            const passifItems = [
                ['Capitaux Propres', fmtM(data.capitauxPropres || 0)],
                ['Dettes Long Terme', fmtM(data.dettesLT || 0)],
                ['Dettes Court Terme', fmtM(data.dettesCT || 0)],
                ['TOTAL PASSIF', fmtM((data.capitauxPropres || 0) + (data.dettesLT || 0) + (data.dettesCT || 0))]
            ];
            slide.addTable(passifItems, {
                x: 5.3, y: 1.6, w: 4.2,
                fontFace: 'Arial', fontSize: 11, color: colors.dark,
                border: { pt: 0.5, color: 'e2e8f0' },
                colW: [2.8, 1.4], rowH: 0.4
            });
            
            // Ã‰quilibre financier
            slide.addText('Ã‰quilibre Financier', { x: 0.5, y: 3.6, w: 9, h: 0.4, fontSize: 14, bold: true, color: colors.dark, fontFace: 'Arial' });
            const frng = (data.capitauxPropres || 0) + (data.dettesLT || 0) - (data.actifImmobilise || 0);
            const bfr = (data.actifCirculant || 0) - (data.dettesCT || 0);
            const tresoNette = frng - bfr;
            
            const equilibreData = [
                ['Fonds de Roulement (FRNG)', fmtM(frng), frng >= 0 ? 'âœ“ Positif' : 'âš  NÃ©gatif'],
                ['Besoin en Fonds de Roulement', fmtM(bfr), ''],
                ['TrÃ©sorerie Nette', fmtM(tresoNette), tresoNette >= 0 ? 'âœ“ ExcÃ©dentaire' : 'âš  DÃ©ficitaire']
            ];
            slide.addTable(equilibreData, {
                x: 0.5, y: 4, w: 9,
                fontFace: 'Arial', fontSize: 11, color: colors.dark,
                border: { pt: 0.5, color: 'e2e8f0' },
                colW: [5, 2, 2], rowH: 0.4
            });
            
            // ============ SLIDE 7: RATIOS ============
            slide = pptx.addSlide();
            slide.addText('05  Ratios Financiers ClÃ©s', { x: 0.5, y: 0.3, w: 9, h: 0.7, fontSize: 28, bold: true, color: colors.dark, fontFace: 'Arial' });
            slide.addShape(pptx.ShapeType.rect, { x: 0.5, y: 0.95, w: 2, h: 0.05, fill: { color: colors.primary } });
            
            const obj = getObjectives();
            const ratiosTable = [
                ['CatÃ©gorie', 'Ratio', 'Valeur', 'Objectif', 'Statut'],
                ['ProfitabilitÃ©', 'Marge Brute', fmtPct(data.margeBrutePct || 0), `â‰¥ ${obj.margeBrute}%`, (data.margeBrutePct || 0) >= obj.margeBrute ? 'âœ“' : 'âœ—'],
                ['ProfitabilitÃ©', 'Marge EBITDA', fmtPct(data.margeEbitda || 0), `â‰¥ ${obj.margeEBITDA}%`, (data.margeEbitda || 0) >= obj.margeEBITDA ? 'âœ“' : 'âœ—'],
                ['ProfitabilitÃ©', 'Marge Nette', fmtPct(data.margeNette || 0), `â‰¥ ${obj.margeNette}%`, (data.margeNette || 0) >= obj.margeNette ? 'âœ“' : 'âœ—'],
                ['RentabilitÃ©', 'ROE', fmtPct(data.roe || 0), `â‰¥ ${obj.roe}%`, (data.roe || 0) >= obj.roe ? 'âœ“' : 'âœ—'],
                ['RentabilitÃ©', 'ROA', fmtPct(data.roi || 0), `â‰¥ ${obj.roa}%`, (data.roi || 0) >= obj.roa ? 'âœ“' : 'âœ—'],
                ['LiquiditÃ©', 'Current Ratio', (data.currentRatio || 0).toFixed(2), `â‰¥ ${obj.currentRatio}`, (data.currentRatio || 0) >= obj.currentRatio ? 'âœ“' : 'âœ—'],
                ['SolvabilitÃ©', 'Endettement', fmtPct(data.ratioEndettement || 0), `â‰¤ ${obj.endettement}%`, (data.ratioEndettement || 0) <= obj.endettement ? 'âœ“' : 'âœ—'],
                ['ActivitÃ©', 'BFR (jours)', `${data.bfrJours || 0}j`, `â‰¤ ${obj.bfr}j`, (data.bfrJours || 0) <= obj.bfr ? 'âœ“' : 'âœ—']
            ];
            
            slide.addTable(ratiosTable, {
                x: 0.3, y: 1.2, w: 9.4,
                fontFace: 'Arial', fontSize: 10,
                color: colors.dark,
                border: { pt: 0.5, color: 'e2e8f0' },
                colW: [1.8, 2.2, 1.6, 1.8, 1], rowH: 0.42,
                valign: 'middle'
            });
            
            // ============ SLIDE 8: RECOMMANDATIONS ============
            if (insights.length > 0) {
                slide = pptx.addSlide();
                slide.addText('06  Recommandations & Points d\'Attention', { x: 0.5, y: 0.3, w: 9, h: 0.7, fontSize: 28, bold: true, color: colors.dark, fontFace: 'Arial' });
                slide.addShape(pptx.ShapeType.rect, { x: 0.5, y: 0.95, w: 2, h: 0.05, fill: { color: colors.primary } });
                
                const typeColors = { positive: colors.success, negative: colors.danger, warning: colors.warning, neutral: colors.purple };
                const typeIcons = { positive: 'âœ“', negative: '!', warning: 'âš ', neutral: 'â„¹' };
                
                insights.slice(0, 4).forEach((insight, i) => {
                    const y = 1.3 + i * 1.1;
                    const iconColor = typeColors[insight.type] || colors.gray;
                    
                    // Icon circle
                    slide.addShape(pptx.ShapeType.ellipse, { x: 0.5, y: y + 0.1, w: 0.5, h: 0.5, fill: { color: iconColor } });
                    slide.addText(typeIcons[insight.type] || 'â€¢', { x: 0.5, y: y + 0.1, w: 0.5, h: 0.5, fontSize: 14, bold: true, align: 'center', valign: 'middle', color: colors.white, fontFace: 'Arial' });
                    
                    // Content
                    slide.addText(insight.title, { x: 1.2, y, w: 8.3, h: 0.4, fontSize: 14, bold: true, color: colors.dark, fontFace: 'Arial' });
                    slide.addText(insight.text, { x: 1.2, y: y + 0.45, w: 8.3, h: 0.5, fontSize: 11, color: colors.gray, fontFace: 'Arial' });
                });
            }
            
            // ============ SLIDE 9: FIN ============
            slide = pptx.addSlide();
            slide.addShape(pptx.ShapeType.rect, { x: 0, y: 0, w: '100%', h: '100%', fill: { color: colors.primary } });
            slide.addText('Merci', { x: 0.5, y: 2, w: 9, h: 1, fontSize: 48, bold: true, color: colors.white, align: 'center', fontFace: 'Arial' });
            slide.addText('Rapport gÃ©nÃ©rÃ© par Findalyx', { x: 0.5, y: 3.2, w: 9, h: 0.5, fontSize: 18, color: 'a5b4fc', align: 'center', fontFace: 'Arial' });
            slide.addText('www.findalyx.com', { x: 0.5, y: 4.5, w: 9, h: 0.4, fontSize: 14, color: 'a5b4fc', align: 'center', fontFace: 'Arial' });
            
            // Save
            pptx.writeFile({ fileName: `Findalyx_Rapport_${companyName.replace(/[^a-zA-Z0-9]/g, '_')}_${currentYear}.pptx` });
            showNotification('PrÃ©sentation PowerPoint exportÃ©e avec succÃ¨s !', 'success');
            toggleExportMenu();
        }

        function exportToExcel() {
            if (!currentYear || !yearsData[currentYear]) {
                showNotification('Veuillez d\'abord importer des donnÃ©es', 'warning');
                return;
            }
            
            const data = yearsData[currentYear];
            const wb = XLSX.utils.book_new();
            
            // KPIs Sheet
            const kpisData = [
                ['Indicateur', 'Valeur', 'UnitÃ©'],
                ['Chiffre d\'Affaires', data.ca, 'FCFA'],
                ['EBITDA', data.ebitda, 'FCFA'],
                ['EBIT', data.ebit, 'FCFA'],
                ['RÃ©sultat Net', data.resultatNet, 'FCFA'],
                ['Marge Brute', data.margeBrute, 'FCFA'],
                ['Marge EBITDA', data.ca > 0 ? ((data.ebitda/data.ca)*100).toFixed(2) : 0, '%']
            ];
            const wsKPIs = XLSX.utils.aoa_to_sheet(kpisData);
            XLSX.utils.book_append_sheet(wb, wsKPIs, 'KPIs');
            
            // Bilan Sheet
            const bilanData = [
                ['ACTIF', '', 'PASSIF', ''],
                ['Actif ImmobilisÃ©', data.actifImmobilise || 0, 'Capitaux Propres', data.capitauxPropres || 0],
                ['Actif Circulant', data.actifCirculant || 0, 'Dettes LT', data.dettesLT || 0],
                ['TrÃ©sorerie Actif', data.tresorerieActif || 0, 'Dettes CT', data.dettesCT || 0],
                ['', '', '', ''],
                ['TOTAL ACTIF', (data.actifImmobilise || 0) + (data.actifCirculant || 0) + (data.tresorerieActif || 0), 'TOTAL PASSIF', (data.capitauxPropres || 0) + (data.dettesLT || 0) + (data.dettesCT || 0)]
            ];
            const wsBilan = XLSX.utils.aoa_to_sheet(bilanData);
            XLSX.utils.book_append_sheet(wb, wsBilan, 'Bilan');
            
            // Score Sheet
            const score = calculateFinancialScore(data);
            if (score) {
                const scoreData = [
                    ['Score de SantÃ© FinanciÃ¨re'],
                    ['Score Global', score.global],
                    ['Grade', score.grade],
                    ['RentabilitÃ©', score.rentabilite],
                    ['LiquiditÃ©', score.liquidite],
                    ['SolvabilitÃ©', score.solvabilite],
                    ['InterprÃ©tation', score.interpretation]
                ];
                const wsScore = XLSX.utils.aoa_to_sheet(scoreData);
                XLSX.utils.book_append_sheet(wb, wsScore, 'Score');
            }
            
            XLSX.writeFile(wb, `Findalyx_Donnees_${currentYear}.xlsx`);
            showNotification('DonnÃ©es Excel exportÃ©es', 'success');
            toggleExportMenu();
        }

        // =====================================================
        // UPDATE DASHBOARD WITH NEW FEATURES
        // =====================================================
        
        // Override or extend updateDashboard to include scoring, insights, forecasts
        const originalUpdateDashboard = typeof updateDashboard === 'function' ? updateDashboard : null;
        
        function updateDashboardEnhanced() {
            // Call original if exists
            if (originalUpdateDashboard) {
                originalUpdateDashboard();
            }
            
            // Update scoring
            if (currentYear && yearsData[currentYear]) {
                const score = calculateFinancialScore(yearsData[currentYear]);
                updateScoringDisplay(score);
                
                // Update AI insights
                const insights = generateAIInsights(yearsData[currentYear]);
                updateAIInsightsDisplay(insights);
                
                // Update forecasts
                const forecasts = calculateForecasts(yearsData);
                updateForecastDisplay(forecasts);
            }
        }

        // =====================================================
        // EXPORT PAGE TO POWERPOINT
        // =====================================================
        
        async function exportPageToPPT(pageType) {
            if (!currentYear || !yearsData[currentYear]) {
                showNotification('Veuillez d\'abord importer des donnÃ©es', 'warning');
                return;
            }
            
            showNotification('GÃ©nÃ©ration du PowerPoint en cours...', 'info');
            
            // Load PptxGenJS dynamically
            if (!window.PptxGenJS) {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js';
                document.head.appendChild(script);
                await new Promise(resolve => script.onload = resolve);
            }
            
            const pptx = new PptxGenJS();
            pptx.author = 'Findalyx';
            pptx.title = `${pageType.toUpperCase()} - ${currentYear}`;
            
            const data = yearsData[currentYear];
            const fmtMrd = n => new Intl.NumberFormat('fr-FR', {maximumFractionDigits: 1}).format((n || 0) / 1000000000);
            const fmtM = n => new Intl.NumberFormat('fr-FR', {maximumFractionDigits: 0}).format((n || 0) / 1000000);
            
            // Slide Title
            let slide = pptx.addSlide();
            slide.addText('FINDALYX', { x: 0.5, y: 2, w: 9, h: 1, fontSize: 44, bold: true, color: '1e40af' });
            
            const titles = {
                pnl: 'Compte de RÃ©sultat',
                bilan: 'Bilan',
                cashflow: 'Flux de TrÃ©sorerie',
                ratios: 'Ratios Financiers'
            };
            slide.addText(`${titles[pageType] || pageType} - Exercice ${currentYear}`, { x: 0.5, y: 3, w: 9, h: 0.5, fontSize: 24, color: '64748b' });
            slide.addText(new Date().toLocaleDateString('fr-FR'), { x: 0.5, y: 5, w: 9, h: 0.3, fontSize: 14, color: '94a3b8' });
            
            // Content slides based on page type
            if (pageType === 'pnl') {
                // P&L Slide
                slide = pptx.addSlide();
                slide.addText('Compte de RÃ©sultat', { x: 0.5, y: 0.3, w: 9, h: 0.6, fontSize: 28, bold: true, color: '1e293b' });
                
                const pnlData = [
                    ['LibellÃ©', 'Montant (M FCFA)'],
                    ['Chiffre d\'Affaires', fmtM(data.ca)],
                    ['Achats consommÃ©s', fmtM(-data.achats)],
                    ['Marge Brute', fmtM(data.margeBrute)],
                    ['Charges externes', fmtM(-data.chargesExternes)],
                    ['Charges de personnel', fmtM(-data.chargesPersonnel)],
                    ['EBITDA', fmtM(data.ebitda)],
                    ['Dotations aux amortissements', fmtM(-data.dotations)],
                    ['EBIT', fmtM(data.ebit)],
                    ['RÃ©sultat financier', fmtM(data.resultatFinancier)],
                    ['ImpÃ´ts', fmtM(-data.impots)],
                    ['RÃ©sultat Net', fmtM(data.resultatNet)]
                ];
                
                slide.addTable(pnlData, {
                    x: 0.5, y: 1.2, w: 9, h: 4,
                    fontFace: 'Arial',
                    fontSize: 11,
                    color: '333333',
                    border: { pt: 0.5, color: 'CCCCCC' },
                    colW: [6, 3],
                    rowH: 0.35,
                    valign: 'middle',
                    align: 'left'
                });
                
            } else if (pageType === 'bilan') {
                // Bilan Slide - Actif
                slide = pptx.addSlide();
                slide.addText('Bilan - Actif', { x: 0.5, y: 0.3, w: 9, h: 0.6, fontSize: 28, bold: true, color: '1e293b' });
                
                const actifData = [
                    ['Poste', 'Montant (M FCFA)'],
                    ['Actif ImmobilisÃ©', fmtM(data.actifImmobilise)],
                    ['  Immobilisations incorporelles', fmtM(data.immoIncorporelles || 0)],
                    ['  Immobilisations corporelles', fmtM(data.immoCorporelles || 0)],
                    ['  Immobilisations financiÃ¨res', fmtM(data.immoFinancieres || 0)],
                    ['Actif Circulant', fmtM(data.actifCirculant)],
                    ['  Stocks', fmtM(data.stocks || 0)],
                    ['  CrÃ©ances clients', fmtM(data.creancesClients || 0)],
                    ['  Autres crÃ©ances', fmtM(data.autresCreances || 0)],
                    ['TrÃ©sorerie Actif', fmtM(data.tresorerieActif)],
                    ['TOTAL ACTIF', fmtM((data.actifImmobilise || 0) + (data.actifCirculant || 0) + (data.tresorerieActif || 0))]
                ];
                
                slide.addTable(actifData, {
                    x: 0.5, y: 1.1, w: 9,
                    fontFace: 'Arial', fontSize: 10,
                    border: { pt: 0.5, color: 'CCCCCC' },
                    colW: [6, 3], rowH: 0.32
                });
                
                // Bilan Slide - Passif
                slide = pptx.addSlide();
                slide.addText('Bilan - Passif', { x: 0.5, y: 0.3, w: 9, h: 0.6, fontSize: 28, bold: true, color: '1e293b' });
                
                const passifData = [
                    ['Poste', 'Montant (M FCFA)'],
                    ['Capitaux Propres', fmtM(data.capitauxPropres)],
                    ['  Capital social', fmtM(data.capitalSocial || 0)],
                    ['  RÃ©serves', fmtM(data.reserves || 0)],
                    ['  RÃ©sultat de l\'exercice', fmtM(data.resultatNet)],
                    ['Dettes Long Terme', fmtM(data.dettesLT)],
                    ['  Emprunts', fmtM(data.emprunts || 0)],
                    ['Dettes Court Terme', fmtM(data.dettesCT)],
                    ['  Fournisseurs', fmtM(data.dettesFournisseurs || 0)],
                    ['  Dettes fiscales', fmtM(data.dettesFiscales || 0)],
                    ['TrÃ©sorerie Passif', fmtM(data.tresoreriePassif || 0)],
                    ['TOTAL PASSIF', fmtM((data.capitauxPropres || 0) + (data.dettesLT || 0) + (data.dettesCT || 0) + (data.tresoreriePassif || 0))]
                ];
                
                slide.addTable(passifData, {
                    x: 0.5, y: 1.1, w: 9,
                    fontFace: 'Arial', fontSize: 10,
                    border: { pt: 0.5, color: 'CCCCCC' },
                    colW: [6, 3], rowH: 0.32
                });
                
            } else if (pageType === 'cashflow') {
                // Cash Flow Slide
                slide = pptx.addSlide();
                slide.addText('Tableau des Flux de TrÃ©sorerie', { x: 0.5, y: 0.3, w: 9, h: 0.6, fontSize: 28, bold: true, color: '1e293b' });
                
                const cfData = [
                    ['Flux', 'Montant (M FCFA)'],
                    ['FLUX D\'EXPLOITATION', ''],
                    ['  RÃ©sultat net', fmtM(data.resultatNet)],
                    ['  Dotations aux amortissements', fmtM(data.dotations)],
                    ['  Variation BFR', fmtM(-(data.variationBFR || 0))],
                    ['  = Flux d\'exploitation', fmtM((data.resultatNet || 0) + (data.dotations || 0) - (data.variationBFR || 0))],
                    ['FLUX D\'INVESTISSEMENT', ''],
                    ['  Acquisitions d\'immobilisations', fmtM(-(data.investissements || 0))],
                    ['  = Flux d\'investissement', fmtM(-(data.investissements || 0))],
                    ['FLUX DE FINANCEMENT', ''],
                    ['  Nouveaux emprunts', fmtM(data.nouveauxEmprunts || 0)],
                    ['  Remboursement emprunts', fmtM(-(data.remboursementEmprunts || 0))],
                    ['  Dividendes versÃ©s', fmtM(-(data.dividendes || 0))],
                    ['  = Flux de financement', fmtM((data.nouveauxEmprunts || 0) - (data.remboursementEmprunts || 0) - (data.dividendes || 0))],
                    ['', ''],
                    ['VARIATION DE TRÃ‰SORERIE', fmtM(data.variationTresorerie || data.tresorerieNette || 0)]
                ];
                
                slide.addTable(cfData, {
                    x: 0.5, y: 1.0, w: 9,
                    fontFace: 'Arial', fontSize: 10,
                    border: { pt: 0.5, color: 'CCCCCC' },
                    colW: [6, 3], rowH: 0.28
                });
                
            } else if (pageType === 'ratios') {
                // Ratios Slide
                slide = pptx.addSlide();
                slide.addText('Ratios Financiers', { x: 0.5, y: 0.3, w: 9, h: 0.6, fontSize: 28, bold: true, color: '1e293b' });
                
                const fmtPct = n => (n || 0).toFixed(1) + '%';
                const fmtRatio = n => (n || 0).toFixed(2);
                
                const ratiosData = [
                    ['CatÃ©gorie', 'Ratio', 'Valeur', 'Objectif'],
                    ['ProfitabilitÃ©', 'Marge Brute', fmtPct(data.margeBrutePct), '> 20%'],
                    ['ProfitabilitÃ©', 'Marge EBITDA', fmtPct(data.margeEbitda), '> 15%'],
                    ['ProfitabilitÃ©', 'Marge Nette', fmtPct(data.margeNette), '> 5%'],
                    ['RentabilitÃ©', 'ROE', fmtPct(data.roe), '> 15%'],
                    ['RentabilitÃ©', 'ROA', fmtPct(data.roi), '> 5%'],
                    ['LiquiditÃ©', 'Ratio de liquiditÃ© gÃ©nÃ©rale', fmtRatio(data.currentRatio), '> 1.5'],
                    ['LiquiditÃ©', 'Ratio de liquiditÃ© rÃ©duite', fmtRatio(data.quickRatio), '> 1.0'],
                    ['SolvabilitÃ©', 'Ratio d\'endettement', fmtPct(data.ratioEndettement), '< 60%'],
                    ['ActivitÃ©', 'BFR en jours de CA', (data.bfrJours || 0) + ' jours', '< 60 jours']
                ];
                
                slide.addTable(ratiosData, {
                    x: 0.3, y: 1.1, w: 9.4,
                    fontFace: 'Arial', fontSize: 10,
                    border: { pt: 0.5, color: 'CCCCCC' },
                    colW: [2, 3, 2, 2.4], rowH: 0.38
                });
            }
            
            // Save
            pptx.writeFile({ fileName: `Findalyx_${titles[pageType] || pageType}_${currentYear}.pptx` });
            showNotification('PrÃ©sentation PowerPoint exportÃ©e', 'success');
        }

        // =====================================================
        // OBJECTIFS FINANCIERS
        // =====================================================
        
        // Objectifs par dÃ©faut
        const defaultObjectives = {
            margeBrute: 20,
            margeEBITDA: 15,
            margeNette: 5,
            roe: 15,
            roa: 5,
            roce: 10,
            currentRatio: 1.5,
            quickRatio: 1.0,
            endettement: 60,
            gearing: 3,
            autonomie: 40,
            bfr: 45,
            delaiClients: 45,
            delaiFourn: 30,
            rotationStocks: 60
        };
        
        // Charger les objectifs depuis localStorage ou utiliser les valeurs par dÃ©faut
        function loadObjectives() {
            const saved = localStorage.getItem('findalyx_objectives');
            const objectives = saved ? JSON.parse(saved) : { ...defaultObjectives };
            
            // Mettre Ã  jour les inputs
            document.getElementById('objMargeBrute').value = objectives.margeBrute;
            document.getElementById('objMargeEBITDA').value = objectives.margeEBITDA;
            document.getElementById('objMargeNette').value = objectives.margeNette;
            document.getElementById('objROE').value = objectives.roe;
            document.getElementById('objROA').value = objectives.roa;
            document.getElementById('objROCE').value = objectives.roce;
            document.getElementById('objCurrentRatio').value = objectives.currentRatio;
            document.getElementById('objQuickRatio').value = objectives.quickRatio;
            document.getElementById('objEndettement').value = objectives.endettement;
            document.getElementById('objGearing').value = objectives.gearing;
            document.getElementById('objAutonomie').value = objectives.autonomie;
            document.getElementById('objBFR').value = objectives.bfr;
            document.getElementById('objDelaiClients').value = objectives.delaiClients;
            document.getElementById('objDelaiFourn').value = objectives.delaiFourn;
            document.getElementById('objRotationStocks').value = objectives.rotationStocks;
            
            return objectives;
        }
        
        // RÃ©cupÃ©rer les objectifs actuels depuis les inputs
        function getObjectives() {
            return {
                margeBrute: parseFloat(document.getElementById('objMargeBrute')?.value) || defaultObjectives.margeBrute,
                margeEBITDA: parseFloat(document.getElementById('objMargeEBITDA')?.value) || defaultObjectives.margeEBITDA,
                margeNette: parseFloat(document.getElementById('objMargeNette')?.value) || defaultObjectives.margeNette,
                roe: parseFloat(document.getElementById('objROE')?.value) || defaultObjectives.roe,
                roa: parseFloat(document.getElementById('objROA')?.value) || defaultObjectives.roa,
                roce: parseFloat(document.getElementById('objROCE')?.value) || defaultObjectives.roce,
                currentRatio: parseFloat(document.getElementById('objCurrentRatio')?.value) || defaultObjectives.currentRatio,
                quickRatio: parseFloat(document.getElementById('objQuickRatio')?.value) || defaultObjectives.quickRatio,
                endettement: parseFloat(document.getElementById('objEndettement')?.value) || defaultObjectives.endettement,
                gearing: parseFloat(document.getElementById('objGearing')?.value) || defaultObjectives.gearing,
                autonomie: parseFloat(document.getElementById('objAutonomie')?.value) || defaultObjectives.autonomie,
                bfr: parseFloat(document.getElementById('objBFR')?.value) || defaultObjectives.bfr,
                delaiClients: parseFloat(document.getElementById('objDelaiClients')?.value) || defaultObjectives.delaiClients,
                delaiFourn: parseFloat(document.getElementById('objDelaiFourn')?.value) || defaultObjectives.delaiFourn,
                rotationStocks: parseFloat(document.getElementById('objRotationStocks')?.value) || defaultObjectives.rotationStocks
            };
        }
        
        // Sauvegarder les objectifs
        function saveObjectives() {
            const objectives = getObjectives();
            localStorage.setItem('findalyx_objectives', JSON.stringify(objectives));
        }
        
        // RÃ©initialiser les objectifs
        function resetObjectives() {
            localStorage.removeItem('findalyx_objectives');
            loadObjectives();
            showNotification('Objectifs rÃ©initialisÃ©s aux valeurs par dÃ©faut', 'info');
        }
        
        // Appliquer les objectifs et rafraÃ®chir l'affichage
        function applyObjectivesAndRefresh() {
            saveObjectives();
            
            // Recalculer si des donnÃ©es sont chargÃ©es
            if (currentYear && yearsData[currentYear]) {
                updateRatiosWithObjectives(yearsData[currentYear]);
                
                // Recalculer le score
                const score = calculateFinancialScore(yearsData[currentYear]);
                updateScoringDisplay(score);
                
                // Mettre Ã  jour les alertes
                checkCriticalRatios(yearsData[currentYear]);
            }
            
            showNotification('Objectifs appliquÃ©s avec succÃ¨s', 'success');
        }
        
        // Mettre Ã  jour les ratios avec les objectifs personnalisÃ©s
        function updateRatiosWithObjectives(data) {
            if (!data) return;
            
            const obj = getObjectives();
            const alerts = [];
            
            // Fonction pour Ã©valuer un ratio
            const evaluate = (value, target, operator = '>=') => {
                if (operator === '>=') return value >= target;
                if (operator === '<=') return value <= target;
                return value >= target;
            };
            
            // ProfitabilitÃ©
            const margeBruteOk = evaluate(data.margeBrutePct || 0, obj.margeBrute);
            const margeEBITDAOk = evaluate(data.margeEbitda || 0, obj.margeEBITDA);
            const margeNetteOk = evaluate(data.margeNette || 0, obj.margeNette);
            
            if (!margeBruteOk) alerts.push(`Marge Brute (${(data.margeBrutePct || 0).toFixed(1)}%) < objectif ${obj.margeBrute}%`);
            if (!margeEBITDAOk) alerts.push(`Marge EBITDA (${(data.margeEbitda || 0).toFixed(1)}%) < objectif ${obj.margeEBITDA}%`);
            if (!margeNetteOk) alerts.push(`Marge Nette (${(data.margeNette || 0).toFixed(1)}%) < objectif ${obj.margeNette}%`);
            
            // RentabilitÃ©
            const roeOk = evaluate(data.roe || 0, obj.roe);
            const roaOk = evaluate(data.roi || 0, obj.roa);
            
            if (!roeOk) alerts.push(`ROE (${(data.roe || 0).toFixed(1)}%) < objectif ${obj.roe}%`);
            if (!roaOk) alerts.push(`ROA (${(data.roi || 0).toFixed(1)}%) < objectif ${obj.roa}%`);
            
            // LiquiditÃ©
            const currentOk = evaluate(data.currentRatio || 0, obj.currentRatio);
            const quickOk = evaluate(data.quickRatio || 0, obj.quickRatio);
            
            if (!currentOk) alerts.push(`LiquiditÃ© gÃ©nÃ©rale (${(data.currentRatio || 0).toFixed(2)}) < objectif ${obj.currentRatio}`);
            if (!quickOk) alerts.push(`LiquiditÃ© rÃ©duite (${(data.quickRatio || 0).toFixed(2)}) < objectif ${obj.quickRatio}`);
            
            // SolvabilitÃ© (inverse: <= pour endettement et gearing)
            const endettementOk = evaluate(data.ratioEndettement || 0, obj.endettement, '<=');
            const gearingOk = evaluate(data.gearing || 0, obj.gearing, '<=');
            const autonomieOk = evaluate(data.autonomieFinanciere || 0, obj.autonomie);
            
            if (!endettementOk) alerts.push(`Endettement (${(data.ratioEndettement || 0).toFixed(1)}%) > objectif ${obj.endettement}%`);
            if (!gearingOk) alerts.push(`Gearing (${(data.gearing || 0).toFixed(2)}x) > objectif ${obj.gearing}x`);
            
            // EfficacitÃ© (inverse pour BFR, dÃ©lais clients, stocks)
            const bfrOk = evaluate(data.bfrJours || 0, obj.bfr, '<=');
            const delaiClientsOk = evaluate(data.delaiClients || 0, obj.delaiClients, '<=');
            const delaiFournOk = evaluate(data.delaiFournisseurs || 0, obj.delaiFourn);
            const rotationOk = evaluate(data.rotationStocks || 0, obj.rotationStocks, '<=');
            
            if (!bfrOk) alerts.push(`BFR (${data.bfrJours || 0}j) > objectif ${obj.bfr}j`);
            if (!delaiClientsOk) alerts.push(`DÃ©lai clients (${data.delaiClients || 0}j) > objectif ${obj.delaiClients}j`);
            
            // Mettre Ã  jour les status visuels sur la page Ratios
            updateRatioStatusVisual('statusMargeBrute', margeBruteOk);
            updateRatioStatusVisual('statusMargeEBITDA', margeEBITDAOk);
            updateRatioStatusVisual('statusMargeNette', margeNetteOk);
            updateRatioStatusVisual('statusROE', roeOk);
            updateRatioStatusVisual('statusROI', roaOk);
            updateRatioStatusVisual('statusCurrent', currentOk);
            updateRatioStatusVisual('statusQuick', quickOk);
            updateRatioStatusVisual('statusEndettement', endettementOk);
            updateRatioStatusVisual('statusGearing', gearingOk);
            updateRatioStatusVisual('statusAutonomie', autonomieOk);
            updateRatioStatusVisual('statusBFR', bfrOk);
            updateRatioStatusVisual('statusDelaiClients', delaiClientsOk);
            updateRatioStatusVisual('statusDelaiFourn', delaiFournOk);
            updateRatioStatusVisual('statusRotationStocks', rotationOk);
            
            // Mettre Ã  jour les textes d'objectifs dans la page Ratios
            updateObjectiveText('MargeBrute', obj.margeBrute, '%', 'â‰¥');
            updateObjectiveText('MargeEBITDA', obj.margeEBITDA, '%', 'â‰¥');
            updateObjectiveText('MargeNette', obj.margeNette, '%', 'â‰¥');
            updateObjectiveText('ROE', obj.roe, '%', 'â‰¥');
            updateObjectiveText('ROA', obj.roa, '%', 'â‰¥');
            updateObjectiveText('CurrentRatio', obj.currentRatio, 'x', 'â‰¥');
            updateObjectiveText('QuickRatio', obj.quickRatio, 'x', 'â‰¥');
            
            return alerts;
        }
        
        function updateRatioStatusVisual(elementId, isGood) {
            const el = document.getElementById(elementId);
            if (el) {
                // Mettre Ã  jour la classe
                el.className = 'ratio-detail-status ' + (isGood ? 'good' : 'warning');
                
                // Mettre Ã  jour l'icÃ´ne
                el.innerHTML = isGood 
                    ? '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>'
                    : '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>';
                
                // Mettre Ã  jour la card parente
                const card = el.closest('.ratio-detail-card');
                if (card) {
                    card.classList.remove('status-good', 'status-warning');
                    card.classList.add(isGood ? 'status-good' : 'status-warning');
                }
            }
        }
        
        function updateObjectiveText(ratioName, value, unit, operator) {
            // Chercher les Ã©lÃ©ments qui affichent l'objectif
            const benchmarks = document.querySelectorAll('.ratio-detail-benchmark');
            benchmarks.forEach(el => {
                if (el.textContent.toLowerCase().includes(ratioName.toLowerCase())) {
                    el.innerHTML = `
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                        Objectif: ${operator}${value}${unit}
                    `;
                }
            });
        }
        
        // VÃ©rifier les ratios critiques et afficher une alerte
        function checkCriticalRatios(data) {
            const alerts = updateRatiosWithObjectives(data);
            
            // Supprimer l'ancien banner s'il existe
            const oldBanner = document.getElementById('criticalAlertBanner');
            if (oldBanner) oldBanner.remove();
            
            // CrÃ©er ou mettre Ã  jour le badge et popup
            let badge = document.getElementById('alertBadge');
            let popup = document.getElementById('alertPopup');
            
            if (alerts.length > 0) {
                // CrÃ©er le badge si nÃ©cessaire
                if (!badge) {
                    badge = document.createElement('div');
                    badge.id = 'alertBadge';
                    badge.className = 'alert-badge';
                    badge.innerHTML = `
                        <button class="alert-badge-button" onclick="toggleAlertPopup()">
                            <span class="alert-badge-dot"></span>
                            <span class="alert-badge-count">${alerts.length} alerte${alerts.length > 1 ? 's' : ''}</span>
                        </button>
                    `;
                    document.body.appendChild(badge);
                } else {
                    badge.querySelector('.alert-badge-count').textContent = `${alerts.length} alerte${alerts.length > 1 ? 's' : ''}`;
                    badge.classList.remove('hidden');
                }
                
                // CrÃ©er le popup si nÃ©cessaire
                if (!popup) {
                    popup = document.createElement('div');
                    popup.id = 'alertPopup';
                    popup.className = 'alert-popup';
                    document.body.appendChild(popup);
                }
                
                // GÃ©nÃ©rer le contenu du popup
                const alertItems = alerts.map((alert, idx) => {
                    const parts = alert.match(/(.+?) \((.+?)\) (<|>) objectif (.+)/);
                    if (parts) {
                        return `
                            <div class="alert-item">
                                <div class="alert-item-icon red">âš ï¸</div>
                                <div class="alert-item-content">
                                    <div class="alert-item-title">${parts[1]}</div>
                                    <div class="alert-item-detail">Objectif: ${parts[3] === '<' ? 'â‰¥' : 'â‰¤'} ${parts[4]}</div>
                                </div>
                                <div class="alert-item-value">${parts[2]}</div>
                            </div>
                        `;
                    }
                    return `
                        <div class="alert-item">
                            <div class="alert-item-icon red">âš ï¸</div>
                            <div class="alert-item-content">
                                <div class="alert-item-title">${alert}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                popup.innerHTML = `
                    <div class="alert-popup-header">
                        <h4>
                            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            ${alerts.length} ratio${alerts.length > 1 ? 's' : ''} sous objectif
                        </h4>
                        <button class="alert-popup-close" onclick="toggleAlertPopup()">
                            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <div class="alert-popup-body">
                        ${alertItems}
                    </div>
                    <div class="alert-popup-footer">
                        <button onclick="navigateTo('settings'); toggleAlertPopup();">
                            ðŸŽ¯ Modifier les objectifs
                        </button>
                    </div>
                `;
            } else {
                // Cacher le badge si pas d'alertes
                if (badge) badge.classList.add('hidden');
                if (popup) popup.classList.remove('open');
            }
        }
        
        // Toggle le popup d'alertes
        function toggleAlertPopup() {
            const popup = document.getElementById('alertPopup');
            if (popup) {
                popup.classList.toggle('open');
            }
        }
        
        // Fermer le popup si on clique ailleurs
        document.addEventListener('click', function(e) {
            const popup = document.getElementById('alertPopup');
            const badge = document.getElementById('alertBadge');
            if (popup && popup.classList.contains('open')) {
                if (!popup.contains(e.target) && !badge.contains(e.target)) {
                    popup.classList.remove('open');
                }
            }
        });

        // =====================================================
        // SUPABASE AUTHENTICATION & PLANS
        // =====================================================
        
        // Initialize Supabase client
        let supabaseClient;
        try {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (e) {
            console.error('Supabase init error:', e);
        }
        
        // Current user state
        let currentUser = null;
        let userProfile = null;
        let userPlan = 'basic';
        let isYearlyBilling = false;
        
        // Admin emails - only these can see admin link
        const ADMIN_EMAILS = ['s.sawadogo@findalyx.com', 'sawadgsalif@gmail.com'];
        
        // Check if current user is admin
        function checkAdminAccess() {
            const adminLink = document.getElementById('adminNavLink');
            if (adminLink && currentUser && ADMIN_EMAILS.includes(currentUser.email)) {
                adminLink.style.display = 'flex';
            } else if (adminLink) {
                adminLink.style.display = 'none';
            }
        }
        
        // Initialize app
        async function initApp() {
            showLoading(true);
            
            // Timeout de sÃ©curitÃ© - masquer le loading aprÃ¨s 10 secondes max
            const loadingTimeout = setTimeout(() => {
                console.warn('Loading timeout - forcing hide');
                showLoading(false);
                showAuth();
            }, 10000);
            
            try {
                if (!supabaseClient) {
                    throw new Error('Supabase not initialized');
                }
                
                // Check for existing session
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                clearTimeout(loadingTimeout);
                
                if (error) {
                    console.error('Session error:', error);
                    showAuth();
                } else if (session) {
                    currentUser = session.user;
                    await loadUserProfile();
                    checkAdminAccess();
                    showApp();
                } else {
                    showAuth();
                }
            } catch (error) {
                console.error('Init error:', error);
                clearTimeout(loadingTimeout);
                showAuth();
            }
            
            showLoading(false);
        }
        
        // Auth state change listener
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            console.log('Auth state changed:', event);
            
            if (event === 'SIGNED_IN' && session) {
                currentUser = session.user;
                await loadUserProfile();
                checkAdminAccess();
                showApp();
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                userProfile = null;
                showAuth();
            }
        });
        
        // Load user profile and settings
        async function loadUserProfile() {
            if (!currentUser) return;
            
            try {
                // Get profile with timeout
                const profilePromise = supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Profile load timeout')), 8000)
                );
                
                const { data: profile, error } = await Promise.race([profilePromise, timeoutPromise]);
                
                if (error) throw error;
                
                userProfile = profile;
                userPlan = getActivePlan(profile);
                
                // Update UI with user info
                updateUserUI();
                
                // Load user settings
                await loadUserSettings();
                
                // Load saved companies and data
                await loadUserData();
                
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }
        
        // Determine active plan
        function getActivePlan(profile) {
            if (!profile) return 'none';
            
            const now = new Date();
            
            // Check if subscription is active
            if (profile.plan !== 'basic' && profile.subscription_ends_at) {
                const subEnd = new Date(profile.subscription_ends_at);
                if (subEnd > now) {
                    return profile.plan;
                }
                return 'expired';
            }
            
            // Check trial for basic plan
            if (profile.plan === 'basic' && profile.trial_ends_at) {
                const trialEnd = new Date(profile.trial_ends_at);
                if (trialEnd > now) {
                    return 'basic_trial';
                }
                return 'basic_expired';
            }
            
            return profile.plan || 'basic';
        }
        
        // Load user settings (objectives, mapping)
        async function loadUserSettings() {
            if (!currentUser) return;
            
            try {
                const { data, error } = await supabaseClient
                    .from('user_settings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (data) {
                    // Apply objectives
                    if (data.objectives) {
                        localStorage.setItem('findalyx_objectives', JSON.stringify(data.objectives));
                        loadObjectives();
                    }
                    
                    // Apply mapping
                    if (data.account_mapping && Object.keys(data.account_mapping).length > 0) {
                        accountMapping = data.account_mapping;
                    }
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        // Load user's saved financial data
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                // Get companies
                const { data: companies } = await supabaseClient
                    .from('companies')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (companies && companies.length > 0) {
                    // Get financial data for all companies
                    const { data: financialData } = await supabaseClient
                        .from('financial_data')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('year', { ascending: false });
                    
                    if (financialData && financialData.length > 0) {
                        // Restore yearsData
                        yearsData = {};
                        financialData.forEach(fd => {
                            yearsData[fd.year] = fd.data;
                        });
                        
                        // Set current year to most recent
                        const years = Object.keys(yearsData).sort((a, b) => b - a);
                        if (years.length > 0) {
                            currentYear = years[0];
                            loadFinancialData(yearsData[currentYear]);
                        }
                    }
                    
                    // Update company name
                    if (companies[0].name) {
                        document.getElementById('companyName').value = companies[0].name;
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        
        // Save financial data to Supabase
        async function saveFinancialData(year, data) {
            if (!currentUser) return;
            
            try {
                // Check plan limits
                const planConfig = PLANS[userPlan.replace('_trial', '').replace('_expired', '')] || PLANS.basic;
                const yearsCount = Object.keys(yearsData).length;
                
                if (planConfig.features.maxYears !== -1 && yearsCount >= planConfig.features.maxYears) {
                    if (!yearsData[year]) {
                        showNotification('Limite du plan atteinte. Passez Ã  Pro pour plus d\'annÃ©es.', 'warning');
                        openUpgradeModal();
                        return false;
                    }
                }
                
                // Get or create company
                let { data: companies } = await supabaseClient
                    .from('companies')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .limit(1);
                
                let companyId;
                
                if (!companies || companies.length === 0) {
                    // Check company limit
                    if (planConfig.features.maxCompanies !== -1) {
                        const { count } = await supabaseClient
                            .from('companies')
                            .select('*', { count: 'exact' })
                            .eq('user_id', currentUser.id);
                        
                        if (count >= planConfig.features.maxCompanies) {
                            showNotification('Limite d\'entreprises atteinte. Passez Ã  Pro.', 'warning');
                            openUpgradeModal();
                            return false;
                        }
                    }
                    
                    // Create company
                    const companyName = document.getElementById('companyName')?.value || 'Mon Entreprise';
                    const { data: newCompany, error } = await supabaseClient
                        .from('companies')
                        .insert({
                            user_id: currentUser.id,
                            name: companyName
                        })
                        .select()
                        .single();
                    
                    if (error) throw error;
                    companyId = newCompany.id;
                } else {
                    companyId = companies[0].id;
                }
                
                // Upsert financial data
                const { error } = await supabaseClient
                    .from('financial_data')
                    .upsert({
                        company_id: companyId,
                        user_id: currentUser.id,
                        year: parseInt(year),
                        data: data
                    }, {
                        onConflict: 'company_id,year'
                    });
                
                if (error) throw error;
                
                console.log('Data saved to cloud');
                return true;
                
            } catch (error) {
                console.error('Error saving data:', error);
                showNotification('Erreur lors de la sauvegarde', 'error');
                return false;
            }
        }
        
        // Save settings to Supabase
        async function saveUserSettings() {
            if (!currentUser) return;
            
            try {
                const objectives = getObjectives();
                
                await supabaseClient
                    .from('user_settings')
                    .upsert({
                        user_id: currentUser.id,
                        objectives: objectives,
                        account_mapping: accountMapping
                    }, {
                        onConflict: 'user_id'
                    });
                    
            } catch (error) {
                console.error('Error saving settings:', error);
            }
        }
        
        // Update UI with user info
        function updateUserUI() {
            if (!userProfile) return;
            
            // Update name displays
            const name = userProfile.full_name || userProfile.email.split('@')[0];
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            
            document.querySelectorAll('.user-name').forEach(el => el.textContent = name);
            document.querySelectorAll('.user-avatar, .user-avatar-text').forEach(el => el.textContent = initials);
            document.querySelectorAll('.user-email-display').forEach(el => el.textContent = userProfile.email);
            
            // Update plan badge in sidebar
            updatePlanBadge();
            
            // Show trial banner if applicable
            updateTrialBanner();
            
            // Update company name
            if (userProfile.company_name) {
                const companyInput = document.getElementById('companyName');
                if (companyInput) companyInput.value = userProfile.company_name;
            }
        }
        
        // Update plan badge
        function updatePlanBadge() {
            const badgeContainers = document.querySelectorAll('.user-plan-badge');
            if (badgeContainers.length === 0) return;
            
            const plan = userPlan.replace('_trial', '').replace('_expired', '');
            const planName = PLANS[plan]?.name || 'Basic';
            
            let badgeClass = 'basic';
            let badgeText = planName;
            
            if (userPlan.includes('expired')) {
                badgeClass = 'expired';
                badgeText = 'ExpirÃ©';
            } else if (userPlan.includes('trial')) {
                badgeClass = 'basic';
                badgeText = 'Essai';
            } else if (plan === 'pro') {
                badgeClass = 'pro';
            } else if (plan === 'business') {
                badgeClass = 'business';
            }
            
            badgeContainers.forEach(badge => {
                badge.className = `plan-badge user-plan-badge ${badgeClass}`;
                badge.textContent = badgeText;
            });
        }
        
        // Update trial banner
        function updateTrialBanner() {
            const banner = document.getElementById('trialBanner');
            if (!banner) return;
            
            if (userPlan === 'basic_trial' && userProfile.trial_ends_at) {
                const trialEnd = new Date(userProfile.trial_ends_at);
                const now = new Date();
                const daysLeft = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));
                
                document.getElementById('trialDaysLeft').textContent = Math.max(0, daysLeft);
                banner.classList.remove('hidden');
            } else if (userPlan.includes('expired')) {
                document.getElementById('trialDaysLeft').textContent = '0';
                banner.querySelector('.trial-banner-text span:last-child').innerHTML = 
                    '<strong>Votre essai a expirÃ©.</strong> Passez Ã  Pro pour continuer.';
                banner.classList.remove('hidden');
            } else {
                banner.classList.add('hidden');
            }
        }
        
        // Check if feature is allowed
        function canUseFeature(feature) {
            const plan = userPlan.replace('_trial', '').replace('_expired', '');
            const planConfig = PLANS[plan] || PLANS.basic;
            
            // Trial expired = no features
            if (userPlan === 'basic_expired') {
                return false;
            }
            
            return planConfig.features[feature] === true || planConfig.features[feature] === -1;
        }
        
        // Show/hide elements based on plan
        function applyPlanRestrictions() {
            // Export buttons
            const exportPDFBtns = document.querySelectorAll('[onclick*="exportToPDF"]');
            const exportExcelBtns = document.querySelectorAll('[onclick*="exportToExcel"]');
            const exportPPTBtns = document.querySelectorAll('[onclick*="exportToPPT"], [onclick*="exportDashboardPPT"], [onclick*="exportPageToPPT"]');
            
            exportPDFBtns.forEach(btn => {
                if (!canUseFeature('exportPDF')) {
                    btn.classList.add('feature-locked');
                    btn.setAttribute('data-locked', 'Pro');
                } else {
                    btn.classList.remove('feature-locked');
                }
            });
            
            exportExcelBtns.forEach(btn => {
                if (!canUseFeature('exportExcel')) {
                    btn.classList.add('feature-locked');
                    btn.setAttribute('data-locked', 'Pro');
                } else {
                    btn.classList.remove('feature-locked');
                }
            });
            
            exportPPTBtns.forEach(btn => {
                if (!canUseFeature('exportPPT')) {
                    btn.classList.add('feature-locked');
                    btn.setAttribute('data-locked', 'Business');
                } else {
                    btn.classList.remove('feature-locked');
                }
            });
        }
        
        // Switch auth tab
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.auth-tab:${tab === 'login' ? 'first-child' : 'last-child'}`).classList.add('active');
            
            document.getElementById('loginForm').style.display = tab === 'login' ? 'flex' : 'none';
            document.getElementById('signupForm').style.display = tab === 'signup' ? 'flex' : 'none';
            document.getElementById('authError').classList.remove('show');
        }
        
        // Handle login
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            
            btn.disabled = true;
            btn.textContent = 'Connexion...';
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) throw error;
                
                showNotification('Connexion rÃ©ussie !', 'success');
                
            } catch (error) {
                console.error('Login error:', error);
                showAuthError(error.message || 'Email ou mot de passe incorrect');
            }
            
            btn.disabled = false;
            btn.textContent = 'Se connecter';
        }
        
        // Handle signup
        async function handleSignup(e) {
            e.preventDefault();
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const company = document.getElementById('signupCompany').value;
            const btn = document.getElementById('signupBtn');
            
            btn.disabled = true;
            btn.textContent = 'CrÃ©ation...';
            
            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            full_name: name,
                            company_name: company
                        }
                    }
                });
                
                if (error) throw error;
                
                // Update profile with company name
                if (data.user) {
                    await supabaseClient
                        .from('profiles')
                        .update({ 
                            full_name: name,
                            company_name: company 
                        })
                        .eq('id', data.user.id);
                }
                
                showNotification('Compte crÃ©Ã© ! VÃ©rifiez votre email.', 'success');
                switchAuthTab('login');
                
            } catch (error) {
                console.error('Signup error:', error);
                showAuthError(error.message || 'Erreur lors de l\'inscription');
            }
            
            btn.disabled = false;
            btn.textContent = 'CrÃ©er mon compte';
        }
        
        // Handle forgot password
        async function handleForgotPassword() {
            const email = document.getElementById('loginEmail').value;
            
            if (!email) {
                showAuthError('Entrez votre email pour rÃ©initialiser le mot de passe');
                return;
            }
            
            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin
                });
                
                if (error) throw error;
                
                showNotification('Email de rÃ©initialisation envoyÃ© !', 'success');
                
            } catch (error) {
                showAuthError(error.message);
            }
        }
        
        // Handle logout
        async function handleLogout() {
            try {
                await supabaseClient.auth.signOut();
                showNotification('DÃ©connexion rÃ©ussie', 'info');
                window.location.reload();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
        
        // Show auth error
        function showAuthError(message) {
            const errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }
        
        // Show/hide views
        function showAuth() {
            const authContainer = document.getElementById('authContainer');
            const appContainer = document.getElementById('appContainer');
            if (authContainer) authContainer.style.display = 'flex';
            if (appContainer) appContainer.style.display = 'none';
        }
        
        function showApp() {
            const authContainer = document.getElementById('authContainer');
            const appContainer = document.getElementById('appContainer');
            if (authContainer) authContainer.style.display = 'none';
            if (appContainer) appContainer.style.display = 'flex';
            applyPlanRestrictions();
        }
        
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.toggle('hidden', !show);
            }
        }
        
        // =====================================================
        // UPGRADE MODAL
        // =====================================================
        
        function openUpgradeModal() {
            renderUpgradePlans();
            document.getElementById('upgradeModal').classList.add('open');
        }
        
        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('open');
        }
        
        function toggleBilling() {
            isYearlyBilling = !isYearlyBilling;
            document.getElementById('billingToggle').classList.toggle('active', isYearlyBilling);
            document.getElementById('monthlyLabel').classList.toggle('active', !isYearlyBilling);
            document.getElementById('yearlyLabel').classList.toggle('active', isYearlyBilling);
            renderUpgradePlans();
        }
        
        function renderUpgradePlans() {
            const container = document.getElementById('upgradePlans');
            const period = isYearlyBilling ? 'yearly' : 'monthly';
            const currentPlanKey = userPlan.replace('_trial', '').replace('_expired', '');
            
            const plansHTML = Object.entries(PLANS).map(([key, plan]) => {
                const price = plan.price[period];
                const isPopular = key === 'pro';
                const isCurrent = key === currentPlanKey && !userPlan.includes('expired');
                const isDowngrade = ['pro', 'business'].indexOf(key) < ['pro', 'business'].indexOf(currentPlanKey);
                
                const features = [
                    { text: key === 'basic' ? '1 entreprise' : key === 'pro' ? '10 entreprises' : 'Entreprises illimitÃ©es', enabled: true },
                    { text: key === 'basic' ? '1 annÃ©e' : key === 'pro' ? '5 annÃ©es' : 'AnnÃ©es illimitÃ©es', enabled: true },
                    { text: 'Export PDF', enabled: plan.features.exportPDF },
                    { text: 'Export Excel', enabled: plan.features.exportExcel },
                    { text: 'Export PowerPoint', enabled: plan.features.exportPPT },
                    { text: 'Support prioritaire', enabled: plan.features.support === 'priority' }
                ];
                
                return `
                    <div class="plan-card ${isPopular ? 'popular' : ''} ${isCurrent ? 'current' : ''}">
                        ${isPopular ? '<div class="popular-tag">Plus populaire</div>' : ''}
                        <div class="plan-name">${plan.name}</div>
                        <div class="plan-price">
                            ${price === 0 ? `
                                <span class="amount">Gratuit</span>
                                <span class="period">7 jours d'essai</span>
                            ` : `
                                <span class="amount">${new Intl.NumberFormat('fr-FR').format(price)}</span>
                                <span class="currency">FCFA</span>
                                <span class="period">/${isYearlyBilling ? 'an' : 'mois'}</span>
                            `}
                        </div>
                        <ul class="plan-features">
                            ${features.map(f => `
                                <li class="${f.enabled ? '' : 'disabled'}">
                                    <svg class="${f.enabled ? 'check' : 'cross'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        ${f.enabled 
                                            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>'
                                            : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>'
                                        }
                                    </svg>
                                    ${f.text}
                                </li>
                            `).join('')}
                        </ul>
                        <button class="plan-cta ${key !== 'basic' ? 'primary' : 'secondary'}" 
                            ${isCurrent ? 'disabled' : ''}
                            onclick="${key === 'basic' ? 'closeUpgradeModal()' : `initPayment('${key}', '${period}')`}">
                            ${isCurrent ? 'Plan actuel' : key === 'basic' ? 'Continuer en Basic' : 'Choisir ce plan'}
                        </button>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = plansHTML;
        }
        
        // =====================================================
        // PAYMENT (Manual for now - can integrate PayDunya later)
        // =====================================================
        
        async function initPayment(plan, period) {
            const price = PLANS[plan].price[period];
            
            // For now, show manual payment instructions
            // Later, integrate PayDunya here
            
            const paymentInfo = `
                <div style="padding:20px;text-align:center;">
                    <h3 style="margin-bottom:16px;">Paiement pour ${PLANS[plan].name}</h3>
                    <p style="font-size:24px;font-weight:bold;color:var(--blue-600);margin-bottom:24px;">
                        ${new Intl.NumberFormat('fr-FR').format(price)} FCFA/${period === 'yearly' ? 'an' : 'mois'}
                    </p>
                    <p style="margin-bottom:16px;color:var(--slate-600);">
                        Pour activer votre abonnement, effectuez un paiement vers :
                    </p>
                    <div style="background:var(--slate-100);padding:16px;border-radius:12px;margin-bottom:16px;">
                        <p><strong>Wave :</strong> +221 XX XXX XX XX</p>
                        <p><strong>Orange Money :</strong> +221 XX XXX XX XX</p>
                        <p style="margin-top:8px;font-size:13px;color:var(--slate-500);">
                            RÃ©fÃ©rence : ${currentUser?.email || 'votre email'}
                        </p>
                    </div>
                    <p style="font-size:13px;color:var(--slate-500);">
                        Envoyez une capture du paiement Ã  <a href="mailto:contact@findalyx.com" style="color:var(--blue-600);">contact@findalyx.com</a>
                        <br>Votre abonnement sera activÃ© sous 24h.
                    </p>
                </div>
            `;
            
            // Record pending payment
            try {
                await supabaseClient.from('payments').insert({
                    user_id: currentUser.id,
                    amount: price,
                    plan: plan,
                    period: period,
                    status: 'pending'
                });
            } catch (e) {
                console.error('Error recording payment:', e);
            }
            
            // Show payment modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = 'display:flex;align-items:center;justify-content:center;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:100001;';
            modal.innerHTML = `
                <div style="background:white;border-radius:20px;max-width:450px;width:90%;position:relative;">
                    <button onclick="this.parentElement.parentElement.remove()" 
                        style="position:absolute;top:16px;right:16px;background:var(--slate-100);border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;">âœ•</button>
                    ${paymentInfo}
                </div>
            `;
            document.body.appendChild(modal);
            
            showNotification('Instructions de paiement affichÃ©es', 'info');
        }
        
        // =====================================================
        // OVERRIDE EXISTING FUNCTIONS FOR CLOUD SYNC
        // =====================================================
        
        // Override saveObjectives to sync with cloud
        const originalSaveObjectives = saveObjectives;
        saveObjectives = function() {
            originalSaveObjectives();
            saveUserSettings();
        };
        
        // Hook into file upload to save to cloud
        const originalHandleFileUpload = handleFileUpload;
        handleFileUpload = async function(event) {
            // Check plan limits before upload
            if (!currentUser) {
                showNotification('Veuillez vous connecter', 'warning');
                return;
            }
            
            const plan = userPlan.replace('_trial', '').replace('_expired', '');
            const planConfig = PLANS[plan] || PLANS.basic;
            const currentYearsCount = Object.keys(yearsData).length;
            
            // For basic/trial, limit to 1 year
            if (planConfig.features.maxYears !== -1 && currentYearsCount >= planConfig.features.maxYears) {
                showNotification(`Limite de ${planConfig.features.maxYears} annÃ©e(s) atteinte. Passez Ã  Pro !`, 'warning');
                openUpgradeModal();
                return;
            }
            
            // Call original handler
            await originalHandleFileUpload(event);
            
            // Save to cloud after processing
            setTimeout(async () => {
                if (currentYear && yearsData[currentYear]) {
                    await saveFinancialData(currentYear, yearsData[currentYear]);
                }
            }, 1000);
        };
        
        // Override export functions to check permissions
        const originalExportToPDF = typeof exportToPDF !== 'undefined' ? exportToPDF : null;
        exportToPDF = function(type) {
            if (!canUseFeature('exportPDF')) {
                showNotification('Export PDF disponible avec le plan Pro', 'warning');
                openUpgradeModal();
                return;
            }
            if (originalExportToPDF) originalExportToPDF(type);
        };
        
        const originalExportToExcel = typeof exportToExcel !== 'undefined' ? exportToExcel : null;
        exportToExcel = function(type) {
            if (!canUseFeature('exportExcel')) {
                showNotification('Export Excel disponible avec le plan Pro', 'warning');
                openUpgradeModal();
                return;
            }
            if (originalExportToExcel) originalExportToExcel(type);
        };
        
        const originalExportDashboardPPT = typeof exportDashboardPPT !== 'undefined' ? exportDashboardPPT : null;
        exportDashboardPPT = async function() {
            if (!canUseFeature('exportPPT')) {
                showNotification('Export PowerPoint disponible avec le plan Business', 'warning');
                openUpgradeModal();
                return;
            }
            if (originalExportDashboardPPT) await originalExportDashboardPPT();
        };
        
        const originalExportPageToPPT = typeof exportPageToPPT !== 'undefined' ? exportPageToPPT : null;
        exportPageToPPT = async function(pageType) {
            if (!canUseFeature('exportPPT')) {
                showNotification('Export PowerPoint disponible avec le plan Business', 'warning');
                openUpgradeModal();
                return;
            }
            if (originalExportPageToPPT) await originalExportPageToPPT(pageType);
        };

        // Initialize app on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadMapping();
            loadObjectives();
            initApp();
        });
    </script>
</body>
</html>
